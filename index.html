<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>不知道叫什么名字小手机</title>
    
    <!-- PWA 配置 -->
    <meta name="theme-color" content="#ffffff">
    <meta name="description" content="不知其名PWA">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/jpeg" href="https://i.postimg.cc/ZKRRp1Yg/IMG-20260124-144817.jpg">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/ZKRRp1Yg/IMG-20260124-144817.jpg">
    
    <!-- Apple 特定meta标签 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="小手机">
    
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="couple-avatar.css">
    <link rel="stylesheet" href="video-call.css">
    <!-- Chart.js 图表库 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- docx解析库 -->
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
    <!-- ZIP解析库 -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <!-- docx生成库 -->
    <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.js"></script>
</head>
<body>
    <!-- 消息通知弹窗容器 -->
    <div class="msg-notif-container" id="msgNotifContainer"></div>

    <!-- 锁屏界面 -->
    <div class="lock-screen" id="lockScreen">
        <div class="lock-screen-content">
            <!-- 时间显示 -->
            <div class="lock-time-container">
                <div class="lock-time" id="lockTime">09:41</div>
                <div class="lock-date" id="lockDate">1月23日 星期五</div>
            </div>

            <!-- 横向滑动解锁 -->
            <div class="slide-to-unlock-container" id="horizontalSlide">
                <div class="slide-track">
                    <div class="slide-text" id="slideText">滑动来解锁</div>
                    <div class="slide-button" id="slideButton">
                        <span class="slide-arrow">›</span>
                    </div>
                </div>
            </div>

            <!-- 向上滑动解锁 -->
            <div class="swipe-up-container" id="verticalSlide" style="display: none;">
                <div class="swipe-up-hint">
                    <div class="swipe-up-icon">↑</div>
                    <div class="swipe-up-text">向上滑动解锁</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 文案编辑弹窗 -->
    <div class="settings-page" id="contentModal" style="z-index: 2000;">
        <div class="settings-content" style="max-width: 400px;">
            <div class="settings-header">
                <div class="back-btn" onclick="closeContentModal()">←</div>
                <div class="settings-title">文案编辑</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <div class="section-title">
                    <span class="section-title-text">编辑内容</span>
                </div>
                
                <!-- 文案预览 -->
                <div style="margin-bottom: 20px;">
                    <div style="padding: 20px; background-color: #f8f8f8; border-radius: 16px; border: 2px solid #e0e0e0; min-height: 80px;">
                        <div style="font-size: 14px; color: #333; line-height: 1.6;" id="contentPreview">被你牽著的手是不可能的畫面</div>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #666; text-align: center;">预览效果</div>
                </div>

                <!-- 文案输入 -->
                <div class="form-group">
                    <label class="form-label">输入文案内容</label>
                    <textarea class="form-input" id="contentInput" placeholder="请输入文案内容" rows="4" style="resize: vertical; min-height: 100px;" oninput="updateContentPreview()"></textarea>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        支持多行文本，最多500字符
                    </div>
                </div>

                <!-- 语言转换 -->
                <div class="section-title" style="margin-top: 40px; margin-bottom: 20px;">
                    <span class="section-title-text">一键转换语言</span>
                </div>

                <div class="form-group">
                    <label class="form-label">选择目标语言</label>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <button class="btn-primary" onclick="translateContent('zh-TW')" style="background: #f0f0f0; color: #333;">繁体中文</button>
                        <button class="btn-primary" onclick="translateContent('en')" style="background: #f0f0f0; color: #333;">English</button>
                        <button class="btn-primary" onclick="translateContent('ja')" style="background: #f0f0f0; color: #333;">日本語</button>
                        <button class="btn-primary" onclick="translateContent('de')" style="background: #f0f0f0; color: #333;">Deutsch</button>
                        <button class="btn-primary" onclick="translateContent('fr')" style="background: #f0f0f0; color: #333;">Français</button>
                        <button class="btn-primary" onclick="translateContent('ko')" style="background: #f0f0f0; color: #333;">한국어</button>
                        <button class="btn-primary" onclick="translateContent('es')" style="background: #f0f0f0; color: #333;">Español</button>
                        <button class="btn-primary" onclick="translateContent('ru')" style="background: #f0f0f0; color: #333;">Русский</button>
                    </div>
                    <div style="margin-top: 12px; font-size: 12px; color: #999; text-align: center;">
                        点击按钮自动翻译当前文案
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button class="btn-primary" onclick="resetContent()" style="flex: 1; background: #dc3545; color: white; border: none;">
                        重置文案
                    </button>
                    <button class="btn-primary btn-save" onclick="saveContent()" style="flex: 1;">
                        保存文案
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 格式调节面板 -->
    <div class="settings-page" id="formatFixPanel" style="z-index: 10003;">
        <div class="settings-content" style="max-width: 500px;">
            <div class="settings-header">
                <div class="back-btn" onclick="closeFormatFixPanel()">←</div>
                <div class="settings-title">调节格式</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <div class="section-title">
                    <span class="section-title-text">选择需要调节的消息</span>
                </div>
                
                <div style="margin-bottom: 20px; padding: 12px; background-color: #f8f9fa; border-radius: 10px; border: 1px solid #e9ecef;">
                    <div style="font-size: 12px; color: #666; line-height: 1.6;">
                        <div style="font-weight: 600; margin-bottom: 6px;">功能说明：</div>
                        <div>• 选择角色的某一轮回复进行格式调节</div>
                        <div>• 智能调节：调用AI自动修正为规范格式</div>
                        <div>• 手动编辑：直接修改消息内容</div>
                    </div>
                </div>

                <!-- 消息列表 -->
                <div id="formatFixMessageList" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                    <!-- 动态生成消息列表 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 隐藏消息管理面板 -->
    <div class="settings-page" id="hiddenMessagePanel" style="z-index: 10003;">
        <div class="settings-content" style="max-width: 500px;">
            <div class="settings-header">
                <div class="back-btn" onclick="closeHiddenMessagePanel()">←</div>
                <div class="settings-title">隐藏消息管理</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <!-- 功能说明 -->
                <div style="margin-bottom: 20px; padding: 12px; background-color: #f8f9fa; border-radius: 10px; border: 1px solid #e9ecef;">
                    <div style="font-size: 12px; color: #666; line-height: 1.6;">
                        <div style="font-weight: 600; margin-bottom: 6px;">功能说明：</div>
                        <div>• 隐藏指定范围的消息，AI将看不到这些消息</div>
                        <div>• 可以节省Token，降低API调用成本</div>
                        <div>• 消息在聊天界面仍正常显示，只是不发给AI</div>
                    </div>
                </div>

                <!-- 消息总数显示 -->
                <div style="margin-bottom: 20px; padding: 16px; background: #f8f8f8; border-radius: 12px; border: 2px solid #e0e0e0; text-align: center;">
                    <div style="font-size: 13px; color: #999; margin-bottom: 6px;">当前对话总消息数</div>
                    <div style="font-size: 36px; font-weight: 600; color: #333;" id="hiddenMessageTotalCount">0</div>
                </div>

                <!-- 添加隐藏范围 -->
                <div class="section-title">
                    <span class="section-title-text">添加隐藏范围</span>
                </div>

                <div class="form-group">
                    <label class="form-label">起始序号</label>
                    <input type="number" id="hiddenRangeStart" class="form-input" placeholder="例如：1" min="1" step="1">
                </div>

                <div class="form-group">
                    <label class="form-label">结束序号</label>
                    <input type="number" id="hiddenRangeEnd" class="form-input" placeholder="例如：50" min="1" step="1">
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn-primary" onclick="previewHiddenRange()" style="flex: 1; background: #007bff;">
                        预览范围
                    </button>
                    <button class="btn-primary btn-save" onclick="confirmHideRange()" style="flex: 1;">
                        确认隐藏
                    </button>
                </div>

                <!-- 预览区域 -->
                <div id="hiddenRangePreviewSection" style="display: none; margin-bottom: 30px;">
                    <div class="section-title">
                        <span class="section-title-text">预览消息</span>
                    </div>
                    <div id="hiddenRangePreview" style="max-height: 300px; overflow-y: auto; background: #f8f8f8; border-radius: 12px; padding: 12px;">
                        <!-- 动态生成预览内容 -->
                    </div>
                </div>

                <!-- 已隐藏范围列表 -->
                <div class="section-title" style="margin-top: 30px;">
                    <span class="section-title-text">已隐藏范围</span>
                </div>

                <div id="hiddenRangeList" style="max-height: 400px; overflow-y: auto;">
                    <!-- 动态生成隐藏范围列表 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 格式编辑弹窗 -->
    <div class="settings-page" id="formatEditModal" style="z-index: 10004;">
        <div class="settings-content" style="max-width: 500px;">
            <div class="settings-header">
                <div class="back-btn" onclick="closeFormatEditModal()">←</div>
                <div class="settings-title">编辑消息格式</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <!-- 原始内容显示 -->
                <div class="section-title">
                    <span class="section-title-text">原始内容</span>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div style="padding: 15px; background-color: #f8f8f8; border-radius: 12px; border: 2px solid #e0e0e0; min-height: 60px;">
                        <div style="font-size: 13px; color: #666; line-height: 1.6; white-space: pre-wrap; word-break: break-word;" id="formatEditOriginal"></div>
                    </div>
                </div>

                <!-- 编辑区域 -->
                <div class="section-title">
                    <span class="section-title-text">编辑内容</span>
                </div>
                
                <div class="form-group">
                    <label class="form-label">JSON数组格式</label>
                    <textarea class="form-input" id="formatEditInput" placeholder='["消息1", "消息2", "消息3"]' rows="8" style="resize: vertical; min-height: 150px; font-family: monospace; font-size: 13px;"></textarea>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        必须是有效的JSON数组格式，如：["你好", "在干嘛呢"]
                    </div>
                </div>

                <!-- 格式说明 -->
                <div style="margin-top: 15px; padding: 12px; background-color: #fff3cd; border-radius: 10px; border: 1px solid #ffc107;">
                    <div style="font-size: 12px; color: #856404; line-height: 1.6;">
                        <div style="font-weight: 600; margin-bottom: 6px;">✓ 正确格式：</div>
                        <div style="font-family: monospace; background: white; padding: 8px; border-radius: 6px; margin-bottom: 8px;">["你好啊", "在干嘛呢"]</div>
                        <div style="font-weight: 600; margin-bottom: 6px;">✗ 错误格式：</div>
                        <div style="font-family: monospace; background: white; padding: 8px; border-radius: 6px;">你好啊（缺少JSON格式）</div>
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button class="btn-primary" onclick="smartFixFormat()" style="flex: 1; background: #007bff;">
                        智能调节
                    </button>
                    <button class="btn-primary btn-save" onclick="saveFormatEdit()" style="flex: 1;">
                        保存修改
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- API历史查看面板 -->
    <div class="settings-page" id="apiHistoryPanel" style="z-index: 10003;">
        <div class="settings-content" style="max-width: 600px;">
            <div class="settings-header">
                <div class="back-btn" onclick="closeApiHistoryPanel()">←</div>
                <div class="settings-title">API调用历史</div>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <div class="settings-action" onclick="exportApiHistory()" style="font-size: 14px; color: #007aff; cursor: pointer;">导出</div>
                    <div class="settings-action" onclick="clearApiHistory()" style="font-size: 14px; color: #ff3b30; cursor: pointer;">清空</div>
                </div>
            </div>

            <div class="settings-card">
                <!-- 功能说明 -->
                <div style="margin-bottom: 20px; padding: 12px; background-color: #f8f9fa; border-radius: 10px; border: 1px solid #e9ecef;">
                    <div style="font-size: 12px; color: #666; line-height: 1.6;">
                        <div style="font-weight: 600; margin-bottom: 6px;">功能说明：</div>
                        <div>• 查看所有API请求和响应数据</div>
                        <div>• 支持单个导出和批量导出</div>
                        <div>• 支持多选删除历史记录</div>
                        <div style="margin-top: 6px; color: #999;">需在API设置中开启"记录API调用历史"</div>
                    </div>
                </div>

                <!-- 统计信息 -->
                <div style="margin-bottom: 20px; display: flex; gap: 12px;">
                    <div style="flex: 1; padding: 16px; background: #f8f8f8; border-radius: 12px; border: 2px solid #e0e0e0; text-align: center;">
                        <div style="font-size: 13px; color: #999; margin-bottom: 6px;">总记录数</div>
                        <div style="font-size: 28px; font-weight: 600; color: #333;" id="apiHistoryTotalCount">0</div>
                    </div>
                    <div style="flex: 1; padding: 16px; background: #f8f8f8; border-radius: 12px; border: 2px solid #e0e0e0; text-align: center;">
                        <div style="font-size: 13px; color: #999; margin-bottom: 6px;">已选择</div>
                        <div style="font-size: 28px; font-weight: 600; color: #007bff;" id="apiHistorySelectedCount">0</div>
                    </div>
                </div>

                <!-- 批量操作按钮 -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn-primary" onclick="toggleSelectAllApiHistory()" style="flex: 1; background: #6c757d;">
                        全选/取消
                    </button>
                    <button class="btn-primary" onclick="batchDeleteApiHistory()" style="flex: 1; background: #dc3545;">
                        批量删除
                    </button>
                    <button class="btn-primary" onclick="batchExportApiHistory()" style="flex: 1; background: #007bff;">
                        批量导出
                    </button>
                </div>

                <!-- 历史记录列表 -->
                <div class="section-title">
                    <span class="section-title-text">历史记录</span>
                </div>

                <div id="apiHistoryList" style="max-height: 500px; overflow-y: auto;">
                    <!-- 动态生成历史记录列表 -->
                </div>
            </div>
        </div>
    </div>

    <!-- API历史详情弹窗 -->
    <div class="settings-page" id="apiHistoryDetailModal" style="z-index: 10004;">
        <div class="settings-content" style="max-width: 600px;">
            <div class="settings-header">
                <div class="back-btn" onclick="closeApiHistoryDetail()">←</div>
                <div class="settings-title">调用详情</div>
                <div class="settings-action" onclick="exportSingleApiHistory()" style="font-size: 14px; color: #007aff; cursor: pointer;">导出</div>
            </div>

            <div class="settings-card">
                <!-- 基本信息 -->
                <div style="margin-bottom: 20px; padding: 16px; background: #f8f8f8; border-radius: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-size: 13px; color: #999;">调用时间</span>
                        <span style="font-size: 13px; color: #333; font-weight: 500;" id="historyDetailTime">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-size: 13px; color: #999;">角色名称</span>
                        <span style="font-size: 13px; color: #333; font-weight: 500;" id="historyDetailCharacter">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 13px; color: #999;">状态</span>
                        <span style="font-size: 13px; font-weight: 500;" id="historyDetailStatus">-</span>
                    </div>
                </div>

                <!-- 请求数据 -->
                <div class="section-title">
                    <span class="section-title-text">请求数据</span>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div style="padding: 15px; background-color: #f8f8f8; border-radius: 12px; border: 2px solid #e0e0e0; max-height: 300px; overflow-y: auto;">
                        <pre style="font-size: 12px; color: #333; line-height: 1.6; white-space: pre-wrap; word-break: break-word; margin: 0; font-family: monospace;" id="historyDetailRequest"></pre>
                    </div>
                    <button class="btn-primary" onclick="copyHistoryRequest()" style="margin-top: 10px; width: 100%; background: #6c757d;">
                        复制请求数据
                    </button>
                </div>

                <!-- 响应数据 -->
                <div class="section-title">
                    <span class="section-title-text">响应数据</span>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div style="padding: 15px; background-color: #f8f8f8; border-radius: 12px; border: 2px solid #e0e0e0; max-height: 300px; overflow-y: auto;">
                        <pre style="font-size: 12px; color: #333; line-height: 1.6; white-space: pre-wrap; word-break: break-word; margin: 0; font-family: monospace;" id="historyDetailResponse"></pre>
                    </div>
                    <button class="btn-primary" onclick="copyHistoryResponse()" style="margin-top: 10px; width: 100%; background: #6c757d;">
                        复制响应数据
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ID修改弹窗 -->
    <div class="settings-page" id="idModal" style="z-index: 2000;">
        <div class="settings-content" style="max-width: 400px;">
            <div class="settings-header">
                <div class="back-btn" onclick="closeIdModal()">←</div>
                <div class="settings-title">修改ID</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <div class="section-title">
                    <span class="section-title-text">个性化ID</span>
                </div>
                
                <!-- ID预览 -->
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="padding: 30px 20px; background-color: #f8f8f8; border-radius: 16px; border: 2px solid #e0e0e0;">
                        <div style="font-size: 20px; font-weight: 400; color: #999;" id="idPreview">@1234</div>
                        <div style="font-size: 12px; color: #999; margin-top: 8px;">预览效果</div>
                    </div>
                </div>

                <!-- ID输入 -->
                <div class="form-group">
                    <label class="form-label">输入新ID</label>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 20px; color: #999;">@</span>
                        <input type="text" class="form-input" id="idInput" placeholder="请输入ID" maxlength="30" oninput="updateIdPreview()" style="flex: 1;">
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        最多30个字符，只支持字母、数字、下划线
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button class="btn-primary" onclick="resetId()" style="flex: 1; background: #dc3545; color: white; border: none;">
                        重置为默认
                    </button>
                    <button class="btn-primary btn-save" onclick="saveId()" style="flex: 1;">
                        保存ID
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 名称修改弹窗 -->
    <div class="settings-page" id="nameModal" style="z-index: 2000;">
        <div class="settings-content" style="max-width: 400px;">
            <div class="settings-header">
                <div class="back-btn" onclick="closeNameModal()">←</div>
                <div class="settings-title">修改名称</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <div class="section-title">
                    <span class="section-title-text">个性化名称</span>
                </div>
                
                <!-- 名称预览 -->
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="padding: 30px 20px; background-color: #f8f8f8; border-radius: 16px; border: 2px solid #e0e0e0;">
                        <div style="font-size: 24px; font-weight: 600; color: #333;" id="namePreview">习惯</div>
                        <div style="font-size: 12px; color: #999; margin-top: 8px;">预览效果</div>
                    </div>
                </div>

                <!-- 名称输入 -->
                <div class="form-group">
                    <label class="form-label">输入新名称</label>
                    <input type="text" class="form-input" id="nameInput" placeholder="请输入名称" maxlength="20" oninput="updateNamePreview()">
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        最多20个字符
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button class="btn-primary" onclick="resetName()" style="flex: 1; background: #dc3545; color: white; border: none;">
                        重置为默认
                    </button>
                    <button class="btn-primary btn-save" onclick="saveName()" style="flex: 1;">
                        保存名称
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 相恋日期编辑弹窗 -->
    <div class="settings-page" id="loveDateModal" style="z-index: 2000;">
        <div class="settings-content" style="max-width: 400px;">
            <div class="settings-header">
                <div class="back-btn" onclick="closeLoveDateModal()">←</div>
                <div class="settings-title">相恋日期编辑</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <div class="section-title">
                    <span class="section-title-text">编辑内容</span>
                </div>
                
                <!-- 相恋日期预览 -->
                <div style="margin-bottom: 20px;">
                    <div style="padding: 20px; background-color: #f8f8f8; border-radius: 16px; border: 2px solid #e0e0e0; min-height: 60px; display: flex; align-items: center; justify-content: center;">
                        <div style="font-size: 16px; color: #333; font-weight: 500;" id="loveDatePreview">相恋日期：520</div>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #666; text-align: center;">预览效果</div>
                </div>

                <!-- 编辑模式切换 -->
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px;">
                        <button id="manualModeBtn" class="btn-primary" onclick="switchLoveDateMode('manual')" style="flex: 1; background: #007bff;">
                            手动输入
                        </button>
                        <button id="dateModeBtn" class="btn-primary" onclick="switchLoveDateMode('date')" style="flex: 1; background: #6c757d;">
                            日期计算
                        </button>
                    </div>
                </div>

                <!-- 手动输入模式 -->
                <div id="manualInputSection" style="display: block;">
                    <div class="form-group">
                        <label class="form-label">输入内容</label>
                        <input type="text" class="form-input" id="loveDateInput" placeholder="例如：相恋日期：520" maxlength="50" oninput="updateLoveDatePreview()">
                        <div style="margin-top: 8px; font-size: 12px; color: #666;">
                            最多50个字符，可以自定义任何格式
                        </div>
                    </div>
                </div>

                <!-- 日期计算模式 -->
                <div id="dateCalculateSection" style="display: none;">
                    <!-- 前缀文字 -->
                    <div class="form-group">
                        <label class="form-label">前缀文字</label>
                        <input type="text" class="form-input" id="loveDatePrefix" placeholder="例如：暗恋已经、结婚已经、告白还有" maxlength="20" oninput="calculateAndUpdateDays()">
                        <div style="margin-top: 8px; font-size: 12px; color: #666;">
                            自定义前缀，如"暗恋已经"、"告白还有"等
                        </div>
                    </div>

                    <!-- 日期选择 -->
                    <div class="form-group">
                        <label class="form-label">选择日期</label>
                        <div class="custom-date-picker">
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <select class="custom-select" id="yearSelect" onchange="updateDayOptions(); calculateAndUpdateDays();">
                                    <!-- 动态生成年份选项 -->
                                </select>
                                <span style="color: #666;">年</span>
                                
                                <select class="custom-select" id="monthSelect" onchange="updateDayOptions(); calculateAndUpdateDays();">
                                    <!-- 动态生成月份选项 -->
                                </select>
                                <span style="color: #666;">月</span>
                                
                                <select class="custom-select" id="daySelect" onchange="calculateAndUpdateDays();">
                                    <!-- 动态生成日期选项 -->
                                </select>
                                <span style="color: #666;">日</span>
                            </div>
                        </div>
                        <div style="margin-top: 8px; font-size: 12px; color: #666;">
                            选择过去日期显示"已经"，未来日期显示"还有"
                        </div>
                    </div>

                    <!-- 天数显示 -->
                    <div style="margin-top: 15px; padding: 15px; background-color: #f0f8ff; border-radius: 12px; border: 1px solid #d0e8ff;">
                        <div style="display: flex; align-items: baseline; justify-content: center; gap: 5px;">
                            <span style="font-size: 14px; color: #666;" id="daysLabel">天数：</span>
                            <span style="font-size: 28px; font-weight: 600; color: #007bff;" id="daysCount">0</span>
                            <span style="font-size: 14px; color: #666;">天</span>
                        </div>
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button class="btn-primary" onclick="resetLoveDate()" style="flex: 1; background: #dc3545; color: white; border: none;">
                        重置为默认
                    </button>
                    <button class="btn-primary btn-save" onclick="saveLoveDate()" style="flex: 1;">
                        保存内容
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* 主屏幕方案样式 */
        .layout-scheme-list {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 4px 0 12px;
            -webkit-overflow-scrolling: touch;
        }
        .layout-scheme-list::-webkit-scrollbar { display: none; }

        .layout-scheme-card {
            min-width: 100px;
            max-width: 100px;
            flex-shrink: 0;
            border-radius: 14px;
            border: 2.5px solid #e0e0e0;
            background: #f8f8f8;
            padding: 10px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.25s;
            position: relative;
        }
        .layout-scheme-card:active { transform: scale(0.96); }
        .layout-scheme-card.active {
            border-color: #333;
            background: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .layout-scheme-card.empty {
            border-style: dashed;
            border-color: #ccc;
            justify-content: center;
            min-height: 120px;
        }

        .scheme-preview {
            width: 100%;
            aspect-ratio: 9/16;
            background: #eee;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 3px;
            padding: 4px;
        }
        .scheme-preview-bar {
            height: 8px;
            background: #d5d5d5;
            border-radius: 3px;
        }
        .scheme-preview-block {
            flex: 1;
            background: #ddd;
            border-radius: 4px;
        }

        .scheme-name {
            font-size: 11px;
            color: #333;
            font-weight: 500;
            text-align: center;
            word-break: break-all;
        }
        .scheme-badge {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #333;
            color: #fff;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .scheme-empty-icon {
            font-size: 28px;
            color: #bbb;
            font-weight: 200;
        }
        .scheme-empty-text {
            font-size: 11px;
            color: #aaa;
        }

        #widgetArea {
            display: contents; /* 不影响flex布局 */
        }

        /* 外观设置标签页样式 */
        .appearance-tabs {
            display: flex;
            background: #f5f5f5;
            border-radius: 10px;
            padding: 4px;
            margin: 0 20px 20px 20px;
            gap: 4px;
            position: sticky;
            top: 84px;
            z-index: 99;
        }

        .appearance-tab {
            flex: 1;
            padding: 10px 16px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        .appearance-tab:active {
            transform: scale(0.97);
        }

        .appearance-tab.active {
            background: white;
            color: #333;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .appearance-tab-content {
            display: none;
        }

        .appearance-tab-content.active {
            display: block;
        }

        /* 聊天设置标签页样式 */
        .chat-settings-tabs {
            display: flex;
            background: #f5f5f5;
            border-radius: 10px;
            padding: 4px;
            margin: 0 20px 20px 20px;
            gap: 4px;
            position: sticky;
            top: 84px;
            z-index: 99;
        }

        .chat-settings-tab {
            flex: 1;
            padding: 10px 16px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        .chat-settings-tab:active {
            transform: scale(0.97);
        }

        .chat-settings-tab.active {
            background: white;
            color: #333;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .chat-settings-tab-content {
            display: none;
        }

        .chat-settings-tab-content.active {
            display: block;
        }

        /* 自定义日期选择器样式 */
        .custom-date-picker {
            margin-top: 8px;
        }
        
        .custom-select {
            flex: 1;
            padding: 10px 12px;
            font-size: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background-color: white;
            color: #333;
            outline: none;
            transition: all 0.3s ease;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 30px;
        }
        
        .custom-select:hover {
            border-color: #007bff;
        }
        
        .custom-select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        .custom-select option {
            padding: 8px;
        }
        
        /* iOS风格开关 */
        .ios-switch {
            position: relative;
            display: inline-block;
            width: 51px;
            height: 31px;
            flex-shrink: 0;
        }
        
        .ios-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .ios-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e0e0e0;
            transition: 0.4s;
            border-radius: 31px;
        }
        
        .ios-slider:before {
            position: absolute;
            content: "";
            height: 27px;
            width: 27px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .ios-switch input:checked + .ios-slider {
            background-color: #34c759;
        }
        
        .ios-switch input:checked + .ios-slider:before {
            transform: translateX(20px);
        }
        
        .ios-switch input:focus + .ios-slider {
            box-shadow: 0 0 1px #34c759;
        }
        
        /* 颜色选择器样式 */
        .color-option {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        .color-option:active {
            transform: scale(0.95);
        }
        
        .color-option .color-check {
            color: white;
            font-size: 18px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s ease;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        .color-option.selected {
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.5), 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .color-option.selected .color-check {
            opacity: 1;
        }
        
        .custom-color-picker {
            width: 50px;
            height: 50px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .custom-color-picker:hover {
            border-color: #007bff;
        }
        
        .custom-color-picker:active {
            transform: scale(0.95);
        }
        
        /* 锁屏模糊效果 */
        .lock-screen.blurred .lock-screen-content {
            filter: blur(20px);
            opacity: 0.3;
        }
        
        /* 密码输入界面（在锁屏上方弹出） */
        .password-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 10001;
            display: none;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .password-screen.active {
            display: flex;
        }
        
        .password-screen-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 340px;
            width: 90%;
            animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .password-header {
            font-size: 20px;
            color: #333;
            font-weight: 600;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .password-dots {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            justify-content: center;
        }
        
        .password-dot {
            width: 14px;
            height: 14px;
            border: 2px solid #d1d1d6;
            border-radius: 50%;
            background: transparent;
            transition: all 0.2s ease;
        }
        
        .password-dot.filled {
            background: #000;
            border-color: #000;
            transform: scale(1.1);
        }
        
        .password-error {
            color: #ff3b30;
            font-size: 13px;
            min-height: 20px;
            margin-bottom: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
            text-align: center;
            font-weight: 500;
        }
        
        .password-error.show {
            opacity: 1;
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .password-keypad {
            width: 100%;
        }
        
        .keypad-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .keypad-key {
            flex: 1;
            height: 55px;
            background: #fff;
            border: 1px solid #e5e5ea;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #000;
            cursor: pointer;
            user-select: none;
            transition: all 0.15s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            font-weight: 500;
        }
        
        .keypad-key:active {
            background: #f2f2f7;
            transform: scale(0.96);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .keypad-empty {
            background: transparent;
            border: none;
            box-shadow: none;
            cursor: default;
        }
        
        .keypad-empty:active {
            transform: none;
            background: transparent;
        }
        
        .keypad-delete {
            font-size: 22px;
            color: #666;
        }

        /* 手势密码设置界面 */
        .gesture-setup-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f5f5f5;
            z-index: 10002;
            display: none;
            flex-direction: column;
            align-items: center;
        }

        .gesture-setup-screen.active {
            display: flex;
        }

        .gesture-setup-content {
            width: 100%;
            max-width: 500px;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: white;
        }

        .gesture-setup-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #e5e5ea;
        }

        .gesture-setup-title {
            font-size: 17px;
            font-weight: 600;
            color: #000;
        }

        .gesture-hint {
            margin-top: 30px;
            font-size: 15px;
            color: #666;
            text-align: center;
        }

        .gesture-canvas {
            margin-top: 40px;
            width: 100%;
            max-width: 300px;
            aspect-ratio: 1;
            background: white;
            touch-action: none;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        /* 手势密码按钮样式 */
        .password-type-btn:hover {
            opacity: 0.8;
        }

        .password-type-btn.active {
            background: #007aff !important;
            color: white !important;
        }
    </style>

    <!-- 第三个白条文案编辑弹窗 -->
    <div class="settings-page" id="notebookTextModal" style="z-index: 2000;">
        <div class="settings-content" style="max-width: 400px;">
            <div class="settings-header">
                <div class="back-btn" onclick="closeNotebookTextModal()">←</div>
                <div class="settings-title">文案编辑</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <div class="section-title">
                    <span class="section-title-text">编辑内容</span>
                </div>
                
                <!-- 文案预览 -->
                <div style="margin-bottom: 20px;">
                    <div style="padding: 20px; background-color: #f8f8f8; border-radius: 16px; border: 2px solid #e0e0e0; min-height: 80px; display: flex; align-items: center; justify-content: center;">
                        <div style="font-size: 14px; color: #333; line-height: 1.6; text-align: center;" id="notebookTextPreview">跨越时空的思念</div>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #666; text-align: center;">预览效果</div>
                </div>

                <!-- 文案输入 -->
                <div class="form-group">
                    <label class="form-label">输入文案内容</label>
                    <textarea class="form-input" id="notebookTextInput" placeholder="请输入文案内容" rows="4" style="resize: vertical; min-height: 100px;" oninput="updateNotebookTextPreview()"></textarea>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        支持多行文本，最多100字符
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button class="btn-primary" onclick="resetNotebookText()" style="flex: 1; background: #dc3545; color: white; border: none;">
                        重置为默认
                    </button>
                    <button class="btn-primary btn-save" onclick="saveNotebookText()" style="flex: 1;">
                        保存文案
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 本子小组件图片编辑弹窗 -->
    <div class="settings-page" id="notebookImageModal" style="z-index: 2000;">
        <div class="settings-content" style="max-width: 400px;">
            <div class="settings-header">
                <div class="back-btn" onclick="closeNotebookImageModal()">←</div>
                <div class="settings-title">更换图片</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <div class="section-title">
                    <span class="section-title-text">选择上传方式</span>
                </div>
                
                <!-- 图片预览 -->
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="width: 200px; height: 200px; margin: 0 auto; border-radius: 16px; overflow: hidden; background-color: #f5f5f5; display: flex; align-items: center; justify-content: center; border: 2px solid #e0e0e0;">
                        <span id="notebookImagePreviewPlaceholder" style="font-size: 14px; color: #999;">图片预览</span>
                        <img id="notebookImagePreview" style="display: none; width: 100%; height: 100%; object-fit: cover;">
                    </div>
                </div>

                <!-- 本地上传 -->
                <div class="form-group">
                    <label class="form-label">本地上传</label>
                    <input type="file" id="notebookImageFileInput" accept="image/*,image/gif" style="display: none;" onchange="handleNotebookImageFileUpload(event)">
                    <button class="btn-primary" onclick="document.getElementById('notebookImageFileInput').click()">
                        选择本地图片
                    </button>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        支持 JPG、PNG、GIF 等格式
                    </div>
                </div>

                <!-- URL上传 -->
                <div class="form-group">
                    <label class="form-label">URL上传</label>
                    <input type="text" class="form-input" id="notebookImageUrlInput" placeholder="输入图片URL地址">
                    <button class="btn-primary" onclick="handleNotebookImageUrlUpload()" style="margin-top: 10px;">
                        加载URL图片
                    </button>
                </div>

                <!-- 操作按钮 -->
                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button class="btn-primary" onclick="resetNotebookImage()" style="flex: 1; background: #dc3545; color: white; border: none;">
                        重置为默认
                    </button>
                    <button class="btn-primary btn-save" onclick="saveNotebookImage()" style="flex: 1;">
                        保存图片
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 音乐头像更换弹窗 -->
    <div class="settings-page" id="musicAvatarModal" style="z-index: 2000;">
        <div class="settings-content" style="max-width: 400px;">
            <div class="settings-header">
                <div class="back-btn" onclick="closeMusicAvatarModal()">←</div>
                <div class="settings-title">更换音乐头像</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <div class="section-title">
                    <span class="section-title-text">选择上传方式</span>
                </div>
                
                <!-- 头像预览 -->
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="width: 120px; height: 120px; margin: 0 auto; border-radius: 50%; overflow: hidden; background-color: #f5f5f5; display: flex; align-items: center; justify-content: center; border: 2px solid #e0e0e0;">
                        <span id="musicAvatarPreviewPlaceholder" style="font-size: 14px; color: #999;">头像预览</span>
                        <img id="musicAvatarPreview" style="display: none; width: 100%; height: 100%; object-fit: cover;">
                    </div>
                </div>

                <!-- 本地上传 -->
                <div class="form-group">
                    <label class="form-label">本地上传</label>
                    <input type="file" id="musicAvatarFileInput" accept="image/*,image/gif" style="display: none;" onchange="handleMusicAvatarFileUpload(event)">
                    <button class="btn-primary" onclick="document.getElementById('musicAvatarFileInput').click()">
                        选择本地图片
                    </button>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        支持 JPG、PNG、GIF 等格式
                    </div>
                </div>

                <!-- URL上传 -->
                <div class="form-group">
                    <label class="form-label">URL上传</label>
                    <input type="text" class="form-input" id="musicAvatarUrlInput" placeholder="输入图片URL地址">
                    <button class="btn-primary" onclick="handleMusicAvatarUrlUpload()" style="margin-top: 10px;">
                        加载URL图片
                    </button>
                </div>

                <!-- 操作按钮 -->
                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button class="btn-primary" onclick="resetMusicAvatar()" style="flex: 1; background: #dc3545; color: white; border: none;">
                        重置为默认
                    </button>
                    <button class="btn-primary btn-save" onclick="saveMusicAvatar()" style="flex: 1;">
                        保存头像
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 音乐用户名修改弹窗 -->
    <div class="settings-page" id="musicUsernameModal" style="z-index: 2000;">
        <div class="settings-content" style="max-width: 400px;">
            <div class="settings-header">
                <div class="back-btn" onclick="closeMusicUsernameModal()">←</div>
                <div class="settings-title">修改用户名</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <div class="section-title">
                    <span class="section-title-text">编辑内容</span>
                </div>
                
                <!-- 用户名预览 -->
                <div style="margin-bottom: 20px;">
                    <div style="padding: 20px; background-color: #f8f8f8; border-radius: 16px; border: 2px solid #e0e0e0; min-height: 80px; display: flex; align-items: center; justify-content: center;">
                        <div style="font-size: 16px; color: #333; line-height: 1.6;" id="musicUsernamePreview">@{{user}}</div>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #666; text-align: center;">预览效果</div>
                </div>

                <!-- 用户名输入 -->
                <div class="form-group">
                    <label class="form-label">输入用户名</label>
                    <input type="text" class="form-input" id="musicUsernameInput" placeholder="请输入用户名" maxlength="50" oninput="updateMusicUsernamePreview()">
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        最多50个字符
                    </div>
                </div>

                <!-- 语言转换 -->
                <div class="section-title" style="margin-top: 40px; margin-bottom: 20px;">
                    <span class="section-title-text">一键转换语言</span>
                </div>

                <div class="form-group">
                    <label class="form-label">选择目标语言</label>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <button class="btn-primary" onclick="translateMusicUsername('zh-TW')" style="background: #f0f0f0; color: #333;">繁体中文</button>
                        <button class="btn-primary" onclick="translateMusicUsername('en')" style="background: #f0f0f0; color: #333;">English</button>
                        <button class="btn-primary" onclick="translateMusicUsername('ja')" style="background: #f0f0f0; color: #333;">日本語</button>
                        <button class="btn-primary" onclick="translateMusicUsername('de')" style="background: #f0f0f0; color: #333;">Deutsch</button>
                        <button class="btn-primary" onclick="translateMusicUsername('fr')" style="background: #f0f0f0; color: #333;">Français</button>
                        <button class="btn-primary" onclick="translateMusicUsername('ko')" style="background: #f0f0f0; color: #333;">한국어</button>
                        <button class="btn-primary" onclick="translateMusicUsername('es')" style="background: #f0f0f0; color: #333;">Español</button>
                        <button class="btn-primary" onclick="translateMusicUsername('ru')" style="background: #f0f0f0; color: #333;">Русский</button>
                    </div>
                    <div style="margin-top: 12px; font-size: 12px; color: #999; text-align: center;">
                        点击按钮自动翻译当前用户名
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button class="btn-primary" onclick="resetMusicUsername()" style="flex: 1; background: #dc3545; color: white; border: none;">
                        重置为默认
                    </button>
                    <button class="btn-primary btn-save" onclick="saveMusicUsername()" style="flex: 1;">
                        保存用户名
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 音乐生日编辑弹窗 -->
    <div class="settings-page" id="musicBirthdayModal" style="z-index: 2000;">
        <div class="settings-content" style="max-width: 400px;">
            <div class="settings-header">
                <div class="back-btn" onclick="closeMusicBirthdayModal()">←</div>
                <div class="settings-title">编辑生日</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <div class="section-title">
                    <span class="section-title-text">生日设置</span>
                </div>
                
                <!-- 生日预览 -->
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="padding: 30px 20px; background-color: #f8f8f8; border-radius: 16px; border: 2px solid #e0e0e0;">
                        <div style="font-size: 18px; color: #333; font-weight: 500;" id="musicBirthdayPreview">birthday 2000/08/01</div>
                        <div style="font-size: 12px; color: #999; margin-top: 8px;">预览效果</div>
                    </div>
                </div>

                <!-- 日期选择 -->
                <div class="form-group">
                    <label class="form-label">选择生日日期</label>
                    <div class="custom-date-picker">
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <select class="custom-select" id="birthdayYearSelect" onchange="updateBirthdayDayOptions(); updateMusicBirthdayPreview();">
                                <!-- 动态生成年份选项 -->
                            </select>
                            <span style="color: #666;">年</span>
                            
                            <select class="custom-select" id="birthdayMonthSelect" onchange="updateBirthdayDayOptions(); updateMusicBirthdayPreview();">
                                <!-- 动态生成月份选项 -->
                            </select>
                            <span style="color: #666;">月</span>
                            
                            <select class="custom-select" id="birthdayDaySelect" onchange="updateMusicBirthdayPreview();">
                                <!-- 动态生成日期选项 -->
                            </select>
                            <span style="color: #666;">日</span>
                        </div>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        选择您的生日日期
                    </div>
                </div>

                <!-- 前缀文字 -->
                <div class="form-group">
                    <label class="form-label">前缀文字（可选）</label>
                    <input type="text" class="form-input" id="birthdayPrefixInput" placeholder="例如：birthday、生日、お誕生日" maxlength="20" oninput="updateMusicBirthdayPreview()">
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        自定义前缀文字，留空则只显示日期
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button class="btn-primary" onclick="resetMusicBirthday()" style="flex: 1; background: #dc3545; color: white; border: none;">
                        重置为默认
                    </button>
                    <button class="btn-primary btn-save" onclick="saveMusicBirthday()" style="flex: 1;">
                        保存生日
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 音乐封面更换弹窗 -->
    <div class="settings-page" id="musicCoverModal" style="z-index: 2000;">
        <div class="settings-content" style="max-width: 400px;">
            <div class="settings-header">
                <div class="back-btn" onclick="closeMusicCoverModal()">←</div>
                <div class="settings-title">更换封面</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <div class="section-title">
                    <span class="section-title-text">选择上传方式</span>
                </div>
                
                <!-- 封面预览 -->
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="width: 200px; height: 200px; margin: 0 auto; border-radius: 16px; overflow: hidden; background-color: #f5f5f5; display: flex; align-items: center; justify-content: center; border: 2px solid #e0e0e0;">
                        <span id="musicCoverPreviewPlaceholder" style="font-size: 14px; color: #999;">封面预览</span>
                        <img id="musicCoverPreview" style="display: none; width: 100%; height: 100%; object-fit: cover;">
                    </div>
                </div>

                <!-- 本地上传 -->
                <div class="form-group">
                    <label class="form-label">本地上传</label>
                    <input type="file" id="musicCoverFileInput" accept="image/*,image/gif" style="display: none;" onchange="handleMusicCoverFileUpload(event)">
                    <button class="btn-primary" onclick="document.getElementById('musicCoverFileInput').click()">
                        选择本地图片
                    </button>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        支持 JPG、PNG、GIF 等格式
                    </div>
                </div>

                <!-- URL上传 -->
                <div class="form-group">
                    <label class="form-label">URL上传</label>
                    <input type="text" class="form-input" id="musicCoverUrlInput" placeholder="输入图片URL地址">
                    <button class="btn-primary" onclick="handleMusicCoverUrlUpload()" style="margin-top: 10px;">
                        加载URL图片
                    </button>
                </div>

                <!-- 操作按钮 -->
                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button class="btn-primary" onclick="resetMusicCover()" style="flex: 1; background: #dc3545; color: white; border: none;">
                        重置为默认
                    </button>
                    <button class="btn-primary btn-save" onclick="saveMusicCover()" style="flex: 1;">
                        保存封面
                    </button>
                </div>

                <!-- 在线音乐搜索 -->
                <div style="margin-top: 50px; padding-top: 30px; border-top: 2px solid #e0e0e0;">
                    <div class="section-title">
                        <span class="section-title-text">在线搜索音乐</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">搜索歌曲</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" class="form-input" id="musicSearchInput" placeholder="输入歌曲名、歌手名或专辑名" style="flex: 0 0 60%;" onkeypress="if(event.key === 'Enter') searchMusic()">
                            <button class="btn-primary" onclick="searchMusic()" style="flex: 0 0 calc(40% - 10px);">
                                搜索
                            </button>
                        </div>
                        <div style="margin-top: 8px; font-size: 12px; color: #666;">
                            支持搜索iTunes音乐库（全球）或网易云音乐（中国）
                        </div>
                    </div>

                    <!-- API源选择 -->
                    <div class="form-group">
                        <label class="form-label">API服务 <span style="color: #28a745; font-weight: bold;">实测可用</span></label>
                        <select class="form-select" id="musicApiSelect" onchange="updateApiDescription()">
                            <option value="meting1">Meting-API-1（推荐）- 网易云+QQ+酷狗+酷我</option>
                            <option value="meting2">Meting-API-2 - 稳定快速，多平台聚合</option>
                            <option value="meting3">Vkeys-API - 网易云+QQ音乐（高成功率）</option>
                            <option value="aa1">AA1聚合API - 多平台聚合</option>
                            <option value="nanyi">NanYi聚合API - 全平台支持</option>
                        </select>
                        <div id="apiDescription" style="margin-top: 8px; font-size: 12px; color: #666;">
                            实测可用 - 支持网易云、QQ、酷狗、酷我
                        </div>
                    </div>

                    <!-- 搜索结果区域 -->
                    <div id="musicSearchResults" style="display: none; margin-top: 20px;">
                        <div class="section-title" style="margin-bottom: 15px;">
                            <span class="section-title-text">搜索结果</span>
                        </div>
                        <div id="musicSearchList" style="max-height: 400px; overflow-y: auto; border: 2px solid #e0e0e0; border-radius: 12px; background: #f8f8f8;">
                            <!-- 搜索结果将动态插入这里 -->
                        </div>
                    </div>

                    <!-- 加载提示 -->
                    <div id="musicSearchLoading" style="display: none; text-align: center; margin-top: 20px; padding: 20px; background: #f0f8ff; border-radius: 12px;">
                        <div style="font-size: 16px; color: #007bff; margin-bottom: 8px;">正在搜索...</div>
                        <div style="font-size: 12px; color: #666;">请稍候</div>
                    </div>

                    <!-- 本地上传音乐 -->
                    <div style="margin-top: 40px; padding-top: 30px; border-top: 2px solid #e0e0e0;">
                        <div class="section-title">
                            <span class="section-title-text">本地上传音乐</span>
                        </div>

                        <!-- 本地上传开关 -->
                        <div class="form-group">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; background: #f8f8f8; border-radius: 12px; border: 2px solid #e0e0e0;">
                                <div>
                                    <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 4px;">启用本地上传</div>
                                    <div style="font-size: 12px; color: #999;">通过URL上传自定义音乐</div>
                                </div>
                                <label class="ios-switch" style="transform: scale(1.2);">
                                    <input type="checkbox" id="customMusicToggle" onchange="toggleCustomMusicUpload()">
                                    <span class="ios-slider"></span>
                                </label>
                            </div>
                        </div>

                        <!-- 上传表单（默认隐藏） -->
                        <div id="customMusicForm" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">歌曲名称</label>
                            <input type="text" class="form-input" id="customMusicName" placeholder="请输入歌曲名称">
                        </div>

                        <div class="form-group">
                            <label class="form-label">歌手</label>
                            <input type="text" class="form-input" id="customMusicArtist" placeholder="请输入歌手名称">
                        </div>

                        <div class="form-group">
                            <label class="form-label">专辑（可选）</label>
                            <input type="text" class="form-input" id="customMusicAlbum" placeholder="请输入专辑名称">
                        </div>

                        <div class="form-group">
                            <label class="form-label">封面图片URL（可选）</label>
                            <input type="text" class="form-input" id="customMusicCover" placeholder="请输入封面图片URL">
                            <div style="margin-top: 8px; font-size: 12px; color: #666;">
                                留空则使用默认封面
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">音乐URL</label>
                            <input type="text" class="form-input" id="customMusicUrl" placeholder="请输入音乐文件URL（支持mp3、m4a等格式）">
                            <div style="margin-top: 8px; font-size: 12px; color: #666;">
                                必须是可直接访问的音频文件链接
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">歌词（可选）</label>
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <input type="file" id="customLyricFile" accept=".lrc,.txt" style="display: none;" onchange="handleLyricFileUpload(event)">
                                <button class="btn-primary" onclick="document.getElementById('customLyricFile').click()" style="flex: 1;">
                                    上传LRC文件
                                </button>
                                <button class="btn-primary" onclick="clearCustomLyric()" style="flex: 1; background: #6c757d;">
                                    清空歌词
                                </button>
                            </div>
                            <textarea class="form-input" id="customMusicLyric" placeholder="请粘贴LRC格式歌词，或点击上传LRC文件&#10;例如：&#10;[00:12.00]第一句歌词&#10;[00:17.20]第二句歌词" rows="6" style="resize: vertical; min-height: 120px; font-family: monospace; font-size: 12px;"></textarea>
                            <div style="margin-top: 8px; font-size: 12px; color: #666;">
                                支持手动粘贴或上传LRC文件，格式：[mm:ss.xx]歌词文本
                            </div>
                        </div>

                        <div style="margin-top: 20px;">
                            <button class="btn-primary" onclick="addCustomMusic()" style="width: 100%;">
                                添加到音乐库
                            </button>
                        </div>
                        </div>
                    </div>

                    <!-- 我的音乐库 -->
                    <div style="margin-top: 40px; padding-top: 30px; border-top: 2px solid #e0e0e0;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                            <div class="section-title" style="margin-bottom: 0;">
                                <span class="section-title-text">我的音乐库</span>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="checkMusicLinks()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);" onmouseover="this.style.background='#218838'; this.style.boxShadow='0 4px 8px rgba(40, 167, 69, 0.3)'" onmouseout="this.style.background='#28a745'; this.style.boxShadow='0 2px 4px rgba(40, 167, 69, 0.2)'">
                                    检查链接
                                </button>
                                <button onclick="clearMusicLibrary()" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(220, 53, 69, 0.2);" onmouseover="this.style.background='#c82333'; this.style.boxShadow='0 4px 8px rgba(220, 53, 69, 0.3)'" onmouseout="this.style.background='#dc3545'; this.style.boxShadow='0 2px 4px rgba(220, 53, 69, 0.2)'">
                                    清空
                                </button>
                            </div>
                        </div>
                        <div id="musicLibraryList" style="max-height: 300px; overflow-y: auto; border: 2px solid #e0e0e0; border-radius: 12px; background: #f8f8f8; padding: 10px;">
                            <div style="text-align: center; color: #999; padding: 30px;">
                                暂无音乐，请先搜索并添加
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 头像更换弹窗 -->
    <div class="settings-page" id="avatarModal" style="z-index: 2000;">
        <div class="settings-content" style="max-width: 400px;">
            <div class="settings-header">
                <div class="back-btn" onclick="closeAvatarModal()">←</div>
                <div class="settings-title">更换头像</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <div class="section-title">
                    <span class="section-title-text">选择上传方式</span>
                </div>
                
                <!-- 头像预览 -->
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="width: 120px; height: 120px; margin: 0 auto; border-radius: 16px; overflow: hidden; background-color: #f5f5f5; display: flex; align-items: center; justify-content: center; border: 2px solid #e0e0e0;">
                        <span id="previewPlaceholder" style="font-size: 14px; color: #999;">头像预览</span>
                        <img id="previewImage" style="display: none; width: 100%; height: 100%; object-fit: cover;">
                    </div>
                </div>

                <!-- 本地上传 -->
                <div class="form-group">
                    <label class="form-label">本地上传</label>
                    <input type="file" id="avatarFileInput" accept="image/*,image/gif" style="display: none;" onchange="handleFileUpload(event)">
                    <button class="btn-primary" onclick="document.getElementById('avatarFileInput').click()">
                        选择本地图片
                    </button>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        支持 JPG、PNG、GIF 等格式
                    </div>
                </div>

                <!-- URL上传 -->
                <div class="form-group">
                    <label class="form-label">URL上传</label>
                    <input type="text" class="form-input" id="avatarUrlInput" placeholder="输入图片URL地址">
                    <button class="btn-primary" onclick="handleUrlUpload()" style="margin-top: 10px;">
                        加载URL图片
                    </button>
                </div>

                <!-- 操作按钮 -->
                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button class="btn-primary" onclick="resetAvatar()" style="flex: 1; background: #dc3545; color: white; border: none;">
                        重置为默认
                    </button>
                    <button class="btn-primary btn-save" onclick="saveAvatar()" style="flex: 1;">
                        保存头像
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 删除预设弹窗 -->
    <div class="settings-page" id="deleteModal" style="z-index: 2000;">
        <div class="settings-content" style="max-width: 400px;">
            <div class="settings-header">
                <div class="back-btn" onclick="closeDeleteModal()">←</div>
                <div class="settings-title">删除预设</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <div class="section-title">
                    <span class="section-title-text">选择要删除的预设</span>
                </div>
                
                <div class="form-group">
                    <select class="form-select" id="deletePresetSelect" size="8" multiple style="height: auto; min-height: 200px;">
                        <option value="" disabled style="color: #999;">暂无预设</option>
                    </select>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        提示：按住 Ctrl 多选，Shift 连续选择
                    </div>
                </div>

                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn-primary" onclick="toggleDeleteSelectAll()" style="flex: 1;">全选/取消</button>
                    <button class="btn-primary" onclick="confirmDeletePresets()" style="flex: 1; background: #dc3545;">确认删除</button>
                </div>
            </div>
        </div>
    </div>

    <!-- API设置界面 -->
    <div class="settings-page" id="apiSettings">
        <div class="settings-content">
            <div class="settings-header">
                <div class="back-btn" onclick="closeSettings()">←</div>
                <div class="settings-title">API Settings</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
            <div class="section-title">
                <span class="section-title-text">API连接</span>
            </div>
            
            <div class="form-group">
                <label class="form-label">选择API</label>
                <select class="form-select" id="apiProvider" onchange="handleProviderChange()">
                    <option value="hakimi">Gemini</option>
                    <option value="claude">Claude</option>
                    <option value="ds">DeepSeek</option>
                    <option value="custom">Custom</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">API地址</label>
                <input type="text" class="form-input" id="apiUrl" placeholder="输入API地址">
            </div>

            <div class="form-group">
                <label class="form-label">API密钥</label>
                <input type="password" class="form-input" id="apiKey" placeholder="输入API密钥">
            </div>

            <div class="form-group">
                <label class="form-label">模型选择</label>
                <div class="model-input-group">
                    <div class="model-input-wrapper">
                        <input type="text" class="form-input" id="modelInput" placeholder="手写模型名称">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <select class="form-select" id="modelSelect">
                    <option value="">从列表选择模型</option>
                </select>
            </div>

            <button class="btn-primary" onclick="fetchModels()">获取模型列表</button>
            <button class="btn-primary btn-save" onclick="saveSettings()">保存设置</button>

            <!-- 模型参数调节 -->
            <div style="margin-top: 50px;">
                <div class="section-title">
                    <span class="section-title-text">模型参数</span>
                </div>

                <!-- Temperature -->
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <label class="form-label" style="margin-bottom: 0;">Temperature（温度）</label>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="temperatureValue" style="font-size: 15px; font-weight: 600; color: #007bff; min-width: 36px; text-align: right;">0.9</span>
                            <button class="param-reset-btn" onclick="document.getElementById('temperatureSlider').value=0.9;document.getElementById('temperatureValue').textContent='0.9';">重置</button>
                        </div>
                    </div>
                    <input type="range" class="param-slider" id="temperatureSlider" min="0" max="2" step="0.1" value="0.9" oninput="document.getElementById('temperatureValue').textContent = this.value">
                    <div style="display: flex; justify-content: space-between; font-size: 11px; color: #999; margin-top: 4px;">
                        <span>精确 0</span>
                        <span>2 创意</span>
                    </div>
                </div>

                <!-- Top P -->
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <label class="form-label" style="margin-bottom: 0;">Top P</label>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="topPValue" style="font-size: 15px; font-weight: 600; color: #007bff; min-width: 36px; text-align: right;">0.95</span>
                            <button class="param-reset-btn" onclick="document.getElementById('topPSlider').value=0.95;document.getElementById('topPValue').textContent='0.95';">重置</button>
                        </div>
                    </div>
                    <input type="range" class="param-slider" id="topPSlider" min="0" max="1" step="0.05" value="0.95" oninput="document.getElementById('topPValue').textContent = this.value">
                    <div style="display: flex; justify-content: space-between; font-size: 11px; color: #999; margin-top: 4px;">
                        <span>保守 0</span>
                        <span>1 多样</span>
                    </div>
                </div>

                <!-- Max Tokens -->
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <label class="form-label" style="margin-bottom: 0;">Max Tokens（最大输出长度）</label>
                        <button class="param-reset-btn" onclick="document.getElementById('maxTokensInput').value=2048;">重置</button>
                    </div>
                    <input type="number" class="form-input" id="maxTokensInput" placeholder="最大输出token数" value="2048" min="1" max="1000000">
                    <div style="margin-top: 8px; font-size: 12px; color: #999;">
                        控制AI单次回复的最大长度，建议 512~8192
                    </div>
                </div>

                <!-- 保存模型参数按钮 -->
                <button class="btn-primary" onclick="saveModelParams()" style="margin-top: 20px; background: #007bff; color: white; border: none;">
                    保存模型参数
                </button>
                <div style="margin-top: 8px; font-size: 12px; color: #999; text-align: center;">
                    保存 Temperature、Top P 和 Max Tokens 设置
                </div>
            </div>

            <!-- API预设保存 -->
            <div style="margin-top: 50px;">
                <div class="section-title">
                    <span class="section-title-text">副API连接</span>
                </div>
                <div style="margin-bottom: 16px; font-size: 12px; color: #999;">
                    副API用于长期记忆总结和精简功能。未配置时自动使用主API。
                </div>

                <div class="form-group">
                    <label class="form-label">选择API</label>
                    <select class="form-select" id="secApiProvider" onchange="handleSecProviderChange()">
                        <option value="hakimi">Gemini</option>
                        <option value="claude">Claude</option>
                        <option value="ds">DeepSeek</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">API地址</label>
                    <input type="text" class="form-input" id="secApiUrl" placeholder="输入API地址">
                </div>

                <div class="form-group">
                    <label class="form-label">API密钥</label>
                    <input type="password" class="form-input" id="secApiKey" placeholder="输入API密钥">
                </div>

                <div class="form-group">
                    <label class="form-label">模型选择</label>
                    <div class="model-input-group">
                        <div class="model-input-wrapper">
                            <input type="text" class="form-input" id="secModelInput" placeholder="手写模型名称">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <select class="form-select" id="secModelSelect">
                        <option value="">从列表选择模型</option>
                    </select>
                </div>

                <button class="btn-primary" onclick="fetchSecModels()">获取模型列表</button>
                <button class="btn-primary btn-save" onclick="saveSecSettings()">保存副API设置</button>
                <button class="btn-primary" onclick="clearSecSettings()" style="background: #dc3545; color: white; border: none;">清除副API设置</button>
            </div>

            <!-- 格式修正功能 -->
            <div style="margin-top: 50px;">
                <div class="section-title">
                    <span class="section-title-text">格式修正</span>
                </div>
                
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <label class="form-label" style="margin-bottom: 4px;">自动修正格式</label>
                            <div style="font-size: 12px; color: #999;">AI回复格式异常时自动调用API修正</div>
                        </div>
                        <label class="ios-switch">
                            <input type="checkbox" id="autoFormatFixToggle" checked onchange="toggleAutoFormatFix()">
                            <span class="ios-slider"></span>
                        </label>
                    </div>
                </div>
                
                <div style="margin-top: 12px; padding: 12px; background-color: #f8f9fa; border-radius: 10px; border: 1px solid #e9ecef;">
                    <div style="font-size: 12px; color: #666; line-height: 1.6;">
                        <div style="font-weight: 600; margin-bottom: 6px;">功能说明：</div>
                        <div>• 开启后：AI回复格式异常时自动调用API修正</div>
                        <div>• 关闭后：只能通过聊天扩展面板手动调节</div>
                        <div style="margin-top: 6px; color: #999;">默认开启，建议保持开启以获得最佳体验</div>
                    </div>
                </div>
            </div>

            <!-- API预设保存 -->
            <div style="margin-top: 50px;">
                <div class="section-title">
                    <span class="section-title-text">API预设保存</span>
                </div>
                
                <div class="form-group">
                    <label class="form-label">已保存的预设</label>
                    <select class="form-select" id="presetSelect">
                        <option value="">选择预设...</option>
                    </select>
                </div>

                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn-primary" onclick="loadPreset()" style="flex: 1; min-width: 120px;">加载预设</button>
                    <button class="btn-primary" onclick="savePreset()" style="flex: 1; min-width: 120px;">保存为预设</button>
                    <button class="btn-primary" onclick="openDeleteModal()" style="flex: 1; min-width: 120px; background: #dc3545;">删除预设</button>
                </div>
            </div>

            <!-- API历史记录 -->
            <div style="margin-top: 50px;">
                <div class="section-title">
                    <span class="section-title-text">API历史记录</span>
                </div>
                
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <label class="form-label" style="margin-bottom: 4px;">记录API调用历史</label>
                            <div style="font-size: 12px; color: #999;">开启后记录每次API请求和响应数据</div>
                        </div>
                        <label class="ios-switch">
                            <input type="checkbox" id="apiHistoryToggle" onchange="toggleApiHistory()">
                            <span class="ios-slider"></span>
                        </label>
                    </div>
                </div>
                
                <div style="margin-top: 12px; padding: 12px; background-color: #f8f9fa; border-radius: 10px; border: 1px solid #e9ecef;">
                    <div style="font-size: 12px; color: #666; line-height: 1.6;">
                        <div style="font-weight: 600; margin-bottom: 6px;">功能说明：</div>
                        <div>• 记录每次API调用的请求和响应数据</div>
                        <div>• 可在聊天设置中查看和管理历史记录</div>
                        <div>• 默认关闭以节省存储空间</div>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label class="form-label">历史记录数量限制</label>
                    <input type="number" class="form-input" id="apiHistoryLimit" placeholder="最多保存的记录数" value="100" min="10" max="1000" step="10">
                    <div style="margin-top: 8px; font-size: 12px; color: #999;">
                        超过限制后自动删除最旧的记录，建议 50~200
                    </div>
                </div>
            </div>

            <!-- 全局后台系统 -->
            <div style="margin-top: 50px;">
                <div class="section-title">
                    <span class="section-title-text">全局后台系统</span>
                </div>
                <div style="margin-bottom: 16px; font-size: 12px; color: #999;">
                    全局设置对所有角色生效。角色单独设置可覆盖全局设置。
                </div>

                <!-- 全局后台活动 -->
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <label class="form-label" style="margin-bottom: 4px;">全局后台活动</label>
                            <div style="font-size: 12px; color: #999;">所有角色拥有自己的生活节奏（可被角色单独设置覆盖）</div>
                        </div>
                        <label class="ios-switch">
                            <input type="checkbox" id="globalBgActivityToggle" onchange="toggleGlobalBgActivity()">
                            <span class="ios-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- 全局定时主动消息 -->
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <label class="form-label" style="margin-bottom: 4px;">全局定时消息</label>
                            <div style="font-size: 12px; color: #999;">所有角色按设定间隔主动发消息（可被角色单独设置覆盖）</div>
                        </div>
                        <label class="ios-switch">
                            <input type="checkbox" id="globalIndProactiveToggle" onchange="toggleGlobalIndProactive()">
                            <span class="ios-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- 全局定时消息间隔 -->
                <div class="form-group">
                    <label class="form-label">全局消息间隔（分钟）</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="number" class="form-input" id="globalIndProactiveMin" value="5" min="0.1" step="0.1" max="1440" style="flex:1;">
                        <span style="color: #999;">~</span>
                        <input type="number" class="form-input" id="globalIndProactiveMax" value="10" min="0.1" step="0.1" max="1440" style="flex:1;">
                    </div>
                </div>

                <!-- 全局勿扰 -->
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <label class="form-label" style="margin-bottom: 4px;">全局勿扰模式</label>
                            <div style="font-size: 12px; color: #999;">设定时段内所有角色不发定时消息</div>
                        </div>
                        <label class="ios-switch">
                            <input type="checkbox" id="globalDndToggle">
                            <span class="ios-slider"></span>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">全局勿扰时段</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="time" class="form-input" id="globalDndStart" value="00:00" style="flex:1;">
                        <span style="color: #999;">至</span>
                        <input type="time" class="form-input" id="globalDndEnd" value="08:00" style="flex:1;">
                    </div>
                </div>

                <button class="btn-primary btn-save" onclick="saveGlobalBgSettings()">保存全局后台设置</button>

                <div style="margin-top: 12px; padding: 12px; background-color: #f8f9fa; border-radius: 10px; border: 1px solid #e9ecef;">
                    <div style="font-size: 12px; color: #666; line-height: 1.6;">
                        <div style="font-weight: 600; margin-bottom: 6px;">优先级说明：</div>
                        <div>• 角色单独开启 → 该角色使用自己的设置</div>
                        <div>• 角色未设置 + 全局开启 → 该角色跟随全局</div>
                        <div>• 角色未设置 + 全局关闭 → 该角色不启用</div>
                    </div>
                </div>

                <!-- 全局拉黑好友申请频率 -->
                <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid #e9ecef;">
                    <div class="section-title" style="margin-bottom: 16px;">
                        <span class="section-title-text">🚫 拉黑好友申请设置</span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">全局好友申请频率（分钟）</label>
                        <input type="number" class="form-input" id="globalBlockRequestInterval" value="10" min="1" step="1" max="1440">
                        <div style="font-size: 12px; color: #999; margin-top: 6px;">
                            角色被拉黑后每隔多少分钟发一次好友申请（角色可单独覆盖此设置）
                        </div>
                    </div>
                    <button class="btn-primary btn-save" onclick="saveGlobalBlockSettings()">保存拉黑设置</button>
                </div>
            </div>

            </div>
        </div>
    </div>

    <!-- 外观设置界面 -->
    <div class="settings-page" id="appearanceSettings">
        <div class="settings-content">
            <div class="settings-header">
                <div class="back-btn" onclick="closeAppearanceSettings()">←</div>
                <div class="settings-title">外观设置</div>
                <div style="width: 44px;"></div>
            </div>

            <!-- 标签页导航 -->
            <div class="appearance-tabs">
                <div class="appearance-tab active" onclick="switchAppearanceTab('lockscreen')">锁屏</div>
                <div class="appearance-tab" onclick="switchAppearanceTab('wallpaper')">壁纸</div>
                <div class="appearance-tab" onclick="switchAppearanceTab('interface')">界面</div>
                <div class="appearance-tab" onclick="switchAppearanceTab('pendant')">挂坠</div>
                <div class="appearance-tab" onclick="switchAppearanceTab('border')">边框</div>
            </div>

            <!-- 锁屏标签页 -->
            <div class="appearance-tab-content active" id="lockscreenTab">
            <div class="settings-card">
                <!-- 锁屏功能开关 -->
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <label class="form-label" style="margin-bottom: 4px;">锁屏功能</label>
                            <div style="font-size: 12px; color: #999;">启用后将显示锁屏界面</div>
                        </div>
                        <label class="ios-switch">
                            <input type="checkbox" id="lockScreenToggle" onchange="toggleLockScreen()">
                            <span class="ios-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- 解锁方式选择 -->
                <div class="form-group">
                    <label class="form-label">解锁方式</label>
                    <select class="form-input" id="unlockModeSelect" onchange="changeUnlockMode()">
                        <option value="default">默认解锁</option>
                        <option value="horizontal">横向滑动</option>
                        <option value="vertical">向上滑动</option>
                    </select>
                    <div style="font-size: 12px; color: #999; margin-top: 8px;">
                        选择滑动解锁的方式
                    </div>
                </div>

                <!-- 密码保护开关 -->
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <label class="form-label" style="margin-bottom: 4px;">密码保护</label>
                            <div style="font-size: 12px; color: #999;">启用密码解锁保护</div>
                        </div>
                        <label class="ios-switch">
                            <input type="checkbox" id="lockPasswordToggle" onchange="toggleLockPassword()">
                            <span class="ios-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- 密码类型选择 -->
                <div class="form-group">
                    <label class="form-label">密码类型</label>
                    <div style="display: flex; gap: 10px;">
                        <button class="password-type-btn active" id="numPasswordBtn" onclick="switchPasswordType('number')" style="flex: 1; padding: 10px; background: #333; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.2s;">
                            数字密码
                        </button>
                        <button class="password-type-btn" id="gesturePasswordBtn" onclick="switchPasswordType('gesture')" style="flex: 1; padding: 10px; background: #f2f2f7; color: #333; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.2s;">
                            手势密码
                        </button>
                    </div>
                </div>

                <!-- 数字密码设置 -->
                <div id="numberPasswordSettings">
                    <div class="form-group">
                        <label class="form-label">设置密码（4位数字）</label>
                        <input type="password" class="form-input" id="lockPasswordInput" placeholder="输入4位数字密码" maxlength="4" pattern="[0-9]*" inputmode="numeric">
                        <button class="btn-primary btn-save" onclick="saveLockPassword()" style="margin-top: 10px; width: 100%;">
                            保存密码
                        </button>
                        <div style="margin-top: 8px; font-size: 12px; color: #999;">
                            密码状态：<span id="passwordStatus" style="color: #dc3545;">未设置</span>
                        </div>
                    </div>
                </div>

                <!-- 手势密码设置 -->
                <div id="gesturePasswordSettings" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">绘制解锁手势</label>
                        <div style="margin-bottom: 10px; font-size: 12px; color: #999;">至少连接4个点</div>
                        <button class="btn-primary btn-save" onclick="openGestureSetup()" style="width: 100%;">
                            设置手势密码
                        </button>
                        <div style="margin-top: 8px; font-size: 12px; color: #999;">
                            手势状态：<span id="gestureStatus" style="color: #dc3545;">未设置</span>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- 壁纸标签页 -->
            <div class="appearance-tab-content" id="wallpaperTab">
            <div class="settings-card">
                <!-- 锁屏壁纸 -->
                <div class="section-title">
                    <span class="section-title-text">锁屏壁纸</span>
                </div>

                <!-- 壁纸预览 -->
                <div class="form-group">
                    <label class="form-label">壁纸预览</label>
                    <div style="width: 100%; height: 200px; border-radius: 12px; overflow: hidden; background: #f5f5f5; display: flex; align-items: center; justify-content: center; border: 2px solid #e5e5ea; position: relative;">
                        <span id="wallpaperPlaceholder" style="font-size: 14px; color: #999;">暂无壁纸</span>
                        <img id="wallpaperPreview" style="display: none; width: 100%; height: 100%; object-fit: cover;">
                    </div>
                </div>

                <!-- 本地上传 -->
                <div class="form-group">
                    <label class="form-label">本地上传</label>
                    <input type="file" id="wallpaperFileInput" accept="image/*,image/gif" style="display: none;" onchange="handleWallpaperFileUpload(event)">
                    <button class="btn-primary" onclick="document.getElementById('wallpaperFileInput').click()" style="width: 100%;">
                        选择本地图片
                    </button>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        支持 JPG、PNG、GIF 等格式
                    </div>
                </div>

                <!-- URL上传 -->
                <div class="form-group">
                    <label class="form-label">URL上传</label>
                    <input type="text" class="form-input" id="wallpaperUrlInput" placeholder="输入图片URL地址">
                    <button class="btn-primary" onclick="handleWallpaperUrlUpload()" style="margin-top: 10px; width: 100%;">
                        加载URL图片
                    </button>
                </div>

                <!-- 操作按钮 -->
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn-primary" onclick="resetWallpaper()" style="flex: 1; background: #dc3545; color: white; border: none;">
                        重置壁纸
                    </button>
                    <button class="btn-primary btn-save" onclick="saveWallpaper()" style="flex: 1;">
                        保存壁纸
                    </button>
                </div>

                <div style="margin-top: 10px; font-size: 12px; color: #999; text-align: center;">
                    壁纸状态：<span id="wallpaperStatus" style="color: #dc3545;">未设置</span>
                </div>

                <!-- 主屏幕壁纸 -->
                <div class="section-title" style="margin-top: 40px;">
                    <span class="section-title-text">主屏幕壁纸</span>
                </div>

                <!-- 壁纸预览 -->
                <div class="form-group">
                    <label class="form-label">壁纸预览</label>
                    <div style="width: 100%; height: 200px; border-radius: 12px; overflow: hidden; background: #f5f5f5; display: flex; align-items: center; justify-content: center; border: 2px solid #e5e5ea; position: relative;">
                        <span id="mainWallpaperPlaceholder" style="font-size: 14px; color: #999;">暂无壁纸</span>
                        <img id="mainWallpaperPreview" style="display: none; width: 100%; height: 100%; object-fit: cover;">
                    </div>
                </div>

                <!-- 本地上传 -->
                <div class="form-group">
                    <label class="form-label">本地上传</label>
                    <input type="file" id="mainWallpaperFileInput" accept="image/*,image/gif" style="display: none;" onchange="handleMainWallpaperFileUpload(event)">
                    <button class="btn-primary" onclick="document.getElementById('mainWallpaperFileInput').click()" style="width: 100%;">
                        选择本地图片
                    </button>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        支持 JPG、PNG、GIF 等格式
                    </div>
                </div>

                <!-- URL上传 -->
                <div class="form-group">
                    <label class="form-label">URL上传</label>
                    <input type="text" class="form-input" id="mainWallpaperUrlInput" placeholder="输入图片URL地址">
                    <button class="btn-primary" onclick="handleMainWallpaperUrlUpload()" style="margin-top: 10px; width: 100%;">
                        加载URL图片
                    </button>
                </div>

                <!-- 操作按钮 -->
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn-primary" onclick="resetMainWallpaper()" style="flex: 1; background: #dc3545; color: white; border: none;">
                        重置壁纸
                    </button>
                    <button class="btn-primary btn-save" onclick="saveMainWallpaper()" style="flex: 1;">
                        保存壁纸
                    </button>
                </div>

                <div style="margin-top: 10px; font-size: 12px; color: #999; text-align: center;">
                    壁纸状态：<span id="mainWallpaperStatus" style="color: #dc3545;">未设置</span>
                </div>

                <!-- 聊天列表背景 -->
                <div class="section-title" style="margin-top: 40px;">
                    <span class="section-title-text">聊天列表背景</span>
                </div>

                <div class="form-group">
                    <label class="form-label">本地上传背景图</label>
                    <input type="file" id="chatListBgUpload" accept="image/*" style="display: none;" onchange="handleChatListBgUpload(event)">
                    <button class="btn-primary" onclick="document.getElementById('chatListBgUpload').click()">
                        选择图片文件
                    </button>
                    <div style="font-size: 12px; color: #999; margin-top: 8px;">
                        支持 JPG、PNG、GIF 等图片格式
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">URL上传背景图</label>
                    <input type="text" class="form-input" id="chatListBgUrlInput" placeholder="输入图片URL地址">
                    <button class="btn-primary" onclick="handleChatListBgUrl()" style="margin-top: 8px;">
                        从URL加载背景图
                    </button>
                    <div style="font-size: 12px; color: #999; margin-top: 8px;">
                        输入在线图片的完整URL地址
                    </div>
                </div>

                <div class="form-group">
                    <button class="btn-primary" onclick="saveChatListBg()" style="background: #333333; color: #ffffff;">
                        保存背景图
                    </button>
                    <div style="font-size: 12px; color: #999; margin-top: 8px;">
                        点击保存后背景图将应用到聊天列表页面
                    </div>
                </div>

                <div class="form-group">
                    <button class="btn-primary" onclick="resetChatListBg()" style="background: #ff3b30;">
                        重置背景图
                    </button>
                    <div style="font-size: 12px; color: #999; margin-top: 8px;">
                        恢复默认白色背景
                    </div>
                </div>

                <!-- 背景图预览 -->
                <div class="form-group">
                    <label class="form-label">背景图预览</label>
                    <div id="chatListBgPreview" style="width: 100%; height: 150px; border-radius: 12px; background: #f5f5f5; display: flex; align-items: center; justify-content: center; color: #999; font-size: 14px; background-size: cover; background-position: center;">
                        暂无背景图
                    </div>
                </div>

                <!-- 全局聊天背景 -->
                <div class="section-title" style="margin-top: 40px;">
                    <span class="section-title-text">全局聊天背景</span>
                </div>

                <div class="form-group">
                    <label class="form-label">本地上传背景图</label>
                    <input type="file" id="chatDetailBgUpload" accept="image/*" style="display: none;" onchange="handleChatDetailBgUpload(event)">
                    <button class="btn-primary" onclick="document.getElementById('chatDetailBgUpload').click()">
                        选择图片文件
                    </button>
                    <div style="font-size: 12px; color: #999; margin-top: 8px;">
                        支持 JPG、PNG、GIF 等图片格式
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">URL上传背景图</label>
                    <input type="text" class="form-input" id="chatDetailBgUrlInput" placeholder="输入图片URL地址">
                    <button class="btn-primary" onclick="handleChatDetailBgUrl()" style="margin-top: 8px;">
                        从URL加载背景图
                    </button>
                    <div style="font-size: 12px; color: #999; margin-top: 8px;">
                        输入在线图片的完整URL地址
                    </div>
                </div>

                <div class="form-group">
                    <button class="btn-primary" onclick="saveChatDetailBg()" style="background: #333333; color: #ffffff;">
                        保存聊天背景
                    </button>
                    <div style="font-size: 12px; color: #999; margin-top: 8px;">
                        点击保存后背景图将应用到聊天对话页面
                    </div>
                </div>

                <div class="form-group">
                    <button class="btn-primary" onclick="resetChatDetailBg()" style="background: #ff3b30; color: #ffffff;">
                        重置背景图
                    </button>
                    <div style="font-size: 12px; color: #999; margin-top: 8px;">
                        恢复默认白色背景
                    </div>
                </div>

                <!-- 背景图预览 -->
                <div class="form-group">
                    <label class="form-label">背景图预览</label>
                    <div id="chatDetailBgPreview" style="width: 100%; height: 150px; border-radius: 12px; background: #f5f5f5; display: flex; align-items: center; justify-content: center; color: #999; font-size: 14px; background-size: cover; background-position: center;">
                        暂无背景图
                    </div>
                </div>
            </div>
            </div>

            <!-- 界面标签页 -->
            <div class="appearance-tab-content" id="interfaceTab">
            <div class="settings-card">

                <!-- 主屏幕方案 -->
                <div class="section-title">
                    <span class="section-title-text">主屏幕方案</span>
                </div>
                <div style="font-size: 12px; color: #999; margin-bottom: 16px; text-align: center;">
                    切换小组件布局方案，APP和功能保持不变
                </div>
                <div class="layout-scheme-list" id="layoutSchemeList">
                    <!-- JS动态渲染 -->
                </div>

                <div style="margin-top: 20px; border-top: 1px solid #f0f0f0; padding-top: 20px;"></div>

                <!-- UI风格 -->
                <div class="section-title">
                    <span class="section-title-text">UI风格</span>
                </div>
                <div style="font-size: 12px; color: #999; margin-bottom: 16px; text-align: center;">
                    切换界面整体UI风格，功能保持不变
                </div>
                <div class="layout-scheme-list" id="uiStyleList">
                    <!-- JS动态渲染 -->
                </div>

                <div style="margin-top: 20px; border-top: 1px solid #f0f0f0; padding-top: 20px;"></div>

                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <label class="form-label" style="margin-bottom: 4px;">显示顶栏</label>
                            <div style="font-size: 12px; color: #999;">显示或隐藏顶部状态栏</div>
                        </div>
                        <label class="ios-switch">
                            <input type="checkbox" id="statusBarToggle" onchange="toggleStatusBar()" checked>
                            <span class="ios-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- 顶栏分割线设置 -->
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <label class="form-label" style="margin-bottom: 4px;">隐藏聊天顶栏分割线</label>
                            <div style="font-size: 12px; color: #999;">隐藏聊天界面顶栏的分割线，界面更简洁</div>
                        </div>
                        <label class="ios-switch">
                            <input type="checkbox" id="hideHeaderDividerToggle" onchange="toggleHeaderDivider()" checked>
                            <span class="ios-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- APP图标自定义 -->
                <div style="margin-top: 20px; border-top: 1px solid #f0f0f0; padding-top: 20px;">
                    <label class="form-label" style="margin-bottom: 4px;">自定义APP图标</label>
                    <div style="font-size: 12px; color: #999; margin-bottom: 16px;">点击图标可更换为自定义图片</div>

                    <div id="appIconGrid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;"></div>

                    <button class="btn-primary" onclick="resetAllAppIcons()" style="width: 100%; margin-top: 20px; background: #ff3b30; color: white; border: none;">重置所有图标</button>
                </div>

                <!-- APP名称自定义 -->
                <div style="margin-top: 20px; border-top: 1px solid #f0f0f0; padding-top: 20px;">
                    <label class="form-label" style="margin-bottom: 4px;">自定义APP名称</label>
                    <div style="font-size: 12px; color: #999; margin-bottom: 16px;">点击名称可修改</div>

                    <div id="appNameGrid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;"></div>

                    <button class="btn-primary" onclick="resetAllAppNames()" style="width: 100%; margin-top: 20px; background: #ff3b30; color: white; border: none;">重置所有名称</button>
                </div>

                <!-- 消息通知弹窗设置 -->
                <div style="margin-top: 20px; border-top: 1px solid #f0f0f0; padding-top: 20px;">
                    <label class="form-label" style="margin-bottom: 4px;">消息通知弹窗</label>
                    <div style="font-size: 12px; color: #999; margin-bottom: 16px;">角色发消息时在顶部弹出通知</div>

                    <!-- 多条堆叠开关 -->
                    <div class="form-group" style="margin-top: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <label class="form-label" style="margin-bottom: 4px;">多条堆叠</label>
                                <div style="font-size: 12px; color: #999;">同时显示多条通知，关闭则新通知替换旧通知</div>
                            </div>
                            <label class="ios-switch">
                                <input type="checkbox" id="notifStackToggle" onchange="toggleNotifStack()">
                                <span class="ios-slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- 仅非当前聊天角色弹窗开关 -->
                    <div class="form-group" style="margin-top: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <label class="form-label" style="margin-bottom: 4px;">仅非当前聊天角色弹窗</label>
                                <div style="font-size: 12px; color: #999;">开启后正在聊天的角色不弹窗</div>
                            </div>
                            <label class="ios-switch">
                                <input type="checkbox" id="notifOnlyOtherToggle" onchange="toggleNotifOnlyOther()" checked>
                                <span class="ios-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 触感反馈设置 -->
                <div style="margin-top: 20px; border-top: 1px solid #f0f0f0; padding-top: 20px;">
                    <label class="form-label" style="margin-bottom: 4px;">触感反馈</label>
                    <div style="font-size: 12px; color: #999; margin-bottom: 16px;">点击按钮时产生震动反馈</div>

                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <label class="form-label" style="margin-bottom: 4px;">启用触感</label>
                                <div style="font-size: 12px; color: #999;">点击按钮、开关等交互时震动</div>
                            </div>
                            <label class="ios-switch">
                                <input type="checkbox" id="hapticFeedbackToggle" onchange="toggleHapticFeedback()" checked>
                                <span class="ios-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 发送动画设置 -->
                <div style="margin-top: 20px; border-top: 1px solid #f0f0f0; padding-top: 20px;">
                    <label class="form-label" style="margin-bottom: 4px;">发送动画</label>
                    <div style="font-size: 12px; color: #999; margin-bottom: 16px;">发送消息时按钮的弹性动画效果</div>

                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <label class="form-label" style="margin-bottom: 4px;">启用发送动画</label>
                                <div style="font-size: 12px; color: #999;">聊天和短信发送时的按钮动画</div>
                            </div>
                            <label class="ios-switch">
                                <input type="checkbox" id="sendAnimationToggle" onchange="toggleSendAnimation()">
                                <span class="ios-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- 挂坠标签页 -->
            <div class="appearance-tab-content" id="pendantTab">
            <div class="settings-card">
                <!-- 挂坠功能说明 -->
                <div style="text-align: center; padding: 20px; background: #f8f8f8; border-radius: 12px; margin-bottom: 20px;">
                    <div style="font-size: 14px; color: #666; margin-bottom: 8px; font-weight: 500;">挂坠装饰</div>
                    <div style="font-size: 12px; color: #999;">在主屏幕添加挂坠装饰，支持自定义动画效果</div>
                </div>

                <!-- 显示/隐藏开关 -->
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <label class="form-label" style="margin-bottom: 4px;">显示挂坠</label>
                            <div style="font-size: 12px; color: #999;">在主屏幕显示挂坠装饰</div>
                        </div>
                        <label class="ios-switch">
                            <input type="checkbox" id="pendantVisibilityToggle" onchange="togglePendantVisibility()">
                            <span class="ios-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- 图片设置 -->
                <div class="section-title">
                    <span class="section-title-text">图片设置</span>
                </div>

                <!-- 图片预览 -->
                <div class="form-group">
                    <label class="form-label">挂坠预览</label>
                    <div style="width: 100%; height: 150px; border-radius: 12px; overflow: hidden; background: #f5f5f5; display: flex; align-items: center; justify-content: center; border: 2px solid #e5e5ea; position: relative;">
                        <div id="pendantImagePlaceholder" style="font-size: 14px; color: #999; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                            <div style="width: 60px; height: 60px; border-radius: 50%; background: #e0e0e0; display: flex; align-items: center; justify-content: center;">
                                <span style="font-size: 12px; color: #999;">预览</span>
                            </div>
                            <span>暂无挂坠图片</span>
                        </div>
                        <img id="pendantImagePreview" style="display: none; max-width: 100%; max-height: 100%; object-fit: contain;">
                    </div>
                </div>

                <!-- 本地上传 -->
                <div class="form-group">
                    <label class="form-label">本地上传</label>
                    <button class="btn-primary" onclick="openPendantImageUpload()" style="width: 100%;">
                        选择本地图片
                    </button>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        支持 JPG、PNG、GIF 等格式，建议使用透明背景 PNG
                    </div>
                </div>

                <!-- URL上传 -->
                <div class="form-group">
                    <label class="form-label">URL上传</label>
                    <input type="text" class="form-input" id="pendantImageUrlInput" placeholder="输入图片URL地址">
                    <button class="btn-primary" onclick="loadPendantImageFromUrl()" style="margin-top: 10px; width: 100%;">
                        加载URL图片
                    </button>
                </div>

                <!-- 重置按钮 -->
                <div class="form-group">
                    <button class="btn-primary" onclick="resetPendantImage()" style="background: #dc3545; color: white; border: none;">
                        重置图片
                    </button>
                </div>

                <!-- 位置调整 -->
                <div class="section-title" style="margin-top: 30px;">
                    <span class="section-title-text">位置调整</span>
                </div>

                <!-- 水平位置 -->
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <label class="form-label" style="margin: 0;">水平位置</label>
                        <span id="pendantPositionXValue" style="font-size: 13px; color: #666;">50%</span>
                    </div>
                    <input type="range" class="param-slider" id="pendantPositionX" min="0" max="100" value="50" oninput="document.getElementById('pendantPositionXValue').textContent = this.value + '%'" onchange="updatePendantPosition()">
                    <div style="margin-top: 4px; font-size: 11px; color: #999; display: flex; justify-content: space-between;">
                        <span>左</span>
                        <span>右</span>
                    </div>
                </div>

                <!-- 垂直位置 -->
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <label class="form-label" style="margin: 0;">垂直位置</label>
                        <span id="pendantPositionYValue" style="font-size: 13px; color: #666;">20%</span>
                    </div>
                    <input type="range" class="param-slider" id="pendantPositionY" min="0" max="100" value="20" oninput="document.getElementById('pendantPositionYValue').textContent = this.value + '%'" onchange="updatePendantPosition()">
                    <div style="margin-top: 4px; font-size: 11px; color: #999; display: flex; justify-content: space-between;">
                        <span>上</span>
                        <span>下</span>
                    </div>
                </div>

                <!-- 大小调整 -->
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <label class="form-label" style="margin: 0;">挂坠大小</label>
                        <span id="pendantSizeValue" style="font-size: 13px; color: #666;">60px</span>
                    </div>
                    <input type="range" class="param-slider" id="pendantSizeInput" min="30" max="150" value="60" oninput="document.getElementById('pendantSizeValue').textContent = this.value + 'px'" onchange="updatePendantSize()">
                    <div style="margin-top: 4px; font-size: 11px; color: #999; display: flex; justify-content: space-between;">
                        <span>小</span>
                        <span>大</span>
                    </div>
                </div>

                <!-- 动画效果 -->
                <div class="section-title" style="margin-top: 30px;">
                    <span class="section-title-text">动画效果</span>
                </div>

                <!-- 预设动画 -->
                <div class="form-group">
                    <label class="form-label">动画预设</label>
                    <select class="form-input" id="pendantAnimationSelect" onchange="changePendantAnimation()">
                        <option value="none">无动画</option>
                        <option value="swing-slow">左右摇晃 - 慢速</option>
                        <option value="swing-medium" selected>左右摇晃 - 中速</option>
                        <option value="swing-fast">左右摇晃 - 快速</option>
                        <option value="bounce-slow">上下晃动 - 慢速</option>
                        <option value="bounce-medium">上下晃动 - 中速</option>
                        <option value="bounce-fast">上下晃动 - 快速</option>
                        <option value="rotate-slow">旋转 - 慢速</option>
                        <option value="rotate-medium">旋转 - 中速</option>
                        <option value="rotate-fast">旋转 - 快速</option>
                    </select>
                </div>

                <!-- 自定义动画 -->
                <div class="form-group">
                    <label class="form-label">自定义动画代码</label>
                    <button class="btn-primary" onclick="openCustomAnimationEditor()">
                        打开动画编辑器
                    </button>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        编写自定义CSS动画代码，实现更多效果
                    </div>
                </div>

                <!-- 保存按钮 -->
                <div class="form-group" style="margin-top: 30px;">
                    <button class="btn-primary btn-save" onclick="savePendantSettings()">
                        保存挂坠设置
                    </button>
                </div>
            </div>
            </div>

            <!-- 自定义动画编辑器（弹出层） -->
            <div id="customAnimationSection" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2001; overflow-y: auto; padding: 20px;">
                <div style="max-width: 500px; margin: 0 auto; background: white; border-radius: 16px; padding: 0; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                    <!-- 头部 -->
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #f0f0f0;">
                        <h3 style="font-size: 18px; color: #333; margin: 0; font-weight: 600;">自定义动画编辑器</h3>
                        <button onclick="closeCustomAnimationEditor()" style="width: 32px; height: 32px; border-radius: 50%; background: #f5f5f5; border: none; font-size: 20px; cursor: pointer; color: #666; transition: all 0.2s;">×</button>
                    </div>

                    <!-- 内容区域 -->
                    <div style="padding: 20px;">
                        <!-- 代码输入 -->
                        <div class="form-group">
                            <label class="form-label">CSS 动画代码</label>
                            <textarea class="form-input" id="customAnimationCodeInput" rows="10" placeholder="例如：&#10;.screen-pendant {&#10;  animation: myAnim 2s infinite;&#10;}&#10;@keyframes myAnim {&#10;  0% { transform: translate(-50%, -50%) rotate(0deg); }&#10;  100% { transform: translate(-50%, -50%) rotate(360deg); }&#10;}" style="font-family: 'Courier New', monospace; font-size: 13px;"></textarea>
                            <div style="margin-top: 8px; font-size: 12px; color: #666;">
                                输入完整的 CSS 代码，包括选择器和 @keyframes
                            </div>
                            <div style="margin-top: 12px; padding: 10px; background: #f0f8ff; border-radius: 8px; font-size: 11px; color: #666; line-height: 1.6;">
                                <div style="font-weight: 500; margin-bottom: 4px;">编写提示：</div>
                                <div>• 使用 .screen-pendant 选择器</div>
                                <div>• transform 属性需包含 translate(-50%, -50%) 以保持居中</div>
                                <div>• 示例：transform: translate(-50%, -50%) rotate(10deg);</div>
                            </div>
                        </div>

                        <!-- 操作按钮 -->
                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <button class="btn-primary" onclick="applyCustomAnimation()" style="flex: 1;">
                                应用动画
                            </button>
                            <button class="btn-primary btn-save" onclick="saveCustomAnimationPreset()" style="flex: 1;">
                                保存为预设
                            </button>
                        </div>

                        <!-- 预设管理 -->
                        <div class="section-title" style="margin-bottom: 15px;">
                            <span class="section-title-text">我的预设</span>
                        </div>

                        <!-- 预设列表 -->
                        <div id="customAnimationPresetList" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px; border: 1px solid #f0f0f0; border-radius: 8px; padding: 10px;">
                            <!-- JS动态渲染 -->
                        </div>

                        <!-- 批量操作 -->
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-primary" onclick="toggleSelectAllAnimationPresets()" style="flex: 1; font-size: 13px;">
                                全选/取消
                            </button>
                            <button class="btn-primary" onclick="batchDeleteAnimationPresets()" style="flex: 1; background: #dc3545; color: white; border: none; font-size: 13px;">
                                删除选中
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 边框标签页 -->
            <div class="appearance-tab-content" id="borderTab">
            <div class="settings-card">
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <label class="form-label" style="margin-bottom: 4px;">显示手机边框</label>
                            <div style="font-size: 12px; color: #999;">显示精致的手机边框</div>
                        </div>
                        <label class="ios-switch">
                            <input type="checkbox" id="phoneBorderToggle" onchange="togglePhoneBorder()">
                            <span class="ios-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- 边框颜色选择 -->
                <div class="form-group" id="borderColorSection" style="display: none; margin-top: 20px;">
                    <label class="form-label">边框颜色</label>
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 12px;">
                        <div class="color-option" data-color="#ffffff" style="background: #ffffff; border: 2px solid #e0e0e0;" onclick="selectBorderColor('#ffffff')">
                            <div class="color-check">✓</div>
                        </div>
                        <div class="color-option" data-color="#000000" style="background: #000000;" onclick="selectBorderColor('#000000')">
                            <div class="color-check">✓</div>
                        </div>
                        <div class="color-option" data-color="#ff6b6b" style="background: #ff6b6b;" onclick="selectBorderColor('#ff6b6b')">
                            <div class="color-check">✓</div>
                        </div>
                        <div class="color-option" data-color="#4ecdc4" style="background: #4ecdc4;" onclick="selectBorderColor('#4ecdc4')">
                            <div class="color-check">✓</div>
                        </div>
                        <div class="color-option" data-color="#95e1d3" style="background: #95e1d3;" onclick="selectBorderColor('#95e1d3')">
                            <div class="color-check">✓</div>
                        </div>
                        <div class="color-option" data-color="#ffd93d" style="background: #ffd93d;" onclick="selectBorderColor('#ffd93d')">
                            <div class="color-check">✓</div>
                        </div>
                        <div class="color-option" data-color="#6bcf7f" style="background: #6bcf7f;" onclick="selectBorderColor('#6bcf7f')">
                            <div class="color-check">✓</div>
                        </div>
                        <div class="color-option" data-color="#c77dff" style="background: #c77dff;" onclick="selectBorderColor('#c77dff')">
                            <div class="color-check">✓</div>
                        </div>
                        <div class="color-option" data-color="#ff9ff3" style="background: #ff9ff3;" onclick="selectBorderColor('#ff9ff3')">
                            <div class="color-check">✓</div>
                        </div>
                        <div class="color-option" data-color="#fca311" style="background: #fca311;" onclick="selectBorderColor('#fca311')">
                            <div class="color-check">✓</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="color" id="customBorderColor" class="custom-color-picker" value="#ffffff" onchange="selectBorderColor(this.value)">
                        <label for="customBorderColor" style="font-size: 13px; color: #666; cursor: pointer;">自定义颜色</label>
                    </div>
                </div>
            </div>
            </div>

        </div>
        </div>
    </div>

    <!-- 字体设置界面 -->
    <div class="settings-page" id="fontSettings">
        <div class="settings-content">
            <div class="settings-header">
                <div class="back-btn" onclick="closeFontSettings()">←</div>
                <div class="settings-title">字体设置</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <div class="section-title">
                    <span class="section-title-text">全局字体</span>
                </div>
                
                <div class="form-group">
                    <label class="form-label">选择字体</label>
                    <select id="globalFontSelect" class="form-input" onchange="previewFont()">
                        <option value="system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif">系统默认</option>
                        <option value="'Microsoft YaHei', 微软雅黑, sans-serif">微软雅黑</option>
                        <option value="'SimHei', 黑体, sans-serif">黑体</option>
                        <option value="'SimSun', 宋体, serif">宋体</option>
                        <option value="'KaiTi', 楷体, serif">楷体</option>
                        <option value="'FangSong', 仿宋, serif">仿宋</option>
                        <option value="'PingFang SC', 'Hiragino Sans GB', sans-serif">苹方/冬青黑</option>
                        <option value="'Arial', sans-serif">Arial</option>
                        <option value="'Helvetica Neue', Helvetica, sans-serif">Helvetica</option>
                        <option value="'Times New Roman', serif">Times New Roman</option>
                        <option value="'Courier New', monospace">Courier New</option>
                        <option value="'Comic Sans MS', cursive">Comic Sans MS</option>
                    </select>
                    <div style="font-size: 12px; color: #999; margin-top: 8px;">
                        选择应用到整个界面的字体
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">字体大小</label>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <input type="range" id="fontSizeRange" min="12" max="20" value="14" 
                               style="flex: 1;" oninput="updateFontSizePreview()">
                        <span id="fontSizeValue" style="min-width: 40px; text-align: right; font-weight: bold;">14px</span>
                    </div>
                    <div style="font-size: 12px; color: #999; margin-top: 8px;">
                        调整全局字体大小
                    </div>
                </div>

                <div class="form-group">
                    <div style="padding: 20px; background: #f8f9fa; border-radius: 12px; text-align: center;">
                        <div id="fontPreview" style="transition: all 0.3s ease;">
                            这是字体预览文本<br>
                            The quick brown fox jumps over the lazy dog<br>
                            0123456789
                        </div>
                    </div>
                </div>

                <button class="btn-primary btn-save" onclick="saveFontSettings()">保存设置</button>
                <button class="btn-primary" onclick="resetFontSettings()" 
                        style="background: #6c757d; margin-top: 12px;">恢复默认</button>

                <!-- 字体上传部分 -->
                <div class="section-title" style="margin-top: 40px;">
                    <span class="section-title-text">上传字体</span>
                </div>

                <!-- 本地上传 -->
                <div class="form-group">
                    <label class="form-label">本地上传字体文件</label>
                    <input type="file" id="localFontUpload" accept=".ttf,.otf,.woff,.woff2" 
                           multiple style="display: none;" onchange="handleLocalFontUpload(event)">
                    <button class="btn-primary" onclick="document.getElementById('localFontUpload').click()">
                        选择字体文件 (支持批量)
                    </button>
                    <div style="font-size: 12px; color: #999; margin-top: 8px;">
                        支持 .ttf, .otf, .woff, .woff2 格式，可多选
                    </div>
                </div>

                <!-- URL上传 -->
                <div class="form-group" style="margin-top: 20px;">
                    <label class="form-label">URL上传字体</label>
                    <textarea id="fontUrlInput" class="form-input" 
                              placeholder="输入字体URL，每行一个，支持批量添加&#10;例如：&#10;https://example.com/font1.woff2&#10;https://example.com/font2.woff2"
                              style="min-height: 100px; font-family: monospace; resize: vertical;"></textarea>
                    <button class="btn-primary" onclick="handleUrlFontUpload()" style="margin-top: 8px;">
                        从URL添加字体
                    </button>
                    <div style="font-size: 12px; color: #999; margin-top: 8px;">
                        每行一个URL，支持批量添加
                    </div>
                </div>

                <!-- 在线搜索字体 -->
                <div class="form-group" style="margin-top: 20px;">
                    <label class="form-label">在线搜索字体</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="fontSearchInput" class="form-input" 
                               placeholder="输入字体名称搜索（如：Roboto、Noto、Inter）..."
                               style="flex: 1;" onkeypress="if(event.key==='Enter') searchOnlineFonts()">
                        <button class="btn-primary" onclick="searchOnlineFonts()" 
                                style="width: auto; padding: 12px 20px; margin: 0;">
                            搜索
                        </button>
                    </div>
                    <div style="font-size: 12px; color: #999; margin-top: 8px;">
                        从 cdnjs、Fontsource 等开源平台搜索免费字体
                    </div>
                </div>

                <!-- 搜索结果 -->
                <div id="fontSearchResults" style="display: none; margin-top: 16px; max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; background: #fafafa;">
                    <div style="font-weight: bold; margin-bottom: 12px; color: #333;">搜索结果</div>
                    <div id="fontSearchResultsList"></div>
                </div>

                <!-- 上传进度提示 -->
                <div id="fontUploadProgress" style="display: none; margin-top: 16px; padding: 12px; background: #e3f2fd; border-radius: 8px; color: #1976d2;">
                    <div style="font-weight: bold; margin-bottom: 4px;">正在处理...</div>
                    <div id="fontUploadProgressText">0/0</div>
                </div>

                <!-- 字体库管理 -->
                <div class="section-title" style="margin-top: 40px;">
                    <span class="section-title-text">我的字体库</span>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 8px; margin-bottom: 16px;">
                    <button onclick="toggleFontLibraryEditMode()" id="fontLibraryEditBtn" 
                            style="padding: 6px 12px; background: #007aff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                        删除
                    </button>
                    <button onclick="refreshFontLibrary()" 
                            style="padding: 6px 12px; background: #34c759; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                        刷新
                    </button>
                </div>

                <!-- 批量操作栏 -->
                <div id="fontLibraryBottomBar" style="display: none; padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 16px;">
                    <button onclick="selectAllFonts()" style="padding: 8px 16px; background: #007aff; color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 8px;">
                        全选
                    </button>
                    <span style="color: #666; margin: 0 12px;">已选 <span id="selectedFontCount">0</span> 项</span>
                    <button onclick="deleteSelectedFonts()" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        删除选中
                    </button>
                </div>

                <!-- 字体列表 -->
                <div id="fontLibraryContainer" style="max-height: 400px; overflow-y: auto;">
                    <div style="text-align: center; padding: 40px; color: #999;">
                        暂无自定义字体<br>
                        <span style="font-size: 12px;">上传字体文件后会显示在这里</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 聊天界面 -->
    <div class="settings-page" id="chatPage">
        <div class="settings-content" style="max-width: 100%; height: 100%; padding: 0;">
            <!-- 顶部栏 (仅在聊天标签显示) -->
            <div class="chat-header" id="chatHeader">
                <div class="chat-header-back" onclick="closeChatPage()">←</div>
                <div class="chat-header-title-text">聊天</div>
                <div style="display: flex; gap: 8px;">
                    <div class="chat-header-add chat-header-group-btn" onclick="openCreateGroup()" title="创建群聊">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                    </div>
                    <div class="chat-header-add" onclick="addNewChat()" title="新建角色">+</div>
                </div>
            </div>

            <!-- 底部导航栏 -->
            <div class="chat-bottom-nav">
                <div class="chat-nav-item" onclick="switchChatTab('chat')">
                    <div class="chat-nav-text">聊天</div>
                </div>
                <div class="chat-nav-item" onclick="switchChatTab('friends')">
                    <div class="chat-nav-text" style="position:relative;">好友<span id="friendRequestBadge" class="friend-badge" style="display:none;">0</span></div>
                </div>
                <div class="chat-nav-item" onclick="switchChatTab('moments')">
                    <div class="chat-nav-text">朋友圈</div>
                </div>
                <div class="chat-nav-item" onclick="switchChatTab('profile')">
                    <div class="chat-nav-text">我的</div>
                </div>
            </div>

            <!-- 聊天标签页内容 -->
            <div class="chat-tab-content" id="chatTabContent" style="display: block;">
                <!-- 搜索框 -->
                <div class="chat-search-container">
                    <div class="chat-search-box">
                        <input type="text" class="chat-search-input" placeholder="搜索角色" id="chatSearchInput" oninput="filterChatList(this.value)">
                    </div>
                </div>

                <!-- 聊天列表 -->
                <div class="chat-list-container" id="chatListContainer">
                    <div class="chat-empty-state">
                        <div class="chat-empty-text">暂无聊天记录</div>
                    </div>
                </div>
            </div>

            <!-- 好友标签页内容 -->
            <div class="chat-tab-content" id="friendsTabContent" style="display: none; background: #ffffff; flex-direction: column;">
                <div style="padding:12px 16px 8px;display:flex;justify-content:space-between;align-items:center;">
                    <div style="font-size:17px;font-weight:600;color:#333;">好友申请</div>
                    <div id="friendReqEditBtn" onclick="toggleFriendReqEditMode()" style="font-size:14px;color:#007aff;cursor:pointer;">管理</div>
                </div>
                <div id="friendReqEditBar" style="display:none;padding:8px 16px;background:#f8f8f8;border-bottom:1px solid #e0e0e0;align-items:center;justify-content:space-between;">
                    <div style="display:flex;gap:12px;align-items:center;">
                        <label style="font-size:13px;color:#333;display:flex;align-items:center;gap:4px;cursor:pointer;">
                            <input type="checkbox" id="friendReqSelectAll" onchange="toggleFriendReqSelectAll(this.checked)"> 全选
                        </label>
                        <span id="friendReqSelectedCount" style="font-size:12px;color:#999;">已选 0 项</span>
                    </div>
                    <button id="friendReqDeleteBtn" onclick="deleteFriendReqSelected()" style="background:#ff3b30;color:#fff;border:none;border-radius:6px;padding:6px 14px;font-size:13px;cursor:pointer;" disabled>删除</button>
                </div>
                <div id="friendRequestListContainer" style="flex:1;overflow-y:auto;padding:0 0 12px;">
                    <!-- 动态生成 -->
                </div>
            </div>

            <!-- 我的标签页内容 -->
            <div class="chat-tab-content" id="profileTabContent" style="display: none; background: #ffffff;">
                <div class="profile-header-title">IDENTITY</div>
                
                <div class="profile-content">
                    <!-- 身份卡片 -->
                    <div class="profile-card">
                        <div class="profile-left">
                            <div class="profile-avatar-box">
                                <span id="profileAvatarPlaceholder">头像</span>
                                <img id="profileAvatarImage" style="display: none; width: 100%; height: 100%; object-fit: cover; border-radius: 6px;">
                            </div>
                            <canvas id="profileBarcode" class="profile-barcode"></canvas>
                        </div>
                        <div class="profile-info">
                            <div class="profile-info-row">
                                <span class="profile-label">姓名：</span>
                                <div class="profile-value" id="profileName"></div>
                            </div>
                            <div class="profile-info-row">
                                <span class="profile-label">ID：</span>
                                <div class="profile-value" id="profileId" onclick="openProfileIdModal()" style="cursor: pointer;"></div>
                            </div>
                            <div class="profile-info-row">
                                <span class="profile-label">有效期：</span>
                                <div class="profile-value" id="profileExpiry">长期</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 功能选项列表 -->
                    <div class="profile-options">
                        <div class="profile-option-item" onclick="openPersonaSettings()">
                            <span class="profile-option-text">人设</span>
                            <span class="profile-option-arrow">›</span>
                        </div>
                        <div class="profile-option-item" onclick="openBeautifySettings()">
                            <span class="profile-option-text">美化</span>
                            <span class="profile-option-arrow">›</span>
                        </div>
                        <div class="profile-option-item" onclick="openGeneralSettings()">
                            <span class="profile-option-text">设置</span>
                            <span class="profile-option-arrow">›</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* 聊天标签页内容 */
        .chat-tab-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding-bottom: 60px; /* 为底部导航栏留出空间 */
        }

        /* 我的页面样式 */
        .profile-header-title {
            font-size: 22px;
            font-weight: 700;
            color: #000000;
            padding: 20px 20px 10px;
            background: #ffffff;
            letter-spacing: 1px;
            border-top: 1px solid #e5e5e5;
            border-bottom: 1px solid #e5e5e5;
        }

        .profile-content {
            flex: 1;
            padding: 15px 20px 20px;
            background: #ffffff; /* 改成白色背景 */
            overflow-y: auto;
        }

        .profile-card {
            background: #ffffff;
            border: 2px solid #e5e5e5;
            border-radius: 16px;
            padding: 25px;
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .profile-left {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
            flex-shrink: 0;
        }

        /* 头像框：9:16竖长方形 */
        .profile-avatar-box {
            width: 56px;
            height: 100px;
            background-color: #d0d0d0;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #666666;
            flex-shrink: 0;
            overflow: hidden;
        }

        .profile-barcode {
            width: 56px;
            height: 25px;
            background-color: transparent;
            flex-shrink: 0;
        }

        .profile-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0;
            align-items: flex-start;
            justify-content: space-between;
            height: 130px;
        }

        .profile-info-row {
            display: flex;
            align-items: center;
            width: 100%;
            gap: 8px;
        }

        .profile-label {
            font-size: 14px;
            font-weight: 500;
            color: #000000;
            white-space: nowrap;
        }

        .profile-value {
            flex: 1;
            font-size: 14px;
            color: #333333;
            border-bottom: 1px solid #000000;
            padding-bottom: 2px;
            min-height: 20px;
        }

        .profile-name {
            font-size: 20px;
            font-weight: 600;
            color: #000000;
        }

        .profile-id {
            font-size: 14px;
            color: #999999;
        }

        /* 功能选项列表样式 */
        .profile-options {
            margin-top: 20px; /* 与身份卡的间距 */
            display: flex;
            flex-direction: column;
            gap: 12px; /* 选项之间间距 */
        }

        .profile-option-item {
            background: #ffffff; /* 纯白色背景 */
            border: 2px solid #e5e5e5; /* 边框 */
            border-radius: 28px; /* 胶囊形状，完全圆角 */
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 56px; /* 确保足够高度 */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); /* 轻微阴影 */
        }

        .profile-option-item:active {
            background: #f8f8f8;
            transform: scale(0.98);
        }

        .profile-option-text {
            font-size: 16px;
            font-weight: 500;
            color: #333333;
        }

        .profile-option-arrow {
            font-size: 24px;
            color: #999999;
            font-weight: 300;
        }

        /* 人设管理样式 */
        .add-btn {
            width: 44px;
            height: 44px;
            background-color: #ffffff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333333;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.2s;
            font-weight: 300;
        }

        .add-btn:active {
            transform: scale(0.95);
            background-color: #f5f5f5;
        }

        .persona-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .persona-empty {
            text-align: center;
            padding: 60px 20px;
        }

        .persona-item {
            background: #ffffff;
            border: 2px solid #e5e5e5;
            border-radius: 16px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .persona-item:active {
            background: #f8f8f8;
            transform: scale(0.98);
        }

        .persona-item-avatar {
            width: 50px;
            height: 50px;
            background-color: #d0d0d0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #666666;
            flex-shrink: 0;
            overflow: hidden;
        }

        .persona-item-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .persona-item-info {
            flex: 1;
            min-width: 0;
        }

        .persona-item-name {
            font-size: 16px;
            font-weight: 500;
            color: #333333;
            margin-bottom: 4px;
        }

        .persona-item-desc {
            font-size: 12px;
            color: #999999;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .persona-item-arrow {
            font-size: 20px;
            color: #999999;
            font-weight: 300;
        }

        .persona-avatar-preview {
            width: 120px;
            height: 120px;
            background-color: #d0d0d0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #666666;
            margin: 0 auto;
            overflow: hidden;
            border: 3px solid #e5e5e5;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .persona-avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* 删除按钮样式 */
        .delete-btn {
            padding: 8px 16px;
            background-color: #ffffff;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333333;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.2s;
            font-weight: 400;
        }

        .delete-btn:active {
            transform: scale(0.95);
            background-color: #f5f5f5;
        }

        /* 编辑模式下的人设项 */
        .persona-item.edit-mode {
            padding-left: 50px;
            position: relative;
        }

        .persona-checkbox {
            position: absolute;
            left: 15px;
            width: 24px;
            height: 24px;
            border: 2px solid #d0d0d0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .persona-checkbox.checked {
            background-color: #007bff;
            border-color: #007bff;
        }

        .persona-checkbox.checked::after {
            content: '✓';
            color: #ffffff;
            font-size: 16px;
            font-weight: bold;
        }

        /* 底部操作栏 */
        .persona-bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #ffffff;
            border-top: 1px solid #e5e5e5;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            z-index: 1001;
        }

        .persona-bar-btn {
            padding: 10px 20px;
            background-color: #f5f5f5;
            border: 1px solid #d0d0d0;
            border-radius: 20px;
            font-size: 14px;
            color: #333333;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 400;
        }

        .persona-bar-btn:active {
            transform: scale(0.95);
            background-color: #e5e5e5;
        }

        .persona-bar-btn.delete-action {
            background-color: #ffffff;
            color: #dc3545;
            border-color: #dc3545;
        }

        .persona-bar-btn.delete-action:active {
            background-color: #fff5f5;
        }

        .persona-selected-count {
            font-size: 14px;
            color: #666666;
        }

        .persona-selected-count span {
            font-weight: 600;
            color: #007bff;
        }

        /* SillyTavern 导入样式 */
        .import-persona-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 80px;
        }

        .import-persona-item {
            background: #ffffff;
            border: 2px solid #e5e5e5;
            border-radius: 16px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .import-persona-item:active {
            transform: scale(0.98);
        }

        .import-persona-item.selected {
            border-color: #007bff;
            background: #f0f8ff;
        }

        .import-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #d0d0d0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .import-persona-item.selected .import-checkbox {
            background-color: #007bff;
            border-color: #007bff;
        }

        .import-persona-item.selected .import-checkbox::after {
            content: '✓';
            color: #ffffff;
            font-size: 16px;
            font-weight: bold;
        }

        .import-persona-info {
            flex: 1;
            min-width: 0;
        }

        .import-persona-name {
            font-size: 16px;
            font-weight: 500;
            color: #333333;
            margin-bottom: 4px;
        }

        .import-persona-desc {
            font-size: 12px;
            color: #999999;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* 新增聊天角色样式 */
        .chat-character-avatar-preview {
            width: 100px;
            height: 100px;
            background-color: #d0d0d0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #666666;
            margin: 0 auto;
            overflow: hidden;
            border: 3px solid #e5e5e5;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .chat-character-avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* 聊天界面样式 */
        .chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #e5e5e5;
        }

        .chat-header-back {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #666;
            cursor: pointer;
            border-radius: 50%;
            background: #f5f5f5;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .chat-header-back:hover {
            background: #ebebeb;
            transform: scale(1.05);
        }

        .chat-header-back:active {
            background: #e0e0e0;
            transform: scale(0.95);
        }

        .chat-header-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.2s;
        }

        .chat-header-title-text {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            letter-spacing: 0.5px;
        }

        .chat-header-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .chat-header-avatar:active {
            transform: scale(0.95);
        }

        .chat-header-avatar span {
            font-size: 11px;
            color: #666;
            font-weight: 500;
        }

        .chat-header-add {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            border-radius: 50%;
            background: #f5f5f5;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .chat-header-add:hover {
            background: #ebebeb;
            transform: scale(1.05);
        }

        .chat-header-add:active {
            background: #e0e0e0;
            transform: scale(0.95);
        }

        .chat-search-container {
            padding: 10px 15px;
            background: white;
            border-bottom: 1px solid #e5e5e5;
        }

        .chat-search-box {
            display: flex;
            align-items: center;
            background: #f5f5f5;
            border-radius: 18px;
            padding: 10px 16px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04), inset 0 1px 2px rgba(0, 0, 0, 0.03);
            transition: all 0.2s;
        }

        .chat-search-box:hover {
            background: #f0f0f0;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.06), inset 0 1px 2px rgba(0, 0, 0, 0.04);
        }

        .chat-search-box:focus-within {
            background: #ebebeb;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08), inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .chat-search-input {
            flex: 1;
            border: none;
            background: transparent;
            outline: none;
            font-size: 15px;
            color: #333;
        }

        .chat-search-input::placeholder {
            color: #999;
        }

        .chat-list-container {
            flex: 1;
            overflow-y: auto;
            background: white;
            height: calc(100vh - 250px);
        }

        .chat-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 40px 20px;
        }

        .chat-empty-text {
            font-size: 16px;
            color: #999;
        }

        /* 聊天列表样式 */
        .chat-list-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px 20px;
        }

        .chat-list-item {
            background: #ffffff;
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .chat-list-item:active {
            transform: scale(0.98);
            background: #f8f8f8;
        }

        .chat-list-item-pinned {
            background: #f9f9f9;
        }

        .chat-list-avatar {
            width: 50px;
            height: 50px;
            background-color: #d0d0d0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #666666;
            flex-shrink: 0;
            overflow: hidden;
        }

        .chat-list-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chat-list-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .chat-list-name {
            font-size: 16px;
            font-weight: 500;
            color: #333333;
        }

        .chat-list-message {
            font-size: 13px;
            color: #999999;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .chat-list-time {
            font-size: 12px;
            color: #999999;
            flex-shrink: 0;
            align-self: flex-start;
        }

        .chat-list-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
            flex-shrink: 0;
            align-self: center;
        }

        .chat-list-badge {
            background: #FF3B30;
            color: #fff;
            font-size: 11px;
            font-weight: 600;
            min-width: 18px;
            height: 18px;
            line-height: 18px;
            text-align: center;
            border-radius: 9px;
            padding: 0 5px;
            box-sizing: border-box;
        }

        /* 聊天详情界面样式 */
        .chat-detail-page {
            background: #f5f5f5;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: 10000;
            overflow-x: hidden;
        }

        .chat-detail-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        .chat-detail-header {
            background: transparent;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 8px 16px;
            padding-top: max(8px, env(safe-area-inset-top));
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 0.5px solid #e5e5e5;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .chat-detail-back {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chat-detail-back:active {
            opacity: 0.7;
        }

        .chat-detail-info {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .chat-detail-name {
            font-size: 16px;
            font-weight: 700;
            color: #000000;
        }

        .chat-detail-settings {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chat-detail-settings:active {
            opacity: 0.6;
        }

        /* 聊天消息区域 */
        .chat-messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
        }

        .chat-empty-message {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* iOS风格消息气泡 */
        .chat-message {
            display: flex;
            margin-bottom: 20px;
            align-items: flex-start;
        }

        .chat-message-user {
            flex-direction: row-reverse;
        }

        .chat-message-avatar {
            width: 40px;
            height: 40px;
            flex-shrink: 0;
            margin: 0 16px;
        }
        
        .chat-message-user .chat-message-avatar {
            margin: 0 16px;
        }

        .chat-avatar-img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .chat-avatar-placeholder {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: #e5e5e5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #666;
            font-weight: 500;
        }

        .chat-message-content {
            display: flex;
            flex-direction: column;
            max-width: 65%;
        }

        .chat-message-user .chat-message-content {
            align-items: flex-end;
        }

        .chat-message-char .chat-message-content {
            align-items: flex-start;
        }

        .chat-message-bubble {
            padding: 8px 13px;
            border-radius: 20px;
            word-wrap: break-word;
            word-break: break-word;
            line-height: 1.35;
            font-size: 13px;
            max-width: 100%;
            position: relative;
        }

        .chat-message-user .chat-message-bubble {
            background: #007AFF;
            color: #ffffff;
            border-bottom-right-radius: 2px;
        }

        .chat-message-char .chat-message-bubble {
            background: #E5E5EA;
            color: #000000;
            border-bottom-left-radius: 2px;
        }

        /* 气泡形状样式覆盖 */
        /* 方案1：圆角气泡（默认） */
        .bubble-shape-1 .chat-message-user .chat-message-bubble {
            border-radius: 18px !important;
            border-bottom-right-radius: 4px !important;
        }
        .bubble-shape-1 .chat-message-char .chat-message-bubble {
            border-radius: 18px !important;
            border-bottom-left-radius: 4px !important;
        }

        /* 方案2：全圆角（胶囊） */
        .bubble-shape-2 .chat-message-user .chat-message-bubble,
        .bubble-shape-2 .chat-message-char .chat-message-bubble {
            border-radius: 20px !important;
        }
        .bubble-shape-2 .chat-message-user .chat-message-bubble::after,
        .bubble-shape-2 .chat-message-char .chat-message-bubble::after {
            display: none !important;
        }

        /* 方案3：直角矩形 */
        .bubble-shape-3 .chat-message-user .chat-message-bubble,
        .bubble-shape-3 .chat-message-char .chat-message-bubble {
            border-radius: 4px !important;
        }
        .bubble-shape-3 .chat-message-user .chat-message-bubble::after,
        .bubble-shape-3 .chat-message-char .chat-message-bubble::after {
            display: none !important;
        }

        /* 方案4：大圆角无尾巴 */
        .bubble-shape-4 .chat-message-user .chat-message-bubble,
        .bubble-shape-4 .chat-message-char .chat-message-bubble {
            border-radius: 16px !important;
        }
        .bubble-shape-4 .chat-message-user .chat-message-bubble::after,
        .bubble-shape-4 .chat-message-char .chat-message-bubble::after {
            display: none !important;
        }

        /* 方案5：不规则圆角（iOS拟态） */
        .bubble-shape-5 .chat-message-user .chat-message-bubble {
            border-radius: 18px 18px 4px 18px !important;
        }
        .bubble-shape-5 .chat-message-char .chat-message-bubble {
            border-radius: 18px 18px 18px 4px !important;
        }
        .bubble-shape-5 .chat-message-user .chat-message-bubble::after,
        .bubble-shape-5 .chat-message-char .chat-message-bubble::after {
            display: none !important;
        }

        /* 方案6：扁平方形带边框 */
        .bubble-shape-6 .chat-message-user .chat-message-bubble {
            border-radius: 8px !important;
            border: 1.5px solid #0066cc !important;
        }
        .bubble-shape-6 .chat-message-char .chat-message-bubble {
            border-radius: 8px !important;
            border: 1.5px solid #d0d0d0 !important;
        }
        .bubble-shape-6 .chat-message-user .chat-message-bubble::after,
        .bubble-shape-6 .chat-message-char .chat-message-bubble::after {
            display: none !important;
        }

        /* 方案7：气泡形（对话框） */
        .bubble-shape-7 .chat-message-user .chat-message-bubble {
            border-radius: 20px 20px 4px 20px !important;
        }
        .bubble-shape-7 .chat-message-char .chat-message-bubble {
            border-radius: 20px 20px 20px 4px !important;
        }

        /* 方案8：卡片式带阴影 */
        .bubble-shape-8 .chat-message-user .chat-message-bubble {
            border-radius: 12px !important;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.2) !important;
        }
        .bubble-shape-8 .chat-message-char .chat-message-bubble {
            border-radius: 12px !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
        }
        .bubble-shape-8 .chat-message-user .chat-message-bubble::after,
        .bubble-shape-8 .chat-message-char .chat-message-bubble::after {
            display: none !important;
        }

        /* 气泡尾巴 - 用户（SVG背景法，透明友好） */
        .chat-message-user .chat-message-bubble::after {
            content: '';
            position: absolute;
            bottom: -1px;
            right: -8px;
            width: 14px;
            height: 18px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='18'%3E%3Cpath d='M0 0 C0 8 2 14 6 17 C9 18 14 18 14 18 C8 18 4 14 2 9 C0.5 5 0 2 0 0Z' fill='%23007AFF'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
        }

        /* 气泡尾巴 - 角色（SVG背景法，透明友好） */
        .chat-message-char .chat-message-bubble::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: -8px;
            width: 14px;
            height: 18px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='18'%3E%3Cpath d='M14 0 C14 8 12 14 8 17 C5 18 0 18 0 18 C6 18 10 14 12 9 C13.5 5 14 2 14 0Z' fill='%23E5E5EA'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
        }

        .chat-message-time {
            font-size: 11px;
            color: #999999;
            margin-top: 4px;
            padding: 0 2px;
            text-align: center;
            white-space: nowrap;
        }

        /* 语音消息气泡 */
        .chat-voice-bubble {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            border-radius: 20px;
            position: relative;
            cursor: pointer;
            min-width: 80px;
            user-select: none;
        }

        .chat-message-user .chat-voice-bubble {
            background: #007AFF;
            border-bottom-right-radius: 2px;
            flex-direction: row-reverse;
        }

        .chat-message-char .chat-voice-bubble {
            background: #E5E5EA;
            border-bottom-left-radius: 2px;
        }

        .chat-message-user .chat-voice-bubble::before {
            content: '';
            position: absolute;
            z-index: -1;
            bottom: 0;
            right: -7px;
            height: 16px;
            width: 16px;
            background: #007AFF;
            border-bottom-left-radius: 12px;
        }

        .chat-message-user .chat-voice-bubble::after {
            content: '';
            position: absolute;
            z-index: 1;
            bottom: 0;
            right: -7px;
            width: 8px;
            height: 16px;
            background: #f5f5f5;
            border-bottom-left-radius: 8px;
        }

        .chat-message-char .chat-voice-bubble::before {
            content: '';
            position: absolute;
            z-index: -1;
            bottom: 0;
            left: -7px;
            height: 16px;
            width: 16px;
            background: #E5E5EA;
            border-bottom-right-radius: 12px;
        }

        .chat-message-char .chat-voice-bubble::after {
            content: '';
            position: absolute;
            z-index: 1;
            bottom: 0;
            left: -7px;
            width: 8px;
            height: 16px;
            background: #f5f5f5;
            border-bottom-right-radius: 8px;
        }

        .voice-wave-icon {
            display: flex;
            align-items: center;
            gap: 2px;
            height: 18px;
        }

        .voice-wave-icon .bar {
            width: 3px;
            border-radius: 2px;
            animation: voiceWave 1.2s ease-in-out infinite;
        }

        .chat-message-user .voice-wave-icon .bar {
            background: rgba(255,255,255,0.85);
        }

        .chat-message-char .voice-wave-icon .bar {
            background: rgba(0,0,0,0.45);
        }

        .voice-wave-icon .bar:nth-child(1) { height: 6px; animation-delay: 0s; }
        .voice-wave-icon .bar:nth-child(2) { height: 12px; animation-delay: 0.15s; }
        .voice-wave-icon .bar:nth-child(3) { height: 18px; animation-delay: 0.3s; }
        .voice-wave-icon .bar:nth-child(4) { height: 12px; animation-delay: 0.15s; }
        .voice-wave-icon .bar:nth-child(5) { height: 6px; animation-delay: 0s; }

        @keyframes voiceWave {
            0%, 100% { transform: scaleY(0.4); }
            50% { transform: scaleY(1); }
        }

        .voice-duration {
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
        }

        .chat-message-user .voice-duration {
            color: rgba(255,255,255,0.9);
        }

        .chat-message-char .voice-duration {
            color: rgba(0,0,0,0.55);
        }

        /* 语音转文字展开区域 */
        .voice-text-reveal {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            font-size: 13px;
            color: #333;
            padding: 0 4px;
            line-height: 1.5;
            transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
        }
        .voice-text-reveal.show {
            max-height: 200px;
            opacity: 1;
            padding: 6px 4px;
        }
        .chat-message-user .voice-text-reveal {
            text-align: right;
        }

        /* 聊天图片消息 */
        .chat-image-bubble {
            max-width: 200px;
            border-radius: 12px;
            overflow: hidden;
        }
        .chat-image-msg {
            width: 100%;
            display: block;
            border-radius: 12px;
            cursor: pointer;
        }
        /* 图片全屏预览 */
        .chat-image-preview-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.25s;
        }
        .chat-image-preview-overlay.show {
            opacity: 1;
        }
        .chat-image-preview-img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
            object-fit: contain;
        }

        /* 图文消息气泡（手动描述图片） */
        .chat-text-image-bubble {
            width: 180px;
            height: 180px;
            border-radius: 12px;
            background: #e5e5e5;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            position: relative;
            user-select: none;
            transition: background 0.2s;
        }
        .chat-text-image-bubble:active {
            background: #dcdcdc;
        }
        .chat-message-user .chat-text-image-bubble {
            border-bottom-right-radius: 2px;
        }
        .chat-message-char .chat-text-image-bubble {
            border-bottom-left-radius: 2px;
        }
        .text-image-desc {
            padding: 16px;
            font-size: 13px;
            color: #666;
            text-align: center;
            line-height: 1.5;
            word-break: break-word;
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 0.3s ease, transform 0.3s ease;
            max-height: 100%;
            overflow-y: auto;
        }
        .text-image-desc.show {
            opacity: 1;
            transform: scale(1);
        }

        /* 转账消息气泡 */
        .chat-transfer-bubble {
            width: 240px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }
        .chat-message-user .chat-transfer-bubble {
            border-bottom-right-radius: 2px;
        }
        .chat-message-char .chat-transfer-bubble {
            border-bottom-left-radius: 2px;
        }
        .chat-transfer-header {
            background: #f09b37;
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .chat-transfer-icon {
            width: 36px;
            height: 36px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .chat-transfer-icon svg {
            color: #fff;
        }
        .chat-transfer-currency-symbol {
            font-size: 20px;
            font-weight: 600;
            color: #fff;
            line-height: 1;
        }
        .chat-transfer-info {
            flex: 1;
            min-width: 0;
        }
        .chat-transfer-amount {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }
        .chat-transfer-remark {
            font-size: 12px;
            color: rgba(255,255,255,0.85);
            margin-top: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .chat-transfer-converted {
            font-size: 11px;
            color: rgba(255,255,255,0.75);
            margin-top: 4px;
            padding-top: 4px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }
        .chat-transfer-footer {
            background: #faf5ef;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .chat-transfer-label {
            font-size: 11px;
            color: #c08a3e;
        }
        .chat-transfer-status {
            font-size: 11px;
            color: #999;
        }

        /* 转账已处理状态（接收/拒绝后变浅橙色） */
        .chat-transfer-bubble.transfer-done .chat-transfer-header {
            background: #f0c68a;
        }
        .chat-transfer-bubble.transfer-done .chat-transfer-icon {
            background: rgba(255,255,255,0.18);
        }
        .chat-transfer-bubble.transfer-done .chat-transfer-footer {
            background: #faf2e6;
        }
        .chat-transfer-bubble.transfer-done .chat-transfer-label {
            color: #c9a46a;
        }

        /* 银行转账消息气泡 */
        .chat-bank-transfer-bubble {
            width: 260px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background: #fff;
            border-bottom-left-radius: 2px;
        }
        .chat-bank-transfer-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .chat-bank-transfer-icon {
            width: 38px;
            height: 38px;
            background: rgba(255,255,255,0.25);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .chat-bank-transfer-icon svg {
            color: #fff;
        }
        .chat-bank-transfer-info {
            flex: 1;
            min-width: 0;
        }
        .chat-bank-transfer-title {
            font-size: 13px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 3px;
        }
        .chat-bank-transfer-card {
            font-size: 11px;
            color: rgba(255,255,255,0.85);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .chat-bank-transfer-body {
            padding: 18px 16px;
            background: #fff;
            text-align: center;
        }
        .chat-bank-transfer-amount {
            font-size: 32px;
            font-weight: 700;
            color: #333;
            letter-spacing: -0.5px;
            margin-bottom: 6px;
        }
        .chat-bank-transfer-reason {
            font-size: 13px;
            color: #666;
            margin-top: 4px;
        }
        .chat-bank-transfer-footer {
            background: #f8f9fa;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chat-bank-transfer-status {
            font-size: 12px;
            color: #28a745;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* ========== 长按消息菜单 ========== */
        .msg-context-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10020;
            background: rgba(0,0,0,0.25);
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .msg-context-overlay.show {
            opacity: 1;
        }
        .msg-context-menu {
            position: fixed;
            z-index: 10021;
            background: #fff;
            border-radius: 14px;
            padding: 4px;
            min-width: 160px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.18), 0 2px 8px rgba(0,0,0,0.08);
            transform: scale(0.6);
            opacity: 0;
            transition: transform 0.22s cubic-bezier(0.34,1.56,0.64,1), opacity 0.15s ease;
            transform-origin: center top;
            overflow: hidden;
        }
        .msg-context-menu.show {
            transform: scale(1);
            opacity: 1;
        }
        .msg-context-menu.from-bottom {
            transform-origin: center bottom;
        }
        .msg-context-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            font-size: 15px;
            color: #333;
            cursor: pointer;
            transition: background 0.12s;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            border-radius: 10px;
        }
        .msg-context-item:active {
            background: #f2f2f7;
        }
        .msg-context-icon {
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .msg-context-icon svg {
            width: 18px;
            height: 18px;
        }
        .msg-context-item.destructive {
            color: #ff3b30;
        }
        .msg-context-item.destructive .msg-context-icon svg {
            stroke: #ff3b30;
        }
        /* 长按时消息高亮 */
        .chat-message.msg-highlight .chat-message-bubble,
        .chat-message.msg-highlight .chat-voice-bubble,
        .chat-message.msg-highlight .chat-image-bubble,
        .chat-message.msg-highlight .chat-text-image-bubble,
        .chat-message.msg-highlight .chat-transfer-bubble,
        .chat-message.msg-highlight .chat-sticker-bubble,
        .chat-message.msg-highlight .chat-location-bubble {
            box-shadow: 0 0 0 2px rgba(0,122,255,0.4);
        }

        /* 定位消息气泡 */
        .chat-location-bubble {
            width: 240px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            cursor: default;
        }
        .chat-message-user .chat-location-bubble {
            border-bottom-right-radius: 2px;
        }
        .chat-message-char .chat-location-bubble {
            border-bottom-left-radius: 2px;
        }
        .chat-location-map {
            background: #e8e8e8;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .chat-location-pin {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #e74c3c;
        }
        .chat-location-pin svg {
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2));
        }
        .chat-location-pin-dot {
            width: 6px;
            height: 6px;
            background: rgba(231,76,60,0.3);
            border-radius: 50%;
            margin-top: -2px;
        }
        .chat-location-body {
            background: #fff;
            padding: 10px 14px;
        }
        .chat-location-address {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            line-height: 1.4;
            word-break: break-all;
        }
        .chat-location-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 6px;
            flex-wrap: wrap;
        }
        .chat-location-coord {
            font-size: 11px;
            color: #999;
        }
        .chat-location-distance {
            font-size: 11px;
            color: #999;
        }
        .chat-location-footer {
            background: #f5f5f5;
            padding: 6px 14px;
            display: flex;
            align-items: center;
        }
        .chat-location-footer-label {
            font-size: 11px;
            color: #aaa;
        }

        /* ========== 多选删除模式 ========== */
        .msg-multiselect-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 600;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .msg-multiselect-bar .ms-cancel {
            font-size: 15px;
            color: #007AFF;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            -webkit-tap-highlight-color: transparent;
        }
        .msg-multiselect-bar .ms-cancel:active {
            background: #f0f0f0;
        }
        .msg-multiselect-bar .ms-title {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }
        .msg-multiselect-bar .ms-select-all {
            font-size: 15px;
            color: #007AFF;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            -webkit-tap-highlight-color: transparent;
        }
        .msg-multiselect-bar .ms-select-all:active {
            background: #f0f0f0;
        }
        .msg-multiselect-bottom {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 600;
            background: #fff;
            padding: 12px 20px;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
            box-shadow: 0 -2px 8px rgba(0,0,0,0.06);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        .msg-multiselect-bottom .ms-forward-btn {
            flex: 1;
            max-width: 160px;
            padding: 14px 0;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            color: #fff;
            background: #007aff;
            cursor: pointer;
            transition: opacity 0.15s, transform 0.1s;
            -webkit-tap-highlight-color: transparent;
        }
        .msg-multiselect-bottom .ms-forward-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .msg-multiselect-bottom .ms-forward-btn:active:not(:disabled) {
            opacity: 0.85;
            transform: scale(0.98);
        }
        .msg-multiselect-bottom .ms-delete-btn {
            flex: 1;
            max-width: 160px;
            padding: 14px 0;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            color: #fff;
            background: #ff3b30;
            cursor: pointer;
            transition: opacity 0.15s, transform 0.1s;
            -webkit-tap-highlight-color: transparent;
        }
        .msg-multiselect-bottom .ms-delete-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .msg-multiselect-bottom .ms-delete-btn:active:not(:disabled) {
            opacity: 0.85;
            transform: scale(0.98);
        }
        /* 多选模式下消息的勾选框 */
        .chat-message .msg-checkbox {
            display: none;
        }
        .multiselect-mode .chat-message .msg-checkbox {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border: 2px solid #d1d1d6;
            border-radius: 50%;
            flex-shrink: 0;
            margin: 0 4px;
            cursor: pointer;
            transition: all 0.15s;
            align-self: center;
        }
        .multiselect-mode .chat-message .msg-checkbox.checked {
            background: #007AFF;
            border-color: #007AFF;
        }
        .multiselect-mode .chat-message .msg-checkbox.checked::after {
            content: '';
            width: 6px;
            height: 10px;
            border: solid #fff;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
            margin-top: -2px;
        }
        /* 多选模式下隐藏输入栏，显示底部删除栏 */
        .multiselect-mode .chat-input-bar {
            display: none !important;
        }
        /* 多选模式下隐藏原始header */
        .multiselect-mode .chat-detail-header {
            display: none !important;
        }

        /* 转账弹窗 */
        .transfer-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.45);
            z-index: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }
        .transfer-modal {
            background: #fff;
            border-radius: 16px;
            width: 85%;
            max-width: 340px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(0,0,0,0.18);
            animation: slideUp 0.3s cubic-bezier(0.34,1.56,0.64,1);
        }
        .transfer-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 18px 10px;
        }
        .transfer-modal-title {
            font-size: 17px;
            font-weight: 600;
            color: #333;
        }
        .transfer-modal-close {
            font-size: 18px;
            color: #999;
            cursor: pointer;
            padding: 4px 8px;
        }
        .transfer-modal-body {
            padding: 0 18px 10px;
        }
        .transfer-amount-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .transfer-amount-btn {
            padding: 10px 0;
            border: 1.5px solid #e0e0e0;
            border-radius: 10px;
            background: #fff;
            font-size: 15px;
            font-weight: 500;
            color: #333;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s;
        }
        .transfer-amount-btn.active {
            border-color: #f09b37;
            background: #fef7ed;
            color: #e08a20;
        }
        .transfer-amount-btn:active {
            transform: scale(0.95);
        }
        .transfer-custom-input {
            width: 100%;
            padding: 10px 12px;
            border: 1.5px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            color: #333;
            outline: none;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        .transfer-custom-input:focus {
            border-color: #f09b37;
        }
        .transfer-modal-footer {
            display: flex;
            gap: 10px;
            padding: 10px 18px 18px;
        }

        /* 语音消息弹窗 */
        .voice-msg-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.45);
            z-index: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        .voice-msg-modal {
            background: #fff;
            border-radius: 16px;
            width: 85%;
            max-width: 340px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(0,0,0,0.18);
            animation: slideUp 0.3s cubic-bezier(0.34,1.56,0.64,1);
        }

        .voice-msg-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 18px 10px;
        }

        .voice-msg-title {
            font-size: 17px;
            font-weight: 600;
            color: #333;
        }

        .voice-msg-close {
            font-size: 18px;
            color: #999;
            cursor: pointer;
            padding: 4px 8px;
        }

        .voice-msg-body {
            padding: 0 18px 10px;
        }

        .voice-msg-footer {
            display: flex;
            gap: 10px;
            padding: 10px 18px 18px;
        }

        /* 正在输入中提示 - 复用 chat-message-char 结构，气泡形状/颜色/自定义CSS自动生效 */
        .typing-indicator-bubble {
            display: flex !important;
            align-items: center !important;
            gap: 4px !important;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #999999;
            border-radius: 50%;
            animation: typingAnimation 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingAnimation {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* 发送按钮禁用状态 */
        .chat-input-send.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* 聊天输入栏 */
        .chat-input-bar {
            background: #ffffff;
            padding: 8px 12px;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
            display: flex;
            align-items: center;
            gap: 10px;
            border-top: 0.5px solid #e5e5e5;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        .chat-input-voice,
        .chat-input-send {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666666;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 50%;
            flex-shrink: 0;
            background: #e5e5e5;
        }

        .chat-input-voice:active,
        .chat-input-send:active {
            opacity: 0.7;
        }

        .chat-input-send {
            color: #333333;
        }

        .chat-input-wrapper {
            flex: 1;
            min-width: 0;
            position: relative;
            display: flex;
            align-items: center;
            background: #f5f5f5;
            border: 1px solid #e5e5e5;
            border-radius: 20px;
            padding-right: 6px;
            overflow: hidden;
        }

        .chat-input-wrapper:focus-within {
            background: #ffffff;
            border-color: #007AFF;
        }

        .chat-input-field {
            flex: 1;
            min-width: 0;
            padding: 10px 12px;
            border: none;
            background: transparent;
            font-size: 15px;
            outline: none;
        }

        .chat-input-emoji,
        .chat-input-add {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999999;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .chat-input-emoji:active,
        .chat-input-add:active {
            background: rgba(0, 0, 0, 0.05);
        }

        /* 拓展功能面板 */
        .chat-extend-panel {
            display: none;
            background: #f7f7f7;
            border-top: 0.5px solid #e5e5e5;
            padding: 16px 0 8px;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
            overflow: hidden;
        }

        .chat-extend-panel.active {
            display: block;
        }

        .chat-extend-swiper {
            display: flex;
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            touch-action: pan-y;
            will-change: transform;
        }

        .chat-extend-page {
            min-width: 100%;
            flex-shrink: 0;
            padding: 0 12px;
            box-sizing: border-box;
        }

        .chat-extend-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px 8px;
        }

        .chat-extend-dots {
            display: flex;
            justify-content: center;
            gap: 6px;
            padding-top: 12px;
        }

        .chat-extend-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #d0d0d0;
            transition: background 0.3s, transform 0.3s;
        }

        .chat-extend-dot.active {
            background: #999;
            transform: scale(1.2);
        }

        .chat-extend-icon-placeholder {
            background: #f0f0f0 !important;
        }

        .chat-extend-item-placeholder {
            pointer-events: none;
        }

        .chat-extend-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .chat-extend-item:active .chat-extend-icon {
            transform: scale(0.92);
        }

        .chat-extend-icon {
            width: 52px;
            height: 52px;
            background: #ffffff;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333333;
            transition: transform 0.15s;
        }

        .chat-extend-label {
            font-size: 11px;
            color: #888888;
            text-align: center;
            line-height: 1.2;
        }

        /* 表情包面板 */
        .sticker-panel {
            display: none;
            background: #f7f7f7;
            border-top: 0.5px solid #e5e5e5;
            height: 260px;
            overflow: hidden;
            flex-direction: column;
        }

        .sticker-panel.active {
            display: flex;
        }

        .sticker-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px 6px;
            flex-shrink: 0;
        }

        .sticker-panel-title {
            font-size: 13px;
            color: #999;
        }

        .sticker-panel-manage {
            font-size: 12px;
            color: #007AFF;
            cursor: pointer;
        }

        .sticker-panel-manage:active {
            opacity: 0.6;
        }

        .sticker-delete-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 14px 6px;
            flex-shrink: 0;
        }

        .sticker-grid-item.selected .sticker-thumb {
            outline: 2px solid #007AFF;
            outline-offset: -2px;
        }

        .sticker-check-mark {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 18px;
            height: 18px;
            background: #007AFF;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sticker-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px 8px;
            padding: 6px 10px 16px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            flex: 1;
        }

        .sticker-grid-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }

        .sticker-grid-item:active .sticker-thumb {
            transform: scale(0.93);
        }

        .sticker-thumb {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s;
            position: relative;
        }

        .sticker-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .sticker-name {
            font-size: 10px;
            color: #999;
            text-align: center;
            max-width: 64px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .sticker-add-btn {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #ccc;
        }

        .sticker-add-btn:active {
            background: #f0f0f0;
        }

        /* 智能表情包推荐面板 */
        .sticker-suggestion-panel {
            background: #f7f7f7;
            border-top: 0.5px solid #e5e5e5;
            padding: 8px 10px;
            flex-shrink: 0;
        }

        .sticker-suggestion-scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .sticker-suggestion-scroll::-webkit-scrollbar {
            display: none;
        }

        .sticker-suggestion-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .sticker-suggestion-item:active .sticker-suggestion-thumb {
            transform: scale(0.93);
        }

        .sticker-suggestion-thumb {
            width: 52px;
            height: 52px;
            border-radius: 8px;
            overflow: hidden;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s;
        }

        .sticker-suggestion-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .sticker-suggestion-name {
            font-size: 10px;
            color: #999;
            text-align: center;
            max-width: 56px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* 表情包上传弹窗 */
        .sticker-upload-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .sticker-upload-overlay.active {
            display: flex;
        }

        .sticker-upload-box {
            background: #fff;
            border-radius: 14px;
            width: 300px;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .sticker-upload-header {
            text-align: center;
            padding: 18px 16px 12px;
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .sticker-upload-body {
            padding: 0 20px 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .sticker-upload-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 24px 16px;
            text-align: center;
            cursor: pointer;
            color: #999;
            font-size: 13px;
            transition: border-color 0.2s;
        }

        .sticker-upload-area:active {
            border-color: #007AFF;
        }

        .sticker-upload-area svg {
            display: block;
            margin: 0 auto 8px;
        }

        .sticker-url-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            box-sizing: border-box;
        }

        .sticker-url-input:focus {
            border-color: #007AFF;
        }

        .sticker-url-hint {
            font-size: 11px;
            color: #999;
            line-height: 1.4;
        }

        .sticker-upload-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            max-height: 120px;
            overflow-y: auto;
        }

        .sticker-upload-preview-item {
            width: 56px;
            height: 56px;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .sticker-upload-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .sticker-upload-preview-item .remove-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 18px;
            height: 18px;
            background: rgba(0,0,0,0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #fff;
            font-size: 10px;
            line-height: 1;
        }

        .sticker-upload-actions {
            display: flex;
            gap: 10px;
        }

        .sticker-upload-actions button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .sticker-btn-cancel {
            background: #f0f0f0;
            color: #666;
        }

        .sticker-btn-confirm {
            background: #007AFF;
            color: #fff;
        }

        .sticker-btn-cancel:active,
        .sticker-btn-confirm:active {
            opacity: 0.7;
        }

        /* 表情包上传分类选择 */
        .sticker-upload-category-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2px;
            margin-bottom: 10px;
        }
        .sticker-upload-category-label {
            font-size: 13px;
            color: #666;
            flex-shrink: 0;
        }
        .sticker-upload-category-select {
            flex: 1;
            max-width: 160px;
            margin-left: 10px;
            padding: 7px 10px;
            font-size: 13px;
            border: 1.5px solid #e0e0e0;
            border-radius: 8px;
            background: #f8f8f8;
            color: #333;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 12 12'%3E%3Cpath fill='%23999' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            padding-right: 24px;
        }
        .sticker-upload-category-select:focus {
            border-color: #007AFF;
        }

        /* 表情包命名弹窗 */
        .sticker-naming-overlay {
            display: none;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .sticker-naming-overlay.active {
            display: flex;
        }

        .sticker-naming-box {
            background: #fff;
            border-radius: 14px;
            width: 280px;
            overflow: hidden;
        }

        .sticker-naming-header {
            text-align: center;
            padding: 16px 16px 4px;
            font-size: 15px;
            font-weight: 600;
            color: #333;
        }

        .sticker-naming-counter {
            text-align: center;
            font-size: 12px;
            color: #999;
            padding: 2px 0 10px;
        }

        .sticker-naming-preview {
            width: 120px;
            height: 120px;
            margin: 0 auto;
            border-radius: 10px;
            overflow: hidden;
            background: #f5f5f5;
        }

        .sticker-naming-preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .sticker-naming-input {
            display: block;
            width: calc(100% - 40px);
            margin: 14px auto 0;
            padding: 10px 12px;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            font-size: 15px;
            text-align: center;
            outline: none;
            box-sizing: border-box;
        }

        .sticker-naming-input:focus {
            border-color: #007AFF;
        }

        .sticker-naming-actions {
            display: flex;
            margin-top: 16px;
            border-top: 0.5px solid #e5e5e5;
        }

        .sticker-naming-actions button {
            flex: 1;
            padding: 13px;
            border: none;
            background: none;
            font-size: 15px;
            cursor: pointer;
        }

        .sticker-naming-actions button:first-child {
            color: #999;
            border-right: 0.5px solid #e5e5e5;
        }

        .sticker-naming-actions button:last-child {
            color: #007AFF;
            font-weight: 600;
        }

        .sticker-naming-actions button:active {
            background: #f5f5f5;
        }

        /* 表情包分类相关样式 */
        .sticker-category-bar {
            display: flex;
            gap: 6px;
            padding: 4px 14px 6px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            flex-shrink: 0;
        }
        .sticker-category-bar::-webkit-scrollbar { display: none; }
        .sticker-category-tag {
            padding: 4px 12px;
            border-radius: 14px;
            font-size: 11px;
            color: #666;
            background: #eee;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .sticker-category-tag:active { opacity: 0.7; }
        .sticker-category-tag.active {
            background: #333;
            color: #fff;
        }
        .sticker-category-page {
            display: none;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #f7f7f7;
            z-index: 100;
            flex-direction: column;
            overflow-y: auto;
        }
        .sticker-category-page.active { display: flex; }
        .sticker-category-page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: #fff;
            border-bottom: 0.5px solid #e5e5e5;
            flex-shrink: 0;
        }
        .sticker-category-direction {
            display: flex;
            gap: 12px;
            padding: 20px 16px;
        }
        .sticker-category-direction-item {
            flex: 1;
            background: #fff;
            border-radius: 12px;
            padding: 20px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            gap: 6px;
            align-items: center;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }
        .sticker-category-direction-item:active { transform: scale(0.97); }
        .sticker-category-manage { flex: 1; }
        .sticker-category-list {
            padding: 0 16px;
        }
        .sticker-category-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 14px;
            background: #fff;
            border-radius: 10px;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }
        .sticker-category-item-name {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }
        .sticker-category-item-count {
            font-size: 11px;
            color: #999;
            margin-left: 6px;
        }
        .sticker-category-item-actions {
            display: flex;
            gap: 10px;
        }
        .sticker-category-item-actions span {
            font-size: 12px;
            cursor: pointer;
        }
        .sticker-category-select {
            padding: 6px 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 13px;
            color: #333;
            background: #fff;
            outline: none;
            flex: 1;
            min-width: 0;
        }
        .sticker-category-select:focus { border-color: #007AFF; }
        .sticker-category-transfer-btn {
            padding: 6px 14px;
            background: #333;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            flex-shrink: 0;
        }
        .sticker-category-transfer-btn:active { opacity: 0.7; }
        .sticker-assign-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
        .sticker-assign-item {
            position: relative;
            cursor: pointer;
        }
        .sticker-assign-item .sticker-thumb {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sticker-assign-item .sticker-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .sticker-assign-item.selected .sticker-thumb {
            outline: 2px solid #007AFF;
            outline-offset: -2px;
        }
        .sticker-assign-item .sticker-assign-check {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 16px;
            height: 16px;
            background: #007AFF;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sticker-assign-item .sticker-cat-label {
            font-size: 9px;
            color: #999;
            text-align: center;
            margin-top: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* 聊天设置界面样式 */
        .chat-settings-avatar-preview {
            width: 80px;
            height: 80px;
            background-color: #f0f0f0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #999999;
            overflow: hidden;
            border: 2px solid #e5e5e5;
        }

        .chat-settings-avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-upload-container {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .avatar-upload-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .avatar-btn {
            padding: 8px 20px;
            background: #ffffff;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            font-size: 14px;
            color: #333333;
            cursor: pointer;
            transition: all 0.2s;
        }

        .avatar-btn:hover {
            background: #f8f8f8;
            border-color: #007AFF;
        }

        .avatar-btn:active {
            background: #e8e8e8;
        }

        /* 新的头像上传布局 */
        .avatar-upload-container-new {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .avatar-upload-buttons-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            width: 100%;
        }

        .avatar-btn-grid {
            padding: 10px 16px;
            background: #f5f5f5;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            color: #333333;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .avatar-btn-grid:hover {
            background: #e8e8e8;
        }

        .avatar-btn-grid:active {
            background: #d8d8d8;
            transform: scale(0.98);
        }

        .save-btn {
            padding: 6px 16px;
            background: #333333;
            color: #ffffff;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .save-btn:hover {
            background: #1a1a1a;
        }

        .save-btn:active {
            transform: scale(0.95);
        }

        .chat-bottom-nav {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 0;
            background: white;
            border-top: 1px solid #e5e5e5;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
        }

        .chat-nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chat-nav-item:active {
            background: #f5f5f5;
        }

        .chat-nav-text {
            font-size: 13px;
            color: #999;
            transition: color 0.2s;
            font-weight: 500;
        }

        .chat-nav-item.active .chat-nav-text {
            color: #333;
            font-weight: 600;
        }

        /* 聊天列表项样式 */
        .chat-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .chat-item:active {
            background: #f5f5f5;
        }

        .chat-item-avatar {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            background: #f5f5f5;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .chat-item-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chat-item-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 0;
        }

        .chat-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .chat-item-name {
            font-size: 16px;
            color: #333;
            font-weight: 500;
        }

        .chat-item-time {
            font-size: 12px;
            color: #999;
        }

        .chat-item-message {
            font-size: 14px;
            color: #999;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>

    <!-- 世界书编辑弹窗 -->
    <div class="settings-page" id="worldBookEditModal" style="z-index: 2000;">
        <div class="settings-content" style="max-width: 500px;">
            <div class="settings-header">
                <div class="back-btn" onclick="closeWorldBookEdit()">←</div>
                <div class="settings-title">创建世界书</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <!-- 世界书名字 -->
                <div class="section-title">
                    <span class="section-title-text">基本信息</span>
                </div>
                
                <div class="form-group">
                    <label class="form-label">世界书名字</label>
                    <input type="text" class="form-input" id="worldBookName" placeholder="请输入世界书名字" maxlength="50">
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        最多50个字符
                    </div>
                </div>

                <!-- 世界书内容（条目管理） -->
                <div class="form-group" id="worldBookEntriesSection">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <label class="form-label" style="margin-bottom: 0;">世界书条目</label>
                        <button class="param-reset-btn" onclick="addWorldBookEntry()" style="color: #28a745; background: rgba(40,167,69,0.08); border-color: rgba(40,167,69,0.2);">+ 添加条目</button>
                    </div>
                    <div id="worldBookEntriesContainer">
                        <div style="text-align: center; color: #999; padding: 30px 0; font-size: 13px;">
                            暂无条目，点击上方"添加条目"开始创建
                        </div>
                    </div>
                </div>

                <!-- 隐藏的旧文本框，用于兼容 -->
                <textarea class="form-input" id="worldBookContentInput" style="display:none;" rows="6"></textarea>

                <!-- 全局世界书开关 -->
                <div class="section-title" style="margin-top: 30px;">
                    <span class="section-title-text">高级设置</span>
                </div>

                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <label class="form-label" style="margin-bottom: 4px;">全局世界书</label>
                            <div style="font-size: 12px; color: #999;">开启后此世界书将在所有对话中生效</div>
                        </div>
                        <label class="ios-switch">
                            <input type="checkbox" id="worldBookGlobal">
                            <span class="ios-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- 注入位置 -->
                <div class="form-group">
                    <label class="form-label">注入位置</label>
                    <select class="form-select" id="worldBookPosition">
                        <option value="before">前 - 在提示词之前注入</option>
                        <option value="middle" selected>中 - 在提示词中间注入</option>
                        <option value="after">后 - 在提示词之后注入</option>
                    </select>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        选择世界书内容在提示词中的注入位置
                    </div>
                </div>

                <!-- 分组 -->
                <div class="form-group">
                    <label class="form-label">分组</label>
                    <select class="form-select" id="worldBookGroup">
                        <option value="默认">默认</option>
                    </select>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        选择世界书所属的分组
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button class="btn-primary" onclick="closeWorldBookEdit()" style="flex: 1; background: #6c757d; color: white; border: none;">
                        取消
                    </button>
                    <button class="btn-primary btn-save" onclick="saveWorldBook()" style="flex: 1;">
                        保存世界书
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 世界书删除弹窗 -->
    <div class="settings-page" id="worldBookDeleteModal" style="z-index: 2100;">
        <div class="settings-content" style="max-width: 400px;">
            <div class="settings-header">
                <div class="back-btn" onclick="closeWorldBookDeleteModal()">←</div>
                <div class="settings-title">删除世界书</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <div class="section-title">
                    <span class="section-title-text">选择要删除的世界书</span>
                </div>
                
                <div class="form-group">
                    <div id="worldBookDeleteList" style="max-height: 400px; overflow-y: auto; border: 2px solid #e0e0e0; border-radius: 12px; padding: 10px;">
                        <div style="text-align: center; color: #999; padding: 30px;">暂无世界书</div>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        提示：勾选要删除的世界书
                    </div>
                </div>

                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
                    <button class="btn-primary" onclick="toggleSelectAllWorldBooks()" style="flex: 1;">全选/取消</button>
                    <button class="btn-primary" onclick="confirmDeleteWorldBooks()" style="flex: 1; background: #dc3545;">确认删除</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 失效音乐检查弹窗 -->
    <div class="settings-page" id="invalidMusicModal" style="z-index: 2200;">
        <div class="settings-content" style="max-width: 500px;">
            <div class="settings-header">
                <div class="back-btn" onclick="closeInvalidMusicModal()">←</div>
                <div class="settings-title">失效音乐检查</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <div class="section-title">
                    <span class="section-title-text">检查结果</span>
                </div>
                
                <div id="checkingProgress" style="display: none; text-align: center; padding: 30px;">
                    <div style="font-size: 16px; color: #007bff; margin-bottom: 10px;">正在检查...</div>
                    <div id="checkingStatus" style="font-size: 12px; color: #666;"></div>
                </div>

                <div id="invalidMusicResult" style="display: none;">
                    <div class="form-group">
                        <div id="invalidMusicList" style="max-height: 400px; overflow-y: auto; border: 2px solid #e0e0e0; border-radius: 12px; padding: 10px;">
                            <!-- 失效音乐列表 -->
                        </div>
                        <div style="margin-top: 8px; font-size: 12px; color: #666;">
                            勾选需要重新搜索的音乐
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
                        <button class="btn-primary" onclick="toggleSelectAllInvalid()" style="flex: 1;">全选/取消</button>
                        <button class="btn-primary" onclick="researchSelectedMusic()" style="flex: 1; background: #28a745;">重新搜索</button>
                    </div>
                </div>

                <div id="noInvalidMusic" style="display: none; text-align: center; padding: 30px;">
                    <div style="font-size: 16px; color: #28a745; margin-bottom: 10px;">✓ 全部正常</div>
                    <div style="font-size: 12px; color: #666;">所有音乐链接都可以正常播放</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 钱包界面 -->
    <div class="settings-page" id="walletPage">
        <div class="wallet-page-inner">
            <!-- 顶部栏 -->
            <div class="wallet-header">
                <div class="wallet-back-btn" onclick="closeWalletPage()">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
                </div>
                <div class="wallet-header-title">我的钱包</div>
                <div style="width:40px;"></div>
            </div>

            <!-- 余额卡片 -->
            <div class="wallet-balance-card">
                <div class="wallet-balance-label">账户余额(元)</div>
                <div class="wallet-balance-row">
                    <span class="wallet-balance-amount" id="walletBalanceAmount">0.00</span>
                    <span class="wallet-balance-eye" id="walletBalanceEye" onclick="toggleWalletBalance()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                    </span>
                </div>
                <div class="wallet-balance-actions">
                    <button class="wallet-balance-btn" onclick="walletRecharge()">充值</button>
                    <button class="wallet-balance-btn wallet-balance-btn-outline" onclick="walletWithdraw()">提现</button>
                </div>
                <div class="wallet-balance-actions" style="margin-top: 10px;">
                    <button class="wallet-balance-btn wallet-balance-btn-outline" onclick="walletDirectRecharge()">直接充值</button>
                    <button class="wallet-balance-btn wallet-balance-btn-outline" onclick="walletDirectModify()">直接修改</button>
                </div>
            </div>

            <!-- 快捷功能区 -->
            <div class="wallet-quick-grid">
                <div class="wallet-quick-item" onclick="openHuabei()">
                    <div class="wallet-quick-icon" style="background:#f0f5ff;color:#3b7ddd;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="5" width="20" height="14" rx="3"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
                    </div>
                    <div class="wallet-quick-name">花呗</div>
                    <div class="wallet-quick-desc">本月待还</div>
                </div>
                <div class="wallet-quick-item" onclick="openYuebao()">
                    <div class="wallet-quick-icon" style="background:#fff7ed;color:#e8910d;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                    </div>
                    <div class="wallet-quick-name">余额宝</div>
                    <div class="wallet-quick-desc">收益稳健</div>
                </div>
                <div class="wallet-quick-item" onclick="openBankCards()">
                    <div class="wallet-quick-icon" style="background:#f0fdf4;color:#22a06b;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="3"/><line x1="2" y1="9" x2="22" y2="9"/><line x1="6" y1="14" x2="10" y2="14"/></svg>
                    </div>
                    <div class="wallet-quick-name">银行卡</div>
                    <div class="wallet-quick-desc">管理卡片</div>
                </div>
                <div class="wallet-quick-item" onclick="openWalletBills()">
                    <div class="wallet-quick-icon" style="background:#fdf2f8;color:#d946a8;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="8" y1="13" x2="16" y2="13"/><line x1="8" y1="17" x2="13" y2="17"/></svg>
                    </div>
                    <div class="wallet-quick-name">账单</div>
                    <div class="wallet-quick-desc">收支明细</div>
                </div>
            </div>

            <!-- 花呗区域 -->
            <div class="wallet-section-card" id="walletHuabeiSection"></div>

            <!-- 余额宝区域 -->
            <div class="wallet-section-card" id="walletYuebaoSection"></div>

            <!-- 小荷包区域 -->
            <div class="wallet-section-card" id="walletXiaoheSection"></div>

            <!-- 银行卡区域 -->
            <div class="wallet-section-card">
                <div class="wallet-section-header">
                    <span class="wallet-section-title">银行卡</span>
                    <span class="wallet-section-more" onclick="openBankCards()">管理 ></span>
                </div>
                <div class="wallet-section-body" id="walletBankCardList"></div>
                <div class="wallet-add-card" onclick="addBankCard()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    <span>添加银行卡</span>
                </div>
            </div>

            <!-- 底部留白 -->
            <div style="height:40px;"></div>
        </div>
    </div>

    <!-- 世界书界面 -->
    <div class="settings-page" id="worldBookPage">
        <div class="settings-content" style="max-width: 100%; height: 100%; padding: 0;">
            <!-- 顶部栏 -->
            <div class="world-book-header">
                <div class="world-book-back" onclick="closeWorldBook()">←</div>
                <div class="world-book-title">世界书</div>
                <div class="world-book-buttons">
                    <div class="world-book-delete" onclick="openWorldBookDeleteModal()">删除</div>
                    <div class="world-book-add" onclick="addWorldBookItem()">+</div>
                </div>
            </div>

            <!-- 内容区域 -->
            <div class="world-book-content" id="worldBookContent">
                <div class="world-book-empty">
                    <div class="world-book-empty-text">暂无内容</div>
                </div>
            </div>

            <!-- 分组管理悬浮按钮 -->
            <div class="world-book-group-btn" onclick="openWorldBookGroupModal()" title="分组管理">
                分组
            </div>
        </div>
    </div>

    <!-- 分组管理弹窗 -->
    <div class="settings-page" id="worldBookGroupModal" style="z-index: 2200;">
        <div class="settings-content" style="max-width: 500px;">
            <div class="settings-header">
                <div class="back-btn" onclick="closeWorldBookGroupModal()">←</div>
                <div class="settings-title">分组管理</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <!-- 显示分组设置 -->
                <div class="section-title">
                    <span class="section-title-text">世界书显示设置</span>
                </div>
                
                <div class="form-group">
                    <label class="form-label">选择在世界书界面显示的分组</label>
                    <select class="form-select" id="worldBookGroupFilter" onchange="filterWorldBooksByGroup()">
                        <option value="all">全部分组</option>
                    </select>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        设置在世界书主界面显示哪个分组的内容
                    </div>
                </div>

                <!-- 创建分组 -->
                <div class="section-title" style="margin-top: 30px;">
                    <span class="section-title-text">创建新分组</span>
                </div>
                
                <div class="form-group">
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="form-input" id="newGroupName" placeholder="请输入分组名称" style="flex: 6;">
                        <button class="btn-primary" onclick="createNewGroup()" style="flex: 4;">创建</button>
                    </div>
                </div>

                <!-- 批量移动 -->
                <div class="section-title" style="margin-top: 30px;">
                    <span class="section-title-text">批量移动到分组</span>
                </div>
                
                <div class="form-group">
                    <label class="form-label">选择目标分组</label>
                    <select class="form-select" id="targetGroupSelect">
                        <option value="默认">默认</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">选择要移动的世界书</label>
                    <div id="worldBookMoveList" style="max-height: 300px; overflow-y: auto; border: 2px solid #e0e0e0; border-radius: 12px; padding: 10px;">
                        <div style="text-align: center; color: #999; padding: 30px;">暂无世界书</div>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        勾选需要移动的世界书条目
                    </div>
                </div>

                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
                    <button class="btn-primary" onclick="toggleSelectAllForMove()" style="flex: 1;">全选/取消</button>
                    <button class="btn-primary" onclick="confirmMoveToGroup()" style="flex: 1; background: #007bff;">确认移动</button>
                </div>

                <!-- 分组全局设置 -->
                <div class="section-title" style="margin-top: 30px;">
                    <span class="section-title-text">分组全局设置</span>
                </div>
                
                <div class="form-group">
                    <label class="form-label">设置整个分组为全局世界书</label>
                    <div id="groupGlobalList" style="max-height: 250px; overflow-y: auto; border: 2px solid #e0e0e0; border-radius: 12px; padding: 10px;">
                        <div style="text-align: center; color: #999; padding: 30px;">加载中...</div>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        开启后，该分组下的所有世界书都将成为全局世界书
                    </div>
                </div>

                <!-- 分组列表 -->
                <div class="section-title" style="margin-top: 30px;">
                    <span class="section-title-text">已有分组</span>
                </div>
                
                <div class="form-group">
                    <div id="groupsList" style="max-height: 200px; overflow-y: auto;">
                        <div style="text-align: center; color: #999; padding: 20px;">加载中...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* 世界书界面样式 */
        .world-book-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #e5e5e5;
        }

        .world-book-back {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #666;
            cursor: pointer;
            border-radius: 50%;
            background: #f5f5f5;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .world-book-back:hover {
            background: #ebebeb;
            transform: scale(1.05);
        }

        .world-book-back:active {
            background: #e0e0e0;
            transform: scale(0.95);
        }

        .world-book-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .world-book-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .world-book-delete {
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #dc3545;
            cursor: pointer;
            border-radius: 10px;
            background: #fff5f5;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(220, 53, 69, 0.1);
            font-weight: 500;
        }

        .world-book-delete:hover {
            background: #ffe5e5;
            transform: scale(1.05);
        }

        .world-book-delete:active {
            background: #ffd5d5;
            transform: scale(0.95);
        }

        .world-book-add {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            border-radius: 50%;
            background: #f5f5f5;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .world-book-add:hover {
            background: #ebebeb;
            transform: scale(1.05);
        }

        .world-book-add:active {
            background: #e0e0e0;
            transform: scale(0.95);
        }

        .world-book-content {
            flex: 1;
            overflow-y: auto;
            background: white;
            height: calc(100vh - 70px);
        }

        .world-book-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 40px 20px;
        }

        .world-book-empty-text {
            font-size: 16px;
            color: #999;
        }

        .world-book-group-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: #f5f5f5;
            color: #666;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            z-index: 1000;
        }

        .world-book-group-btn:hover {
            background: #e8e8e8;
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .world-book-group-btn:active {
            transform: scale(0.95);
        }
    </style>

    <!-- 人设管理界面 -->
    <div class="settings-page" id="personaManagement">
        <div class="settings-content">
            <div class="settings-header">
                <div class="back-btn" onclick="closePersonaManagement()">←</div>
                <div class="settings-title">人设管理</div>
                <div style="display: flex; gap: 10px;">
                    <div class="delete-btn" id="deletePersonaBtn" onclick="togglePersonaEditMode()">删除</div>
                    <div class="add-btn" onclick="openAddPersona()">+</div>
                </div>
            </div>

            <div class="settings-card">
                <div class="section-title">
                    <span class="section-title-text">我的人设库</span>
                </div>
                
                <!-- 人设列表 -->
                <div id="personaList" class="persona-list">
                    <div class="persona-empty">
                        <div style="color: #999; font-size: 14px;">暂无人设</div>
                        <div style="color: #ccc; font-size: 12px; margin-top: 5px;">点击右上角 + 添加人设</div>
                    </div>
                </div>
            </div>
            
            <!-- 底部操作栏 -->
            <div class="persona-bottom-bar" id="personaBottomBar" style="display: none;">
                <button class="persona-bar-btn" onclick="selectAllPersonas()">全选</button>
                <div class="persona-selected-count">已选 <span id="selectedPersonaCount">0</span> 项</div>
                <button class="persona-bar-btn delete-action" onclick="deleteSelectedPersonas()">删除选中</button>
            </div>
        </div>
    </div>

    <!-- 添加/编辑人设界面 -->
    <div class="settings-page" id="addPersonaPage" style="z-index: 2001;">
        <div class="settings-content">
            <div class="settings-header">
                <div class="back-btn" onclick="closeAddPersona()">←</div>
                <div class="settings-title" id="addPersonaTitle">添加人设</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <!-- 头像预览 -->
                <div style="text-align: center; margin-bottom: 30px;">
                    <div class="persona-avatar-preview" id="personaAvatarPreview">
                        <span id="personaAvatarPlaceholder">头像</span>
                        <img id="personaAvatarImage" style="display: none; width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                    </div>
                    <div style="margin-top: 15px; font-size: 12px; color: #999;">点击下方按钮上传头像</div>
                </div>

                <!-- 头像上传方式 -->
                <div class="section-title" style="margin-bottom: 20px;">
                    <span class="section-title-text">上传头像</span>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 30px;">
                    <button class="btn-primary" onclick="document.getElementById('personaAvatarInput').click()">
                        本地上传
                    </button>
                    <button class="btn-primary" onclick="showPersonaUrlInput()">
                        URL 上传
                    </button>
                </div>

                <input type="file" id="personaAvatarInput" accept="image/*" style="display: none;" onchange="handlePersonaAvatarUpload(event)">

                <!-- URL输入框（默认隐藏） -->
                <div id="personaUrlInputSection" style="display: none; margin-bottom: 30px;">
                    <div class="form-group">
                        <label class="form-label">图片URL地址</label>
                        <input type="url" class="form-input" id="personaAvatarUrl" placeholder="https://example.com/avatar.jpg">
                    </div>
                    <button class="btn-primary" onclick="loadPersonaAvatarFromUrl()" style="background: #007bff; color: white; border: none;">
                        加载图片
                    </button>
                </div>

                <!-- 人设名称 -->
                <div class="section-title" style="margin-top: 30px; margin-bottom: 20px;">
                    <span class="section-title-text">基本信息</span>
                </div>

                <div class="form-group">
                    <label class="form-label">人设名称</label>
                    <input type="text" class="form-input" id="personaNameInput" placeholder="请输入人设名称" maxlength="20">
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        最多20个字符
                    </div>
                </div>

                <!-- 人设描述 -->
                <div class="form-group">
                    <label class="form-label">人设描述</label>
                    <textarea class="form-input" id="personaDescInput" placeholder="请输入人设描述" rows="6" style="resize: vertical; min-height: 150px;"></textarea>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        详细描述人设的性格、特点、背景等信息
                    </div>
                </div>

                <!-- 展示为ID卡角色 -->
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background-color: #f8f8f8; border-radius: 12px; border: 1px solid #e5e5e5;">
                        <div>
                            <label class="form-label" style="margin-bottom: 4px; font-size: 14px; font-weight: 500;">展示为ID卡首个角色</label>
                            <div style="font-size: 12px; color: #999;">开启后，此人设的头像和名字将显示在主屏幕ID卡中</div>
                        </div>
                        <label class="ios-switch">
                            <input type="checkbox" id="personaAsIdCardToggle" onchange="markPersonaFormChanged()">
                            <span class="ios-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- 保存按钮 -->
                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button class="btn-primary" onclick="closeAddPersona()" style="flex: 1; background: #dc3545; color: white; border: none;">
                        取消
                    </button>
                    <button class="btn-primary btn-save" onclick="savePersona()" style="flex: 1;">
                        保存人设
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 聊天设置界面 -->
    <div class="settings-page" id="chatSettingsPage" style="display: none; z-index: 10001;">
        <div class="settings-content">
            <div class="settings-header">
                <div class="back-btn" onclick="closeChatSettingsPage()">←</div>
                <div class="settings-title">聊天设置</div>
                <div class="save-btn" onclick="saveChatSettings()">保存</div>
            </div>

            <!-- 标签页导航 -->
            <div class="chat-settings-tabs">
                <div class="chat-settings-tab active" onclick="switchChatSettingsTab('char')">角色</div>
                <div class="chat-settings-tab" onclick="switchChatSettingsTab('user')">用户</div>
                <div class="chat-settings-tab" onclick="switchChatSettingsTab('beautify')">美化</div>
                <div class="chat-settings-tab" onclick="switchChatSettingsTab('advanced')">高级</div>
            </div>

            <!-- 角色标签页 -->
            <div class="chat-settings-tab-content active" id="charTab">
            <div class="settings-card">
                <div class="section-title">
                    <span class="section-title-text">角色信息 (CHAR)</span>
                </div>
                
                <div class="form-group">
                    <label class="form-label">角色头像</label>
                    <div class="avatar-upload-container-new">
                        <div class="chat-settings-avatar-preview" id="charAvatarPreview">
                            <span id="charAvatarPlaceholder">头像</span>
                            <img id="charAvatarImage" style="display: none;">
                        </div>
                        <div class="avatar-upload-buttons-grid">
                            <input type="file" id="charAvatarFileInput" accept="image/*" style="display: none;" onchange="handleCharAvatarUpload(event)">
                            <button class="avatar-btn-grid" onclick="document.getElementById('charAvatarFileInput').click()">本地上传</button>
                            <button class="avatar-btn-grid" onclick="showCharAvatarUrlInput()">URL上传</button>
                            <button class="avatar-btn-grid" onclick="showCharAvatarLibrary()">头像库</button>
                            <button class="avatar-btn-grid" onclick="showCoupleAvatarLibrary()">情侣头像库</button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">真名</label>
                    <input type="text" id="charNameInput" class="form-input" placeholder="输入角色真名">
                </div>

                <div class="form-group">
                    <label class="form-label">备注</label>
                    <input type="text" id="charRemarkInput" class="form-input" placeholder="输入角色备注">
                </div>

                <div class="form-group">
                    <label class="form-label">人物描述</label>
                    <textarea id="charDescInput" class="form-textarea" rows="4" placeholder="输入角色的人物描述..."></textarea>
                </div>

                <!-- 国籍与货币设置 -->
                <div class="form-group" style="margin-top: 24px;">
                    <div class="section-title" style="margin-bottom: 16px;">
                        <span class="section-title-text">货币设置</span>
                    </div>
                    
                    <label class="form-label">角色国籍</label>
                    <select id="charNationalitySelect" class="form-input" style="cursor: pointer;">
                        <!-- 选项由JS动态生成 -->
                    </select>
                    <div style="font-size: 12px; color: #999; margin-top: 6px;">
                        角色转账时将使用对应国家的货币
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">汇率模式</label>
                    <select id="exchangeRateModeSelect" class="form-input" style="cursor: pointer;">
                        <option value="local">本地汇率（离线可用）</option>
                        <option value="realtime">实时汇率（需联网）</option>
                    </select>
                    <div style="font-size: 12px; color: #999; margin-top: 6px;">
                        实时汇率获取失败时会自动降级为本地汇率
                    </div>
                </div>

                <!-- 角色主动来电 -->
                <div class="form-group" style="margin-top: 24px;">
                    <div class="section-title" style="margin-bottom: 16px;">
                        <span class="section-title-text">视频通话</span>
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <div style="font-size: 15px; color: #333;">角色主动来电</div>
                            <div style="font-size: 12px; color: #999; margin-top: 4px;">开启后角色可以在聊天中主动给你打视频电话</div>
                        </div>
                        <label class="ios-switch">
                            <input type="checkbox" id="incomingCallToggle" checked>
                            <span class="ios-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- 拉黑开发者面板入口 -->
                <div class="form-group" style="margin-top: 24px;">
                    <div class="section-title" style="margin-bottom: 16px;">
                        <span class="section-title-text">拉黑管理</span>
                    </div>
                    <button class="btn-primary" onclick="openBlockDevPanel()" style="width:100%;background:#f8f8f8;color:#333;border:1px solid #e0e0e0;border-radius:12px;padding:14px 16px;font-size:15px;text-align:left;cursor:pointer;display:flex;justify-content:space-between;align-items:center;">
                        <span>🚫 拉黑开发者面板</span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                    </button>
                </div>
            </div>
            </div>

            <!-- 用户标签页 -->
            <div class="chat-settings-tab-content" id="userTab">
            <div class="settings-card">
                <div class="section-title">
                    <span class="section-title-text">用户信息 (USER)</span>
                </div>
                
                <div class="form-group">
                    <label class="form-label">用户头像</label>
                    <div class="avatar-upload-container-new">
                        <div class="chat-settings-avatar-preview" id="userAvatarPreview">
                            <span id="userAvatarPlaceholder">头像</span>
                            <img id="userAvatarImage" style="display: none;">
                        </div>
                        <div class="avatar-upload-buttons-grid">
                            <input type="file" id="userAvatarFileInput" accept="image/*" style="display: none;" onchange="handleUserAvatarUpload(event)">
                            <button class="avatar-btn-grid" onclick="document.getElementById('userAvatarFileInput').click()">本地上传</button>
                            <button class="avatar-btn-grid" onclick="showUserAvatarUrlInput()">URL上传</button>
                            <button class="avatar-btn-grid" onclick="showUserAvatarLibrary()">头像库</button>
                            <button class="avatar-btn-grid" onclick="showCoupleAvatarLibrary()">情侣头像库</button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">真名</label>
                    <input type="text" id="userNameInput" class="form-input" placeholder="输入用户真名">
                </div>

                <div class="form-group">
                    <label class="form-label">人物描述</label>
                    <textarea id="userDescInput" class="form-textarea" rows="4" placeholder="输入用户的人物描述..."></textarea>
                    
                    <!-- 选择人设按钮 -->
                    <button class="data-action-btn secondary-btn" onclick="showPersonaSelector()" style="margin-top: 12px;">
                        从人设库选择
                    </button>
                </div>

                <!-- 银行卡转账功能 -->
                <div class="form-group" style="margin-top: 30px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <div>
                            <div style="font-size: 15px; color: #333; font-weight: 500;">银行卡转账</div>
                            <div style="font-size: 12px; color: #999; margin-top: 4px;">角色可以直接给你的银行卡转账</div>
                        </div>
                        <label class="ios-switch">
                            <input type="checkbox" id="bankTransferToggle" onchange="toggleBankTransferFeature()">
                            <span class="ios-slider"></span>
                        </label>
                    </div>
                    
                    <!-- 银行卡选择区域（默认隐藏） -->
                    <div id="bankTransferCardSection" style="display: none; margin-top: 16px;">
                        <label class="form-label">接收银行卡</label>
                        
                        <!-- 未选择状态 -->
                        <div id="bankTransferNoCard" style="padding: 16px; background: #f8f8f8; border-radius: 12px; text-align: center;">
                            <div style="font-size: 13px; color: #999; margin-bottom: 12px;">请从钱包中选择一张银行卡</div>
                            <button class="btn-primary" onclick="openSelectBankCardForTransfer()" style="padding: 10px 24px; width: auto; margin: 0 auto;">
                                选择银行卡
                            </button>
                        </div>
                        
                        <!-- 已选择状态 -->
                        <div id="bankTransferSelectedCard" style="display: none; padding: 16px; background: #f8f8f8; border-radius: 12px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                <div style="font-weight: 600; color: #333; font-size: 15px;" id="selectedCardName">招商银行</div>
                                <button onclick="openSelectBankCardForTransfer()" style="padding: 4px 12px; font-size: 12px; color: #007bff; background: transparent; border: 1px solid #007bff; border-radius: 6px; cursor: pointer;">
                                    更换
                                </button>
                            </div>
                            <div style="font-size: 13px; color: #666; margin-bottom: 4px;" id="selectedCardNumber">**** **** **** 1234</div>
                            <div style="font-size: 12px; color: #999;" id="selectedCardBalance">余额: ¥0.00</div>
                        </div>
                        
                        <div style="margin-top: 12px; padding: 12px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffeaa7;">
                            <div style="font-size: 12px; color: #856404; line-height: 1.5;">
                                💡 提示：角色转账会直接到这张卡，你会收到银行短信通知，卡内余额会自动增加。
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- 美化标签页 -->
            <div class="chat-settings-tab-content" id="beautifyTab">
                <div class="settings-card">
                    <div class="section-title">
                        <span class="section-title-text">气泡样式</span>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 12px; background-color: #f8f9fa; border-radius: 10px; border: 1px solid #e9ecef;">
                        <div style="font-size: 12px; color: #666; line-height: 1.6;">
                            <div style="font-weight: 600; margin-bottom: 6px;">功能说明：</div>
                            <div>• 选择不同的气泡形状样式</div>
                            <div>• 点击按钮打开样式选择器</div>
                            <div>• 样式会实时应用到聊天界面</div>
                        </div>
                    </div>

                    <!-- 当前样式显示 -->
                    <div style="margin-bottom: 20px;">
                        <label class="form-label">当前气泡样式</label>
                        <div style="padding: 16px; background: #f8f8f8; border-radius: 12px; border: 2px solid #e0e0e0;">
                            <div style="font-size: 15px; font-weight: 600; color: #333; margin-bottom: 8px;" id="currentBubbleStyleName">方案1 - 圆角气泡</div>
                            <div style="font-size: 12px; color: #999;" id="currentBubbleStyleDesc">经典圆角矩形气泡，带小尾巴</div>
                        </div>
                    </div>

                    <!-- 选择按钮 -->
                    <button class="btn-primary" onclick="openBubbleStyleSelector()" style="width: 100%;">
                        选择气泡样式
                    </button>
                </div>

                <!-- 气泡颜色设置 -->
                <div class="settings-card">
                    <div class="section-title">
                        <span class="section-title-text">气泡颜色</span>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 12px; background-color: #f8f9fa; border-radius: 10px; border: 1px solid #e9ecef;">
                        <div style="font-size: 12px; color: #666; line-height: 1.6;">
                            <div style="font-weight: 600; margin-bottom: 6px;">功能说明：</div>
                            <div>• 选择预设颜色或自定义颜色</div>
                            <div>• 可保存自定义颜色为预设方案</div>
                            <div>• 支持管理和删除自定义方案</div>
                        </div>
                    </div>

                    <!-- 预设颜色 -->
                    <div style="margin-bottom: 20px;">
                        <label class="form-label">预设颜色</label>
                        <div id="presetColorGrid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                            <!-- 动态生成预设颜色按钮 -->
                        </div>
                    </div>

                    <!-- 自定义颜色 -->
                    <div style="margin-bottom: 20px;">
                        <label class="form-label">自定义颜色</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <label style="font-size: 11px; color: #999; margin-bottom: 4px; display: block;">用户消息</label>
                                <input type="color" id="userBubbleColorPicker" class="color-picker" value="#007aff">
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 11px; color: #999; margin-bottom: 4px; display: block;">AI消息</label>
                                <input type="color" id="aiBubbleColorPicker" class="color-picker" value="#e5e5ea">
                            </div>
                        </div>
                        <button class="btn-primary" onclick="applyCustomBubbleColor()" style="width: 100%; margin-bottom: 10px;">
                            应用自定义颜色
                        </button>
                    </div>

                    <!-- 保存自定义方案 -->
                    <div style="margin-bottom: 20px;">
                        <label class="form-label">保存为预设方案</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="customColorSchemeName" class="form-input" placeholder="输入方案名称" maxlength="20" style="flex: 1;">
                            <button class="btn-primary" onclick="saveCustomColorScheme()" style="width: 80px; padding: 12px;">
                                保存
                            </button>
                        </div>
                    </div>

                    <!-- 方案管理 -->
                    <div style="margin-bottom: 20px;">
                        <label class="form-label">方案管理</label>
                        <select id="colorSchemeSelect" class="form-select" onchange="loadColorScheme()" style="margin-bottom: 10px;">
                            <option value="">选择方案</option>
                        </select>
                        <button class="btn-primary" onclick="openDeleteColorSchemes()" style="width: 100%; background: #dc3545; color: white; border: none;">
                            删除方案
                        </button>
                    </div>
                </div>

                <!-- 气泡装饰设置 -->
                <div class="settings-card">
                    <div class="section-title">
                        <span class="section-title-text">气泡装饰</span>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 12px; background-color: #f8f9fa; border-radius: 10px; border: 1px solid #e9ecef;">
                        <div style="font-size: 12px; color: #666; line-height: 1.6;">
                            <div style="font-weight: 600; margin-bottom: 6px;">功能说明：</div>
                            <div>• 在气泡上添加装饰图片（支持GIF）</div>
                            <div>• 可调节位置、大小、透明度等</div>
                            <div>• 支持保存和管理装饰预设</div>
                        </div>
                    </div>

                    <!-- 启用开关 -->
                    <div style="margin-bottom: 20px;">
                        <label class="form-label">启用气泡装饰</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="bubbleDecorationToggle" onchange="toggleBubbleDecoration()">
                                <span class="toggle-slider"></span>
                            </label>
                            <span style="font-size: 13px; color: #666;">开启后装饰将显示在气泡上</span>
                        </div>
                    </div>

                    <!-- 图片导入 -->
                    <div style="margin-bottom: 20px;">
                        <label class="form-label">导入图片</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <button class="btn-primary" onclick="uploadBubbleDecorationImage()" style="flex: 1;">
                                本地上传
                            </button>
                            <button class="btn-primary" onclick="showBubbleDecorationUrlInput()" style="flex: 1;">
                                URL导入
                            </button>
                        </div>
                        
                        <!-- URL输入区域 -->
                        <div id="bubbleDecorationUrlSection" style="display: none; margin-top: 10px;">
                            <input type="text" id="bubbleDecorationUrlInput" class="form-input" placeholder="输入图片URL" style="margin-bottom: 10px;">
                            <button class="btn-primary" onclick="loadBubbleDecorationFromUrl()" style="width: 100%;">
                                加载图片
                            </button>
                        </div>

                        <!-- 图片预览 -->
                        <div style="margin-top: 15px; padding: 15px; background: #f8f8f8; border-radius: 12px; border: 2px dashed #d0d0d0; min-height: 120px; display: flex; align-items: center; justify-content: center;">
                            <div id="bubbleDecorationImagePlaceholder" style="text-align: center; color: #999;">
                                <div style="font-size: 12px;">未选择图片</div>
                            </div>
                            <img id="bubbleDecorationImagePreview" style="display: none; max-width: 100%; max-height: 100px; border-radius: 8px;">
                        </div>
                        
                        <button class="btn-primary" onclick="resetBubbleDecorationImage()" style="width: 100%; margin-top: 10px; background: #6c757d;">
                            重置图片
                        </button>
                    </div>

                    <!-- 位置选择 -->
                    <div style="margin-bottom: 20px;">
                        <label class="form-label">装饰位置</label>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px;">
                            <button class="bubble-decoration-position-btn" data-position="top-left" onclick="selectBubbleDecorationPosition('top-left')">↖ 左上</button>
                            <button class="bubble-decoration-position-btn" data-position="top" onclick="selectBubbleDecorationPosition('top')">↑ 上</button>
                            <button class="bubble-decoration-position-btn" data-position="top-right" onclick="selectBubbleDecorationPosition('top-right')">↗ 右上</button>
                            <button class="bubble-decoration-position-btn" data-position="left" onclick="selectBubbleDecorationPosition('left')">← 左</button>
                            <button class="bubble-decoration-position-btn" data-position="center" onclick="selectBubbleDecorationPosition('center')">● 中</button>
                            <button class="bubble-decoration-position-btn" data-position="right" onclick="selectBubbleDecorationPosition('right')">→ 右</button>
                            <button class="bubble-decoration-position-btn" data-position="bottom-left" onclick="selectBubbleDecorationPosition('bottom-left')">↙ 左下</button>
                            <button class="bubble-decoration-position-btn" data-position="bottom" onclick="selectBubbleDecorationPosition('bottom')">↓ 下</button>
                            <button class="bubble-decoration-position-btn" data-position="bottom-right" onclick="selectBubbleDecorationPosition('bottom-right')">↘ 右下</button>
                        </div>
                        
                        <!-- 微调 -->
                        <div style="margin-top: 15px;">
                            <label style="font-size: 11px; color: #999; margin-bottom: 8px; display: block;">位置微调</label>
                            <div style="display: flex; gap: 15px;">
                                <div style="flex: 1;">
                                    <label style="font-size: 11px; color: #999; margin-bottom: 4px; display: block;">X轴偏移: <span id="bubbleDecorationOffsetXValue">0</span>%</label>
                                    <input type="range" id="bubbleDecorationOffsetX" class="param-slider" min="-50" max="50" value="0" step="1" oninput="updateBubbleDecorationOffset()">
                                </div>
                                <div style="flex: 1;">
                                    <label style="font-size: 11px; color: #999; margin-bottom: 4px; display: block;">Y轴偏移: <span id="bubbleDecorationOffsetYValue">0</span>%</label>
                                    <input type="range" id="bubbleDecorationOffsetY" class="param-slider" min="-50" max="50" value="0" step="1" oninput="updateBubbleDecorationOffset()">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 大小调节 -->
                    <div style="margin-bottom: 20px;">
                        <label class="form-label">装饰大小: <span id="bubbleDecorationSizeValue">40</span>px</label>
                        <input type="range" id="bubbleDecorationSize" class="param-slider" min="20" max="100" value="40" step="5" oninput="updateBubbleDecorationSize()">
                    </div>

                    <!-- 透明度调节 -->
                    <div style="margin-bottom: 20px;">
                        <label class="form-label">透明度: <span id="bubbleDecorationOpacityValue">100</span>%</label>
                        <input type="range" id="bubbleDecorationOpacity" class="param-slider" min="0" max="100" value="100" step="5" oninput="updateBubbleDecorationOpacity()">
                    </div>

                    <!-- 旋转角度 -->
                    <div style="margin-bottom: 20px;">
                        <label class="form-label">旋转角度: <span id="bubbleDecorationRotationValue">0</span>°</label>
                        <input type="range" id="bubbleDecorationRotation" class="param-slider" min="0" max="360" value="0" step="15" oninput="updateBubbleDecorationRotation()">
                    </div>

                    <!-- 应用范围 -->
                    <div style="margin-bottom: 20px;">
                        <label class="form-label">应用到</label>
                        <div style="display: flex; gap: 10px;">
                            <label style="flex: 1; display: flex; align-items: center; gap: 8px; padding: 10px; background: #f8f8f8; border-radius: 8px; cursor: pointer;">
                                <input type="radio" name="bubbleDecorationApplyTo" value="both" checked onchange="updateBubbleDecorationApplyTo()">
                                <span style="font-size: 13px; color: #333;">全部</span>
                            </label>
                            <label style="flex: 1; display: flex; align-items: center; gap: 8px; padding: 10px; background: #f8f8f8; border-radius: 8px; cursor: pointer;">
                                <input type="radio" name="bubbleDecorationApplyTo" value="user" onchange="updateBubbleDecorationApplyTo()">
                                <span style="font-size: 13px; color: #333;">我</span>
                            </label>
                            <label style="flex: 1; display: flex; align-items: center; gap: 8px; padding: 10px; background: #f8f8f8; border-radius: 8px; cursor: pointer;">
                                <input type="radio" name="bubbleDecorationApplyTo" value="char" onchange="updateBubbleDecorationApplyTo()">
                                <span style="font-size: 13px; color: #333;">对方</span>
                            </label>
                        </div>
                    </div>

                    <!-- 保存设置 -->
                    <button class="btn-primary btn-save" onclick="saveBubbleDecorationSettings()" style="width: 100%; margin-bottom: 20px;">
                        保存装饰设置
                    </button>

                    <!-- 装饰预设管理 -->
                    <div class="section-title" style="margin-top: 30px;">
                        <span class="section-title-text">装饰预设</span>
                    </div>

                    <!-- 保存为预设 -->
                    <div style="margin-bottom: 20px;">
                        <label class="form-label">保存当前配置为预设</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="bubbleDecorationPresetName" class="form-input" placeholder="输入预设名称" maxlength="20" style="flex: 1;">
                            <button class="btn-primary" onclick="saveBubbleDecorationPreset()" style="width: 80px; padding: 12px;">
                                保存
                            </button>
                        </div>
                    </div>

                    <!-- 预设选择 -->
                    <div style="margin-bottom: 20px;">
                        <label class="form-label">加载预设</label>
                        <select id="bubbleDecorationPresetSelect" class="form-select" onchange="loadBubbleDecorationPreset()" style="margin-bottom: 10px;">
                            <option value="">选择预设</option>
                        </select>
                    </div>

                    <!-- 删除预设 -->
                    <button class="btn-primary" onclick="openDeleteBubbleDecorationPresets()" style="width: 100%; background: #dc3545; color: white; border: none;">
                        删除预设
                    </button>
                </div>

                <!-- 自定义气泡CSS代码 -->
                <div class="settings-card">
                    <div class="section-title">
                        <span class="section-title-text">自定义气泡CSS代码</span>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 12px; background-color: #f8f9fa; border-radius: 10px; border: 1px solid #e9ecef;">
                        <div style="font-size: 12px; color: #666; line-height: 1.6;">
                            <div style="font-weight: 600; margin-bottom: 6px;">功能说明：</div>
                            <div>• 自定义用户和AI的气泡CSS样式</div>
                            <div>• 可复制代码给AI进行美化</div>
                            <div>• 支持保存和管理CSS预设</div>
                        </div>
                    </div>

                    <!-- 预览区域 -->
                    <div style="margin-bottom: 20px;">
                        <label class="form-label">实时预览</label>
                        <div id="bubbleCssPreview" style="background: #f5f5f5; border-radius: 12px; padding: 20px; min-height: 200px; overflow-y: auto; max-height: 400px;">
                            <!-- 预览内容由JS动态生成 -->
                        </div>
                    </div>

                    <!-- CSS代码编辑器 -->
                    <div style="margin-bottom: 20px;">
                        <label class="form-label">CSS代码</label>
                        <textarea id="customBubbleCssInput" class="form-input" placeholder="输入自定义CSS代码..." rows="12" style="resize: vertical; min-height: 200px; font-family: monospace; font-size: 12px;" oninput="updateBubbleCssPreview()"></textarea>
                        <div style="margin-top: 8px; font-size: 12px; color: #666;">
                            编辑用户和AI气泡的CSS样式代码，预览会实时更新
                        </div>
                    </div>

                    <!-- 操作按钮 -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="btn-primary" onclick="applyCustomBubbleCss()" style="flex: 1; background: #007bff; color: white; border: none;">
                            应用
                        </button>
                        <button class="btn-primary" onclick="copyCustomBubbleCss()" style="flex: 1; background: #6c757d; color: white; border: none;">
                            复制
                        </button>
                        <button class="btn-primary" onclick="resetCustomBubbleCss()" style="flex: 1; background: #dc3545; color: white; border: none;">
                            重置
                        </button>
                    </div>

                    <!-- 导入/导出按钮 -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="btn-primary" onclick="importBubbleCss()" style="flex: 1; background: #28a745; color: white; border: none;">
                            导入
                        </button>
                        <button class="btn-primary" onclick="openExportBubbleCssModal()" style="flex: 1; background: #17a2b8; color: white; border: none;">
                            导出
                        </button>
                    </div>

                    <!-- CSS预设管理 -->
                    <div class="section-title" style="margin-top: 30px;">
                        <span class="section-title-text">CSS预设</span>
                    </div>

                    <!-- 预设选择 -->
                    <div style="margin-bottom: 20px;">
                        <label class="form-label">选择预设</label>
                        <select id="customBubbleCssPresetSelect" class="form-select" onchange="loadCustomBubbleCssPreset()">
                            <option value="">选择预设</option>
                        </select>
                    </div>

                    <!-- 保存预设 -->
                    <div style="margin-bottom: 20px;">
                        <label class="form-label">保存为预设</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="customBubbleCssPresetName" class="form-input" placeholder="输入预设名称" maxlength="30" style="flex: 1;">
                            <button class="btn-primary" onclick="saveCustomBubbleCssPreset()" style="width: 80px; padding: 12px;">
                                保存
                            </button>
                        </div>
                    </div>

                    <!-- 删除预设 -->
                    <button class="btn-primary" onclick="openDeleteCustomBubbleCssPresets()" style="width: 100%; background: #dc3545; color: white; border: none;">
                        删除预设
                    </button>
                </div>
            </div>

            <!-- 高级标签页 -->
            <div class="chat-settings-tab-content" id="advancedTab">

                <!-- 时间感知 -->
                <div class="adv-section-card">
                    <div class="adv-section-label">时间感知</div>
                    <div class="form-group">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <div style="font-size: 15px; color: #333;">启用时间感知</div>
                                <div style="font-size: 12px; color: #999; margin-top: 4px;">角色将感知当前时间与对话间隔的流逝</div>
                            </div>
                            <label class="ios-switch">
                                <input type="checkbox" id="timeAwarenessToggle" checked onchange="toggleTimeAwareness()">
                                <span class="ios-slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <div style="font-size: 15px; color: #333;">自定义时间</div>
                                <div style="font-size: 12px; color: #999; margin-top: 4px;">开启后角色将使用你设定的时间，与时间感知互斥</div>
                            </div>
                            <label class="ios-switch">
                                <input type="checkbox" id="customTimeToggle" onchange="toggleCustomTime()">
                                <span class="ios-slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- 自定义时间设置区域 -->
                    <div id="customTimeSettings" style="display: none; margin-top: 15px; padding: 15px; background: #f8f8f8; border-radius: 12px;">
                        <div style="font-size: 14px; color: #333; margin-bottom: 12px; font-weight: 500;">设置自定义时间</div>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px;">
                            <div>
                                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">年</label>
                                <input type="number" id="customYear" class="form-input" placeholder="2024" min="1900" max="2100" style="padding: 8px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">月</label>
                                <input type="number" id="customMonth" class="form-input" placeholder="1" min="1" max="12" style="padding: 8px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">日</label>
                                <input type="number" id="customDay" class="form-input" placeholder="1" min="1" max="31" style="padding: 8px;">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                            <div>
                                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">时</label>
                                <input type="number" id="customHour" class="form-input" placeholder="0" min="0" max="23" style="padding: 8px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">分</label>
                                <input type="number" id="customMinute" class="form-input" placeholder="0" min="0" max="59" style="padding: 8px;">
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">秒</label>
                                <input type="number" id="customSecond" class="form-input" placeholder="0" min="0" max="59" style="padding: 8px;">
                            </div>
                        </div>

                        <div style="margin-top: 12px; font-size: 11px; color: #999; line-height: 1.4;">
                            角色将认为当前时间是你设定的时间，不会使用真实系统时间
                        </div>
                    </div>
                </div>

                <!-- 特殊消息显示 -->
                <div class="adv-section-card">
                    <div class="adv-section-label">特殊消息显示</div>
                    <div class="form-group">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <div style="font-size: 15px; color: #333;">显示系统卡片</div>
                                <div style="font-size: 12px; color: #999; margin-top: 4px;">开启后显示银行转账、更换头像等彩色卡片，关闭后只显示灰色系统消息</div>
                            </div>
                            <label class="ios-switch">
                                <input type="checkbox" id="showSystemCardBubblesToggle" checked>
                                <span class="ios-slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <div style="font-size: 15px; color: #333;">情头模式</div>
                                <div style="font-size: 12px; color: #999; margin-top: 4px;">开启后角色可以看到并更换情侣头像库中的情头</div>
                            </div>
                            <label class="ios-switch">
                                <input type="checkbox" id="coupleModeToggle" onchange="toggleCoupleMode()">
                                <span class="ios-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 表情包识别 -->
                <div class="adv-section-card">
                    <div class="adv-section-label">表情包识别</div>
                    <div class="form-group">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <div style="font-size: 15px; color: #333;">启用表情包识别</div>
                                <div style="font-size: 12px; color: #999; margin-top: 4px;">角色可以识别用户发送的表情包内容和含义</div>
                            </div>
                            <label class="ios-switch">
                                <input type="checkbox" id="memeRecognitionToggle" onchange="toggleMemeRecognition()">
                                <span class="ios-slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <button class="data-action-btn secondary-btn" onclick="showMemeCacheStats()" style="width: 100%; margin-bottom: 8px;">
                            查看缓存统计
                        </button>
                        <button class="data-action-btn secondary-btn" onclick="clearMemeCache()" style="width: 100%; background: #ff3b30; color: #fff;">
                            清空表情包缓存
                        </button>
                        <div style="margin-top: 8px; font-size: 12px; color: #999; text-align: center;">
                            表情包会自动缓存到本地，避免重复识别
                        </div>
                    </div>
                </div>

                <!-- 智能表情包匹配 -->
                <div class="adv-section-card">
                    <div class="adv-section-label">智能表情包匹配</div>
                    <div class="form-group">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <div style="font-size: 15px; color: #333;">启用智能匹配</div>
                                <div style="font-size: 12px; color: #999; margin-top: 4px;">输入文字时自动推荐匹配的表情包</div>
                            </div>
                            <label class="ios-switch">
                                <input type="checkbox" id="stickerMatchToggle" checked onchange="toggleStickerMatch()">
                                <span class="ios-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 绑定角色世界书 -->
                <div class="adv-section-card">
                    <div class="adv-section-label">绑定角色世界书</div>
                    <div class="form-group">
                        <label class="form-label">已绑定的世界书</label>
                        <div id="boundWorldBooksDisplay" style="min-height: 40px; padding: 12px; background: #f8f8f8; border-radius: 8px; font-size: 14px; color: #666;">
                            暂未绑定世界书
                        </div>
                        <button class="data-action-btn secondary-btn" onclick="showWorldBookSelector()" style="margin-top: 12px;">
                            选择世界书
                        </button>
                    </div>
                </div>

                <!-- 短期记忆 -->
                <div class="adv-section-card">
                    <div class="adv-section-label">短期记忆</div>
                    <div class="form-group">
                        <label class="form-label">AI可见的历史消息条数</label>
                        <input type="number" id="shortTermMemoryInput" class="form-input" placeholder="输入消息条数（如：1000）" step="1">
                        <div style="margin-top: 8px; font-size: 12px; color: #666;">
                            设置AI能看到的最近聊天记录条数，建议 10-1000 条。数值越大，AI能记住更多上下文，但会消耗更多tokens。留空则使用默认值（10条）。
                        </div>
                    </div>
                </div>

                <!-- 长期记忆 -->
                <div class="adv-section-card">
                    <div class="adv-section-label">长期记忆</div>
                    <div class="form-group">
                        <label class="form-label">自动总结间隔（条）</label>
                        <input type="number" id="longTermMemoryIntervalInput" class="form-input" placeholder="输入间隔条数（如：5）" min="2" step="1">
                        <div style="margin-top: 8px; font-size: 12px; color: #666;">
                            每隔多少条消息自动总结一次。例如设置5，则每5条消息后会自动总结这段对话并存入长期记忆库。设为0或留空则关闭自动总结。
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">长期记忆提示词格式</label>
                        <select id="longTermMemoryFormatSelect" class="form-input" onchange="onLongTermMemoryFormatChange()">
                            <option value="diary">日记式</option>
                            <option value="narrative">旁白式</option>
                            <option value="objective">客观记录式</option>
                            <option value="custom">自定义格式</option>
                        </select>
                        <div id="longTermMemoryFormatPreview" style="margin-top: 8px; font-size: 12px; color: #666; white-space: pre-wrap;"></div>
                    </div>

                    <div class="form-group" id="longTermMemoryCustomPromptGroup" style="display: none;">
                        <label class="form-label">自定义总结提示词</label>
                        <textarea id="longTermMemoryCustomPromptInput" class="form-input" rows="4" placeholder="描述你想要的总结风格和要求..."></textarea>
                        <div style="margin-top: 8px; font-size: 12px; color: #666;">
                            自定义总结风格。可以参考自动填入的示例修改，或完全自己编写。
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">精简总结格式</label>
                        <select id="ltmCondenseFormatSelect" class="form-input" onchange="onLtmCondenseFormatChange()">
                            <option value="first-person">第一人称精简</option>
                            <option value="third-person">第三人称精简</option>
                            <option value="objective">客观记录式精简</option>
                            <option value="custom">自定义格式</option>
                        </select>
                        <div id="ltmCondenseFormatPreview" style="margin-top: 8px; font-size: 12px; color: #666; white-space: pre-wrap;"></div>
                    </div>

                    <div class="form-group" id="ltmCondenseCustomPromptGroup" style="display: none;">
                        <label class="form-label">自定义精简提示词</label>
                        <textarea id="ltmCondensePromptInput" class="form-input" rows="4" placeholder="描述你想要的精简风格和要求..."></textarea>
                        <div style="margin-top: 8px; font-size: 12px; color: #666;">
                            自定义精简风格。留空则使用默认提示词。
                        </div>
                    </div>

                    <div class="form-group">
                        <button class="data-action-btn secondary-btn" onclick="openLongTermMemoryManager()" style="margin-top: 4px;">
                            长期记忆管理库
                        </button>
                        <button class="data-action-btn secondary-btn" onclick="openManualSummaryModal()" style="margin-top: 8px;">
                            手动总结对话
                        </button>
                        <button class="data-action-btn secondary-btn" onclick="openDiarySummaryModal()" style="margin-top: 8px;">
                            日记总结
                        </button>
                    </div>
                </div>

                <!-- 挂载聊天记录 -->
                <div class="adv-section-card">
                    <div class="adv-section-label">挂载聊天记录</div>
                    <div class="form-group">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <div style="font-size: 15px; color: #333;">启用挂载</div>
                                <div style="font-size: 12px; color: #999; margin-top: 4px;">让角色看到其他聊天中的对话记录</div>
                            </div>
                            <label class="ios-switch">
                                <input type="checkbox" id="mountChatToggle" onchange="onMountChatToggleChange()">
                                <span class="ios-slider"></span>
                            </label>
                        </div>
                    </div>

                    <div id="mountChatSettings" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">选择要挂载的聊天</label>
                            <div id="mountChatList" style="min-height: 40px; max-height: 240px; overflow-y: auto; background: #f8f8f8; border-radius: 12px; padding: 8px;">
                                <div style="text-align: center; color: #999; font-size: 13px; padding: 12px 0;">暂无其他聊天</div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">挂载条数设置</label>
                            <div id="mountChatCountSettings" style="min-height: 20px;">
                                <div style="font-size: 13px; color: #999;">请先勾选要挂载的聊天</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 对话统计 -->
                <div class="adv-section-card">
                    <div class="adv-section-label">对话统计</div>
                    <div id="chatStatsArea" style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 120px; background: #f8f8f8; border-radius: 12px; padding: 16px; text-align: center;">
                            <div style="font-size: 28px; font-weight: 600; color: #333;" id="statTotalMessages">0</div>
                            <div style="font-size: 12px; color: #999; margin-top: 4px;">总消息条数</div>
                        </div>
                        <div style="flex: 1; min-width: 120px; background: #f8f8f8; border-radius: 12px; padding: 16px; text-align: center;">
                            <div style="font-size: 28px; font-weight: 600; color: #333;" id="statUserMessages">0</div>
                            <div style="font-size: 12px; color: #999; margin-top: 4px;">用户消息</div>
                        </div>
                        <div style="flex: 1; min-width: 120px; background: #f8f8f8; border-radius: 12px; padding: 16px; text-align: center;">
                            <div style="font-size: 28px; font-weight: 600; color: #333;" id="statCharMessages">0</div>
                            <div style="font-size: 12px; color: #999; margin-top: 4px;">角色消息</div>
                        </div>
                        <div style="flex: 1; min-width: 120px; background: #f8f8f8; border-radius: 12px; padding: 16px; text-align: center;">
                            <div style="font-size: 28px; font-weight: 600; color: #007bff;" id="statEstTokens">0</div>
                            <div style="font-size: 12px; color: #999; margin-top: 4px;">当前总Token</div>
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #aaa; text-align: center;">
                        Token数为粗略估算（中文≈1.5token/字，英文≈0.25token/词），实时更新
                    </div>
                </div>

                <!-- 隐藏消息管理 -->
                <div class="adv-section-card">
                    <div class="adv-section-label">隐藏消息管理</div>
                    <div class="form-group" style="margin: 0;">
                        <button class="data-action-btn secondary-btn" onclick="openHiddenMessagePanel()" style="width: 100%;">
                            管理隐藏消息
                        </button>
                        <div style="margin-top: 8px; font-size: 12px; color: #999; text-align: center;">
                            隐藏指定范围的消息，AI将看不到这些消息，节省Token
                        </div>
                    </div>
                </div>

                <!-- 视频通话设置 -->
                <div class="adv-section-card" id="videoCallAvatarSection">
                    <div class="adv-section-label">视频通话设置</div>
                    
                    <div class="form-group">
                        <label class="form-label">用户视频画面</label>
                        <div style="font-size:12px;color:#999;margin-bottom:8px;">视频通话时显示的用户画面（会铺满小窗）</div>
                        <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
                            <div style="width:60px;height:60px;border-radius:8px;background:#f0f0f0;overflow:hidden;flex-shrink:0;position:relative;">
                                <img id="videoCallUserAvatarPreview" style="width:100%;height:100%;object-fit:cover;display:none;">
                                <div id="videoCallUserAvatarPlaceholder" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:11px;color:#999;">未设置</div>
                            </div>
                            <div style="flex:1;display:flex;flex-direction:column;gap:6px;">
                                <button class="data-action-btn secondary-btn" onclick="uploadVideoCallUserAvatar('local')" style="padding:8px 12px;font-size:13px;">本地上传</button>
                                <button class="data-action-btn secondary-btn" onclick="uploadVideoCallUserAvatar('url')" style="padding:8px 12px;font-size:13px;">URL上传</button>
                            </div>
                        </div>
                        <button class="data-action-btn secondary-btn" onclick="resetVideoCallUserAvatar()" style="width:100%;background:#ff3b30;color:#fff;font-size:13px;">重置</button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">角色视频画面</label>
                        <div style="font-size:12px;color:#999;margin-bottom:8px;">视频通话时显示的角色画面（会铺满整个屏幕）</div>
                        <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
                            <div style="width:60px;height:60px;border-radius:8px;background:#f0f0f0;overflow:hidden;flex-shrink:0;position:relative;">
                                <img id="videoCallCharAvatarPreview" style="width:100%;height:100%;object-fit:cover;display:none;">
                                <div id="videoCallCharAvatarPlaceholder" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:11px;color:#999;">未设置</div>
                            </div>
                            <div style="flex:1;display:flex;flex-direction:column;gap:6px;">
                                <button class="data-action-btn secondary-btn" onclick="uploadVideoCallCharAvatar('local')" style="padding:8px 12px;font-size:13px;">本地上传</button>
                                <button class="data-action-btn secondary-btn" onclick="uploadVideoCallCharAvatar('url')" style="padding:8px 12px;font-size:13px;">URL上传</button>
                            </div>
                        </div>
                        <button class="data-action-btn secondary-btn" onclick="resetVideoCallCharAvatar()" style="width:100%;background:#ff3b30;color:#fff;font-size:13px;">重置</button>
                    </div>

                    <div class="form-group">
                        <button class="data-action-btn" onclick="openVideoCallMemoryLibrary()" style="width:100%;background:#5856d6;color:#fff;border:none;border-radius:10px;padding:14px 0;font-size:16px;font-weight:500;cursor:pointer;">
                            视频通话记忆库
                        </button>
                        <div style="margin-top:8px;font-size:12px;color:#999;text-align:center;">
                            查看所有视频通话记录，支持归档和删除
                        </div>
                    </div>
                </div>

                <!-- 记忆库 -->
                <div class="adv-section-card">
                    <div class="adv-section-label">记忆库</div>
                    <div style="margin-bottom: 12px;">
                        <button class="data-action-btn" onclick="openSaveMemoryDialog()" style="width: 100%; background: #5856d6; color: #fff; border: none; border-radius: 10px; padding: 14px 0; font-size: 16px; font-weight: 500; cursor: pointer;">
                            保存当前状态
                        </button>
                        <div style="margin-top: 8px; font-size: 12px; color: #999; text-align: center;">
                            保存当前所有聊天记录、设置、人设、表情包等
                        </div>
                    </div>
                    
                    <!-- 存档列表 -->
                    <div id="memoryArchiveList" style="max-height: 300px; overflow-y: auto;">
                        <!-- 存档项将动态生成 -->
                    </div>
                </div>

                <!-- API历史查看 -->
                <div class="adv-section-card">
                    <div class="adv-section-label">API历史查看</div>
                    <div class="form-group" style="margin: 0;">
                        <button class="data-action-btn" onclick="openApiHistoryPanel()" style="width: 100%; background: #5856d6; color: #fff; border: none; border-radius: 10px; padding: 14px 0; font-size: 16px; font-weight: 500; cursor: pointer;">
                            查看API调用历史
                        </button>
                        <div style="margin-top: 8px; font-size: 12px; color: #999; text-align: center;">
                            查看所有API请求和响应数据，需在API设置中开启记录
                        </div>
                    </div>
                </div>

                <!-- 定时主动消息（独立功能） -->
                <div class="adv-section-card">
                    <div class="adv-section-label">定时主动消息</div>

                    <!-- 主动消息开关 -->
                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <label class="form-label" style="margin-bottom: 4px;">启用定时消息</label>
                                <div style="font-size: 12px; color: #999;">角色会按设定的时间间隔主动给你发消息，不受状态影响</div>
                            </div>
                            <label class="ios-switch">
                                <input type="checkbox" id="indProactiveToggle" onchange="toggleIndependentProactive()">
                                <span class="ios-slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- 消息间隔 -->
                    <div class="form-group">
                        <label class="form-label">消息间隔（分钟）</label>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="number" class="form-input" id="indProactiveMin" value="5" min="0.1" step="0.1" max="1440" style="flex:1;">
                            <span style="color: #999;">~</span>
                            <input type="number" class="form-input" id="indProactiveMax" value="10" min="0.1" step="0.1" max="1440" style="flex:1;">
                        </div>
                        <div style="font-size: 12px; color: #999; margin-top: 6px;">在此范围内随机选择时间发送，支持小数（如0.5=30秒）</div>
                    </div>

                    <!-- 勿扰模式 -->
                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <label class="form-label" style="margin-bottom: 4px;">勿扰模式</label>
                                <div style="font-size: 12px; color: #999;">设定时段内不会发送定时消息</div>
                            </div>
                            <label class="ios-switch">
                                <input type="checkbox" id="indDndToggle">
                                <span class="ios-slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- 勿扰时段 -->
                    <div class="form-group">
                        <label class="form-label">勿扰时段</label>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="time" class="form-input" id="indDndStart" value="00:00" style="flex:1;">
                            <span style="color: #999;">至</span>
                            <input type="time" class="form-input" id="indDndEnd" value="08:00" style="flex:1;">
                        </div>
                    </div>

                    <!-- 操作按钮 -->
                    <div style="display: flex; gap: 10px; margin-top: 16px;">
                        <button class="data-action-btn" onclick="saveIndProactiveSettings()" style="flex: 1; background: #007bff; color: #fff; border: none; border-radius: 10px; padding: 12px 0; font-size: 15px; font-weight: 500; cursor: pointer;">
                            保存设置
                        </button>
                        <button class="data-action-btn" onclick="testIndProactiveMessage()" style="flex: 1; background: #ff9500; color: #fff; border: none; border-radius: 10px; padding: 12px 0; font-size: 15px; font-weight: 500; cursor: pointer;">
                            立即测试
                        </button>
                    </div>

                    <!-- 开发者调试入口 -->
                    <div style="margin-top: 12px;">
                        <button class="data-action-btn" onclick="openProactiveDebugPanel()" style="width: 100%; background: #f0f0f0; color: #666; border: none; border-radius: 10px; padding: 10px 0; font-size: 13px; cursor: pointer;">
                            🛠 开发者调试面板
                        </button>
                    </div>
                </div>

                <!-- 角色后台活动 -->
                <div class="adv-section-card">
                    <div class="adv-section-label">角色后台活动</div>

                    <!-- 当前状态 -->
                    <div style="margin-bottom: 16px; padding: 14px; background: #f8f8f8; border-radius: 12px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 13px; color: #999;">当前状态</span>
                        <span class="bg-status-badge bg-status-online" id="bgActivityCurrentStatus">在线</span>
                    </div>

                    <!-- 总开关 -->
                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <label class="form-label" style="margin-bottom: 4px;">启用后台活动</label>
                                <div style="font-size: 12px; color: #999;">角色拥有自己的生活节奏（睡觉、忙碌等状态模拟）</div>
                            </div>
                            <label class="ios-switch">
                                <input type="checkbox" id="bgActivityToggle" onchange="toggleBgActivity()">
                                <span class="ios-slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- 觉醒时间 -->
                    <div id="bgWakeTimeSection" style="display:none; margin-bottom: 16px; padding: 14px; background: #f8f8f8; border-radius: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="font-size: 13px; color: #999;">预计恢复时间</span>
                            <span id="bgWakeTimeCountdown" style="font-size: 13px; font-weight: 600; color: #007bff;">—</span>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="datetime-local" class="form-input" id="bgWakeTimeInput" style="flex:1; font-size: 13px;">
                            <button onclick="updateWakeTime()" style="background: #007bff; color: #fff; border: none; border-radius: 8px; padding: 8px 14px; font-size: 13px; cursor: pointer; white-space: nowrap;">修改</button>
                        </div>
                        <div style="font-size: 12px; color: #999; margin-top: 6px;">可手动调整角色恢复在线的时间</div>
                    </div>

                    <!-- 操作按钮 -->
                    <div style="display: flex; gap: 10px; margin-top: 16px;">
                        <button class="data-action-btn" onclick="saveBgActivitySettings()" style="flex: 1; background: #007bff; color: #fff; border: none; border-radius: 10px; padding: 12px 0; font-size: 15px; font-weight: 500; cursor: pointer;">
                            保存设置
                        </button>
                        <button class="data-action-btn" onclick="forceWakeCharacter()" style="flex: 1; background: #34c759; color: #fff; border: none; border-radius: 10px; padding: 12px 0; font-size: 15px; font-weight: 500; cursor: pointer;">
                            立即唤醒
                        </button>
                    </div>
                </div>

                <!-- 导出/导入聊天记录 -->
                <div class="adv-section-card">
                    <div class="form-group" style="margin: 0;">
                        <button class="data-action-btn" onclick="exportChatHistory()" style="width: 100%; background: #007bff; color: #fff; border: none; border-radius: 10px; padding: 14px 0; font-size: 16px; font-weight: 500; cursor: pointer; margin-bottom: 10px;">
                            导出个人聊天记录
                        </button>
                        <button class="data-action-btn" onclick="importChatHistory()" style="width: 100%; background: #34c759; color: #fff; border: none; border-radius: 10px; padding: 14px 0; font-size: 16px; font-weight: 500; cursor: pointer;">
                            导入个人聊天记录
                        </button>
                        <div style="margin-top: 8px; font-size: 12px; color: #999; text-align: center;">
                            导出/导入与该角色的所有聊天记录
                        </div>
                    </div>
                </div>

                <!-- 清除聊天记录 -->
                <div class="adv-section-card">
                    <div class="form-group" style="margin: 0;">
                        <button class="data-action-btn" onclick="clearAllChatMessages()" style="width: 100%; background: #ff3b30; color: #fff; border: none; border-radius: 10px; padding: 14px 0; font-size: 16px; font-weight: 500; cursor: pointer;">
                            清除所有聊天记录
                        </button>
                        <div style="margin-top: 8px; font-size: 12px; color: #999; text-align: center;">
                            将删除与该角色的所有聊天消息，此操作不可撤销
                        </div>
                    </div>
                </div>

                <!-- 拉黑此角色 -->
                <div class="adv-section-card">
                    <div class="form-group" style="margin: 0;">
                        <button class="data-action-btn" id="blockCharBtn" onclick="userBlockCharacter(currentChatCharacter && currentChatCharacter.id)" style="width: 100%; background: #1c1c1e; color: #fff; border: none; border-radius: 10px; padding: 14px 0; font-size: 16px; font-weight: 500; cursor: pointer;">
                            拉黑此角色
                        </button>
                        <div style="margin-top: 8px; font-size: 12px; color: #999; text-align: center;">
                            拉黑后你仍可发消息，但对方不会回复，对方会定时发好友申请
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </div>

    <!-- 拉黑开发者面板 -->
    <div class="settings-page" id="blockDevPanel" style="z-index: 10006; display: none;">
        <div class="settings-content" style="max-width: 400px;">
            <div class="settings-header">
                <div class="back-btn" onclick="closeBlockDevPanel()">←</div>
                <div class="settings-title">拉黑管理面板</div>
                <div style="width: 44px;"></div>
            </div>
            <div class="settings-card" id="blockDevPanelContent">
                <!-- 动态生成 -->
            </div>
        </div>
    </div>

    <!-- 好友申请列表页面（已废弃，功能移至好友标签页） -->
    <!--
    <div class="settings-page" id="friendRequestPage" style="z-index: 10002; display: none;">
        <div class="settings-content" style="max-width: 400px;">
            <div class="settings-header">
                <div class="back-btn" onclick="closeFriendRequestPage()">←</div>
                <div class="settings-title">好友申请</div>
                <div style="width: 44px;"></div>
            </div>
            <div class="settings-card" style="padding: 0;">
                <div id="friendRequestListContainer" style="min-height: 200px;">
                </div>
            </div>
        </div>
    </div>
    -->

    <!-- 删除气泡装饰预设弹窗 -->
    <div class="settings-page" id="deleteBubbleDecorationPresetsModal" style="z-index: 10007; display: none;">
        <div class="settings-content" style="max-width: 400px;">
            <div class="settings-header">
                <div class="back-btn" onclick="closeDeleteBubbleDecorationPresets()">←</div>
                <div class="settings-title">删除装饰预设</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <div style="margin-bottom: 20px; padding: 12px; background-color: #f8f9fa; border-radius: 10px; border: 1px solid #e9ecef;">
                    <div style="font-size: 12px; color: #666; line-height: 1.6;">
                        选择要删除的装饰预设（可多选）
                    </div>
                </div>

                <!-- 预设列表 -->
                <div id="deleteBubbleDecorationPresetsList" style="margin-bottom: 20px; max-height: 400px; overflow-y: auto;">
                    <!-- 动态生成预设列表 -->
                </div>

                <!-- 操作按钮 -->
                <div style="display: flex; gap: 10px;">
                    <button class="btn-primary" onclick="toggleSelectAllBubbleDecorationPresets()" style="flex: 1; background: #6c757d; color: white; border: none;">
                        全选/取消
                    </button>
                    <button class="btn-primary" onclick="confirmDeleteBubbleDecorationPresets()" style="flex: 1; background: #dc3545; color: white; border: none;">
                        删除选中
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 删除自定义CSS预设弹窗 -->
    <div class="settings-page" id="deleteCustomBubbleCssPresetsModal" style="z-index: 10008; display: none;">
        <div class="settings-content" style="max-width: 400px;">
            <div class="settings-header">
                <div class="back-btn" onclick="closeDeleteCustomBubbleCssPresets()">←</div>
                <div class="settings-title">删除CSS预设</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <div style="margin-bottom: 20px; padding: 12px; background-color: #f8f9fa; border-radius: 10px; border: 1px solid #e9ecef;">
                    <div style="font-size: 12px; color: #666; line-height: 1.6;">
                        选择要删除的CSS预设（可多选）
                    </div>
                </div>

                <!-- 预设列表 -->
                <div id="deleteCustomBubbleCssPresetsList" style="margin-bottom: 20px; max-height: 400px; overflow-y: auto;">
                    <!-- 动态生成预设列表 -->
                </div>

                <!-- 操作按钮 -->
                <div style="display: flex; gap: 10px;">
                    <button class="btn-primary" onclick="toggleSelectAllCustomBubbleCssPresets()" style="flex: 1; background: #6c757d; color: white; border: none;">
                        全选/取消
                    </button>
                    <button class="btn-primary" onclick="confirmDeleteCustomBubbleCssPresets()" style="flex: 1; background: #dc3545; color: white; border: none;">
                        删除选中
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 气泡样式选择器弹窗 -->
    <div class="settings-page" id="bubbleStyleSelectorModal" style="z-index: 10005; display: none;">
        <div class="settings-content" style="max-width: 400px;">
            <div class="settings-header">
                <div class="back-btn" onclick="closeBubbleStyleSelector()">←</div>
                <div class="settings-title">选择气泡样式</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <div style="margin-bottom: 20px; padding: 12px; background-color: #f8f9fa; border-radius: 10px; border: 1px solid #e9ecef;">
                    <div style="font-size: 12px; color: #666; line-height: 1.6;">
                        选择你喜欢的气泡形状，颜色保持不变（蓝灰配色）
                    </div>
                </div>

                <!-- 气泡样式网格 -->
                <div id="bubbleStyleGrid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    <!-- 动态生成气泡样式卡片 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 删除颜色方案弹窗 -->
    <div class="settings-page" id="deleteColorSchemesModal" style="z-index: 10006; display: none;">
        <div class="settings-content" style="max-width: 400px;">
            <div class="settings-header">
                <div class="back-btn" onclick="closeDeleteColorSchemes()">←</div>
                <div class="settings-title">删除颜色方案</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <div style="margin-bottom: 20px; padding: 12px; background-color: #f8f9fa; border-radius: 10px; border: 1px solid #e9ecef;">
                    <div style="font-size: 12px; color: #666; line-height: 1.6;">
                        选择要删除的颜色方案（可多选）
                    </div>
                </div>

                <!-- 方案列表 -->
                <div id="deleteColorSchemesList" style="margin-bottom: 20px; max-height: 400px; overflow-y: auto;">
                    <!-- 动态生成方案列表 -->
                </div>

                <!-- 操作按钮 -->
                <div style="display: flex; gap: 10px;">
                    <button class="btn-primary" onclick="toggleSelectAllColorSchemes()" style="flex: 1; background: #6c757d; color: white; border: none;">
                        全选/取消
                    </button>
                    <button class="btn-primary" onclick="confirmDeleteColorSchemes()" style="flex: 1; background: #dc3545; color: white; border: none;">
                        删除选中
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 长期记忆管理库界面 -->
    <div class="settings-page" id="longTermMemoryPage" style="display: none; z-index: 10002;">
        <div class="settings-content">
            <div class="settings-header">
                <div class="settings-back" onclick="closeLongTermMemoryManager()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M15 18L9 12L15 6" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </div>
                <div class="settings-title">长期记忆管理库</div>
                <div style="display: flex; gap: 16px; align-items: center;">
                    <div class="settings-action" onclick="startCondenseMode()" id="ltmCondenseBtn" style="font-size: 14px; color: #007aff; cursor: pointer;">精简</div>
                    <div class="settings-action" onclick="addLongTermMemoryManual()" style="font-size: 14px; color: #007aff; cursor: pointer;">添加</div>
                </div>
            </div>
            <div class="settings-card" id="longTermMemoryListContainer">
                <div id="longTermMemoryList" style="min-height: 100px;">
                    <div style="text-align: center; color: #999; font-size: 14px; padding: 40px 0;">暂无长期记忆</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 聊天详情界面 -->
    <div class="settings-page chat-detail-page" id="chatDetailPage" style="display: none;">
        <div class="settings-content chat-detail-container">
            <!-- 顶部导航栏 -->
            <div class="chat-detail-header">
                <div class="chat-detail-back" onclick="closeChatDetail()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15 18L9 12L15 6" stroke="#333333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <div class="chat-detail-info" onclick="showChatCharacterInfo()">
                    <div class="chat-detail-name" id="chatDetailName">角色名称</div>
                    <div class="chat-detail-status" id="chatDetailStatus" style="display:none;"></div>
                </div>
                <div class="chat-detail-settings" onclick="openChatSettings()">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="16" cy="16" r="15" fill="#E5E5E5"/>
                        <circle cx="11" cy="16" r="1.5" fill="#666666"/>
                        <circle cx="16" cy="16" r="1.5" fill="#666666"/>
                        <circle cx="21" cy="16" r="1.5" fill="#666666"/>
                    </svg>
                </div>
            </div>

            <!-- 聊天消息区域 -->
            <div class="chat-messages-container" id="chatMessagesContainer">
                <div class="chat-empty-message">
                    <div style="font-size: 14px; color: #999;">开始对话吧</div>
                </div>
            </div>

            <!-- 智能表情包推荐区域 -->
            <div class="sticker-suggestion-panel" id="stickerSuggestionPanel" style="display: none;">
                <div class="sticker-suggestion-scroll" id="stickerSuggestionScroll">
                    <!-- 动态生成表情包推荐 -->
                </div>
            </div>

            <!-- 底部输入栏 -->
            <div class="chat-input-bar">
                <div class="chat-input-voice" onclick="toggleVoiceInput()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 14C13.66 14 15 12.66 15 11V5C15 3.34 13.66 2 12 2C10.34 2 9 3.34 9 5V11C9 12.66 10.34 14 12 14Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M19 11C19 14.53 16.39 17.44 13 17.93V21M5 11C5 14.53 7.61 17.44 11 17.93V21M8 21H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <div class="chat-input-wrapper">
                    <input type="text" class="chat-input-field" id="chatInputField" placeholder="输入消息..." />
                    <div class="chat-input-emoji" onclick="showEmojiPicker()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                            <path d="M8 14C8 14 9.5 16 12 16C14.5 16 16 14 16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            <circle cx="9" cy="9" r="1" fill="currentColor"/>
                            <circle cx="15" cy="9" r="1" fill="currentColor"/>
                        </svg>
                    </div>
                    <div class="chat-input-add" onclick="showMoreOptions()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                            <path d="M12 8V16M8 12H16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                </div>
                <div class="chat-input-send" id="chatSendButton" onclick="sendMessage()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
            </div>

            <!-- 拓展功能面板 -->
            <div class="chat-extend-panel" id="chatExtendPanel">
                <div class="chat-extend-swiper" id="chatExtendSwiper">
                    <!-- 第一页 -->
                    <div class="chat-extend-page">
                        <div class="chat-extend-grid">
                            <!-- 第一行 -->
                            <div class="chat-extend-item" onclick="extendAction('sticker')">
                                <div class="chat-extend-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"/>
                                        <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                                        <line x1="9" y1="9" x2="9.01" y2="9"/>
                                        <line x1="15" y1="9" x2="15.01" y2="9"/>
                                        <path d="M2 12h2M20 12h2"/>
                                    </svg>
                                </div>
                                <span class="chat-extend-label">表情包</span>
                            </div>
                            <div class="chat-extend-item" onclick="extendAction('resend')">
                                <div class="chat-extend-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M1 4v6h6"/>
                                        <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                                    </svg>
                                </div>
                                <span class="chat-extend-label">重说</span>
                            </div>
                            <div class="chat-extend-item" onclick="extendAction('voice')">
                                <div class="chat-extend-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                                        <line x1="12" y1="19" x2="12" y2="23"/>
                                        <line x1="8" y1="23" x2="16" y2="23"/>
                                    </svg>
                                </div>
                                <span class="chat-extend-label">语音消息</span>
                            </div>
                            <div class="chat-extend-item" onclick="extendAction('image')">
                                <div class="chat-extend-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <path d="M21 15l-5-5L5 21"/>
                                    </svg>
                                </div>
                                <span class="chat-extend-label">图片</span>
                            </div>

                            <!-- 第二行 -->
                            <div class="chat-extend-item" onclick="extendAction('transfer')">
                                <div class="chat-extend-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="2" y="4" width="20" height="16" rx="2"/>
                                        <path d="M12 9v6"/>
                                        <path d="M9 12h6"/>
                                        <line x1="2" y1="10" x2="22" y2="10"/>
                                    </svg>
                                </div>
                                <span class="chat-extend-label">转账</span>
                            </div>
                            <div class="chat-extend-item" onclick="extendAction('gift')">
                                <div class="chat-extend-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="3" y="10" width="18" height="12" rx="1"/>
                                        <path d="M12 6a3 3 0 0 0-3-3C7.34 3 6 4.34 6 6c0 1 .6 2 3 4h3"/>
                                        <path d="M12 6a3 3 0 0 1 3-3c1.66 0 3 1.34 3 3 0 1-.6 2-3 4h-3"/>
                                        <rect x="3" y="7" width="18" height="3" rx="1"/>
                                        <line x1="12" y1="10" x2="12" y2="22"/>
                                    </svg>
                                </div>
                                <span class="chat-extend-label">礼物</span>
                            </div>
                            <div class="chat-extend-item" onclick="extendAction('textImage')">
                                <div class="chat-extend-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                                        <line x1="7" y1="8" x2="17" y2="8"/>
                                        <line x1="7" y1="12" x2="14" y2="12"/>
                                        <path d="M14 16l3-3 4 4"/>
                                        <circle cx="16" cy="16" r="1"/>
                                    </svg>
                                </div>
                                <span class="chat-extend-label">图文</span>
                            </div>
                            <div class="chat-extend-item" onclick="extendAction('videoCall')">
                                <div class="chat-extend-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="2" y="5" width="15" height="14" rx="2"/>
                                        <path d="M17 9l5-3v12l-5-3"/>
                                    </svg>
                                </div>
                                <span class="chat-extend-label">视频通话</span>
                            </div>
                        </div>
                    </div>
                    <!-- 第二页 -->
                    <div class="chat-extend-page">
                        <div class="chat-extend-grid">
                            <!-- 第一行 -->
                            <div class="chat-extend-item" onclick="extendAction('location')">
                                <div class="chat-extend-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                                        <circle cx="12" cy="10" r="3"/>
                                    </svg>
                                </div>
                                <span class="chat-extend-label">定位</span>
                            </div>
                            <div class="chat-extend-item" onclick="extendAction('voiceCall')">
                                <div class="chat-extend-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/>
                                    </svg>
                                </div>
                                <span class="chat-extend-label">语音通话</span>
                            </div>
                            <div class="chat-extend-item" onclick="stopApiCall()">
                                <div class="chat-extend-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"/>
                                        <rect x="9" y="9" width="6" height="6" fill="currentColor"/>
                                    </svg>
                                </div>
                                <span class="chat-extend-label">停止调用</span>
                            </div>
                            <div class="chat-extend-item" onclick="openFormatFixPanel()">
                                <div class="chat-extend-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </div>
                                <span class="chat-extend-label">调节格式</span>
                            </div>

                            <!-- 第二行 -->
                            <div class="chat-extend-item" onclick="extendAction('narration')">
                                <div class="chat-extend-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                        <polyline points="14 2 14 8 20 8"/>
                                        <line x1="8" y1="13" x2="16" y2="13"/>
                                        <line x1="8" y1="17" x2="16" y2="17"/>
                                    </svg>
                                </div>
                                <span class="chat-extend-label">旁白</span>
                            </div>
                            <div class="chat-extend-item" onclick="extendAction('proactiveSpeak')">
                                <div class="chat-extend-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                                        <path d="M8 10h.01"/>
                                        <path d="M12 10h.01"/>
                                        <path d="M16 10h.01"/>
                                    </svg>
                                </div>
                                <span class="chat-extend-label">主动说话</span>
                            </div>
                            <div class="chat-extend-item chat-extend-item-placeholder">
                                <div class="chat-extend-icon chat-extend-icon-placeholder"></div>
                                <span class="chat-extend-label"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 分页指示器 -->
                <div class="chat-extend-dots">
                    <div class="chat-extend-dot active" data-page="0"></div>
                    <div class="chat-extend-dot" data-page="1"></div>
                </div>
            </div>

            <!-- 语音消息弹窗 -->
            <div class="voice-msg-overlay" id="voiceMsgOverlay" style="display:none;">
                <div class="voice-msg-modal">
                    <div class="voice-msg-header">
                        <span class="voice-msg-title">语音消息</span>
                        <span class="voice-msg-close" onclick="closeVoiceMessageModal()">✕</span>
                    </div>
                    <div class="voice-msg-body">
                        <div class="form-group">
                            <label class="form-label" style="font-size:14px;color:#333;">语音内容</label>
                            <textarea id="voiceMsgText" class="form-input" placeholder="输入语音消息的文字内容..." rows="3" style="resize:vertical;min-height:70px;font-size:15px;"></textarea>
                        </div>
                        <div class="form-group" style="margin-top:14px;">
                            <label class="form-label" style="font-size:14px;color:#333;">时长（秒）<span style="color:#999;font-size:12px;margin-left:4px;">选填，不填自动推算</span></label>
                            <input type="number" id="voiceMsgDuration" class="form-input" placeholder="例如：5" min="1" max="60" style="font-size:15px;">
                        </div>
                    </div>
                    <div class="voice-msg-footer">
                        <button class="btn-primary" onclick="closeVoiceMessageModal()" style="flex:1;background:#f0f0f0;color:#333;border:none;">取消</button>
                        <button class="btn-primary btn-save" onclick="sendVoiceMessage()" style="flex:1;">发送</button>
                    </div>
                </div>
            </div>

            <!-- 转账弹窗 -->
            <div class="transfer-overlay" id="transferOverlay" style="display:none;">
                <div class="transfer-modal">
                    <div class="transfer-modal-header">
                        <span class="transfer-modal-title">转账</span>
                        <span class="transfer-modal-close" onclick="closeTransferModal()">✕</span>
                    </div>
                    <div class="transfer-modal-body">
                        <div class="form-group">
                            <label class="form-label" style="font-size:14px;color:#333;">转账金额</label>
                            <div class="transfer-amount-grid" id="transferAmountGrid">
                                <div class="transfer-amount-btn" onclick="selectTransferAmount(this, 52.0)">¥52.0</div>
                                <div class="transfer-amount-btn" onclick="selectTransferAmount(this, 131.4)">¥131.4</div>
                                <div class="transfer-amount-btn" onclick="selectTransferAmount(this, 520)">¥520</div>
                                <div class="transfer-amount-btn" onclick="selectTransferAmount(this, 999)">¥999</div>
                                <div class="transfer-amount-btn" onclick="selectTransferAmount(this, 1314)">¥1314</div>
                                <div class="transfer-amount-btn" onclick="selectTransferAmount(this, 5200)">¥5200</div>
                            </div>
                            <input type="number" class="transfer-custom-input" id="transferCustomAmount" placeholder="自定义金额" step="0.01" min="0.01" oninput="clearTransferAmountSelection()">
                        </div>
                        <div class="form-group" style="margin-top:12px;">
                            <label class="form-label" style="font-size:14px;color:#333;">转账备注 <span style="color:#999;font-size:12px;margin-left:4px;">选填</span></label>
                            <input type="text" class="transfer-custom-input" id="transferRemark" placeholder="输入转账备注..." maxlength="30">
                        </div>
                    </div>
                    <div class="transfer-modal-footer">
                        <button class="btn-primary" onclick="closeTransferModal()" style="flex:1;background:#f0f0f0;color:#333;border:none;">取消</button>
                        <button class="btn-primary btn-save" onclick="sendTransferMessage()" style="flex:1;background:#f09b37;">转账</button>
                    </div>
                </div>
            </div>

            <!-- 表情包面板 -->
            <div class="sticker-panel" id="stickerPanel">
                <div class="sticker-panel-header">
                    <span class="sticker-panel-title" id="stickerPanelTitle">我的表情</span>
                    <div style="display:flex;gap:12px;">
                        <span class="sticker-panel-manage" id="stickerDeleteBtn" onclick="toggleStickerDeleteMode()" style="color:#ff3b30;">管理</span>
                        <span class="sticker-panel-manage" onclick="openStickerUpload()">添加</span>
                        <span class="sticker-panel-manage" onclick="openStickerCategoryPage()" style="color:#333;">分类</span>
                    </div>
                </div>
                <!-- 分类筛选栏 -->
                <div class="sticker-category-bar" id="stickerCategoryBar">
                    <!-- 由JS动态渲染分类标签 -->
                </div>
                <!-- 删除模式操作栏 -->
                <div class="sticker-delete-bar" id="stickerDeleteBar" style="display:none;">
                    <span class="sticker-panel-manage" onclick="selectAllStickers()">全选</span>
                    <span id="stickerSelectedCount" style="font-size:12px;color:#999;">已选 0 个</span>
                    <span class="sticker-panel-manage" style="color:#ff3b30;" onclick="deleteSelectedStickers()">删除</span>
                </div>
                <div class="sticker-grid" id="stickerGrid">
                    <!-- 表情包列表由JS动态渲染 -->
                </div>
            </div>

            <!-- 表情包分类管理页面 -->
            <div class="sticker-category-page" id="stickerCategoryPage">
                <div class="sticker-category-page-header">
                    <span class="sticker-panel-manage" onclick="closeStickerCategoryPage()">← 返回</span>
                    <span style="font-size:15px;font-weight:600;color:#333;">表情分类</span>
                    <span style="width:50px;"></span>
                </div>
                <!-- 分类方向选择 -->
                <div class="sticker-category-direction" id="stickerCategoryDirection">
                    <div class="sticker-category-direction-item" onclick="openUserCategoryManage()">
                        <div style="width:44px;height:44px;background:#f0f0f0;border-radius:12px;display:flex;align-items:center;justify-content:center;">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#555" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                            </svg>
                        </div>
                        <div style="font-size:14px;font-weight:500;color:#333;">用户分类</div>
                        <div style="font-size:11px;color:#999;">管理表情包分类</div>
                    </div>
                    <div class="sticker-category-direction-item" onclick="openCharCategoryManage()">
                        <div style="width:44px;height:44px;background:#f0f0f0;border-radius:12px;display:flex;align-items:center;justify-content:center;">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#555" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                        </div>
                        <div style="font-size:14px;font-weight:500;color:#333;">角色分类</div>
                        <div style="font-size:11px;color:#999;">按角色归类表情</div>
                    </div>
                </div>
                <!-- 用户分类管理 -->
                <div class="sticker-category-manage" id="userCategoryManage" style="display:none;">
                    <div style="padding:12px 16px;display:flex;align-items:center;justify-content:space-between;">
                        <span style="font-size:14px;font-weight:500;color:#333;">用户分类管理</span>
                        <span class="sticker-panel-manage" onclick="showAddCategoryDialog()">+ 新建分类</span>
                    </div>
                    <div class="sticker-category-list" id="userCategoryList">
                        <!-- 由JS动态渲染 -->
                    </div>
                    <!-- 批量转移区域 -->
                    <div style="padding:12px 16px;">
                        <div style="font-size:13px;color:#999;margin-bottom:10px;">批量转移</div>
                        <!-- 转移目标类型 -->
                        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
                            <span style="font-size:12px;color:#666;">转移到：</span>
                            <select id="transferTargetType" class="sticker-category-select" onchange="onTransferTargetTypeChange()">
                                <option value="user">用户分类</option>
                                <option value="char">角色分类</option>
                            </select>
                        </div>
                        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                            <select id="transferFromCategory" class="sticker-category-select">
                                <option value="">从分类...</option>
                            </select>
                            <span style="color:#999;font-size:13px;">→</span>
                            <select id="transferToCategory" class="sticker-category-select">
                                <option value="">到分类...</option>
                            </select>
                            <button class="sticker-category-transfer-btn" onclick="batchTransferCategory()">转移</button>
                        </div>
                    </div>
                    <!-- 表情包分配区域 -->
                    <div style="padding:0 16px 16px;">
                        <div style="font-size:13px;color:#999;margin-bottom:10px;">表情包分配</div>
                        <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;">
                            <span style="font-size:12px;color:#666;">移动到：</span>
                            <select id="assignCategorySelect" class="sticker-category-select">
                                <option value="">选择目标分类</option>
                            </select>
                            <button class="sticker-category-transfer-btn" onclick="assignSelectedToCategory()">确认</button>
                        </div>
                        <div class="sticker-assign-grid" id="stickerAssignGrid">
                            <!-- 由JS动态渲染 -->
                        </div>
                    </div>
                </div>
                <!-- 角色分类管理 -->
                <div class="sticker-category-manage" id="charCategoryManage" style="display:none;">
                    <div style="padding:12px 16px;display:flex;align-items:center;justify-content:space-between;">
                        <span style="font-size:14px;font-weight:500;color:#333;">角色分类管理</span>
                        <span class="sticker-panel-manage" onclick="showAddCharCategoryDialog()">+ 新建分类</span>
                    </div>
                    <!-- 当前角色提示 -->
                    <div style="padding:4px 16px 8px;font-size:12px;color:#007AFF;" id="charCategoryCurrentHint">
                        当前角色：未选择
                    </div>
                    <div class="sticker-category-list" id="charCategoryList">
                        <!-- 由JS动态渲染 -->
                    </div>
                    <!-- 批量转移区域 -->
                    <div style="padding:12px 16px;">
                        <div style="font-size:13px;color:#999;margin-bottom:10px;">批量转移</div>
                        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                            <select id="charTransferFromCategory" class="sticker-category-select">
                                <option value="">从分类...</option>
                            </select>
                            <span style="color:#999;font-size:13px;">→</span>
                            <select id="charTransferToCategory" class="sticker-category-select">
                                <option value="">到分类...</option>
                            </select>
                            <button class="sticker-category-transfer-btn" onclick="batchCharTransferCategory()">转移</button>
                        </div>
                    </div>
                    <!-- 表情包分配区域 -->
                    <div style="padding:0 16px 16px;">
                        <div style="font-size:13px;color:#999;margin-bottom:10px;">表情包管理</div>
                        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap;">
                            <span style="font-size:12px;color:#666;">移动到分类：</span>
                            <select id="charAssignCategorySelect" class="sticker-category-select">
                                <option value="">选择目标分类</option>
                            </select>
                            <button class="sticker-category-transfer-btn" onclick="assignSelectedToCharCategory()">确认</button>
                        </div>
                        <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap;">
                            <button class="sticker-category-transfer-btn" onclick="batchEditCharStickerAccess()" style="background:#007AFF;">按表情包编辑</button>
                            <button class="sticker-category-transfer-btn" onclick="batchEditCharAccessByCategory()" style="background:#34C759;">按分类编辑</button>
                        </div>
                        <div style="font-size:11px;color:#999;margin-bottom:8px;">点击选中表情包，点 ✎ 可单独编辑可用角色</div>
                        <div class="sticker-assign-grid" id="charStickerAssignGrid">
                            <!-- 由JS动态渲染 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 表情包上传弹窗（放在chatDetailPage内部，避免层级被遮挡） -->
            <div class="sticker-upload-overlay" id="stickerUploadOverlay">
                <div class="sticker-upload-box">
                    <div class="sticker-upload-header">添加表情包</div>
                    <div class="sticker-upload-body">
                        <!-- 主分类选择：用户分类 / 角色分类 -->
                        <div class="sticker-upload-category-row">
                            <span class="sticker-upload-category-label">分类类型</span>
                            <select class="sticker-upload-category-select" id="stickerUploadMainType" onchange="onUploadMainTypeChange()">
                                <option value="user">用户分类</option>
                                <option value="char">角色分类</option>
                            </select>
                        </div>
                        <!-- 子分类选择 -->
                        <div class="sticker-upload-category-row">
                            <span class="sticker-upload-category-label">添加到分类</span>
                            <select class="sticker-upload-category-select" id="stickerUploadCategorySelect"></select>
                        </div>
                        <!-- 角色分类全局开关 -->
                        <div class="sticker-upload-category-row" id="stickerUploadGlobalRow" style="display:none;">
                            <span class="sticker-upload-category-label">全角色可用</span>
                            <label class="ios-switch" style="margin-left:auto;">
                                <input type="checkbox" id="stickerUploadGlobalToggle">
                                <span class="ios-slider"></span>
                            </label>
                        </div>
                        <div class="sticker-upload-area" id="stickerUploadArea" onclick="document.getElementById('stickerFileInput').click()">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            <div>点击选择图片（支持批量）</div>
                        </div>
                        <input type="file" id="stickerFileInput" accept="image/*" multiple style="display:none" onchange="handleStickerFileSelect(event)">
                        <div class="sticker-upload-area" onclick="document.getElementById('stickerDocInput').click()" style="padding:14px 16px;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                            </svg>
                            <div>导入文件解析URL（txt / docx / csv / json）</div>
                        </div>
                        <input type="file" id="stickerDocInput" accept=".txt,.docx,.csv,.json,.md,.tsv" style="display:none" onchange="handleStickerDocImport(event)">
                        <div id="stickerDocStatus" style="display:none;font-size:12px;color:#007AFF;padding:2px 0;"></div>
                        <textarea class="sticker-url-input" id="stickerUrlInput" placeholder="每行一个，支持多种格式：&#10;生气 https://example.com/angry.gif&#10;开心:https://example.com/happy.png&#10;委屈：https://example.com/sad.gif&#10;https://example.com/other.png" rows="4" style="resize:none"></textarea>
                        <div class="sticker-url-hint">名称和URL之间可用空格、冒号（: ：）分隔，也可以只填URL</div>
                        <div class="sticker-upload-preview" id="stickerUploadPreview"></div>
                        <div class="sticker-upload-actions">
                            <button class="sticker-btn-cancel" onclick="closeStickerUpload()">取消</button>
                            <button class="sticker-btn-confirm" onclick="confirmStickerUpload()">确认添加</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 表情包命名弹窗 -->
            <div class="sticker-naming-overlay" id="stickerNamingOverlay">
                <div class="sticker-naming-box">
                    <div class="sticker-naming-header">给表情包命名</div>
                    <div class="sticker-naming-counter" id="stickerNamingCounter">1 / 1</div>
                    <div class="sticker-naming-preview" id="stickerNamingPreview">
                        <img id="stickerNamingImage" src="" alt="sticker">
                    </div>
                    <input type="text" class="sticker-naming-input" id="stickerNamingInput" placeholder="输入表情名称，如：生气、开心" maxlength="20">
                    <div class="sticker-naming-actions">
                        <button onclick="skipStickerNaming()">跳过</button>
                        <button onclick="confirmStickerNaming()">确定</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增聊天角色界面 -->
    <div class="settings-page" id="addChatCharacterPage" style="z-index: 2002;">
        <div class="settings-content">
            <div class="settings-header">
                <div class="back-btn" onclick="closeAddChatCharacter()">←</div>
                <div class="settings-title">新增聊天</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <!-- 头像上传 -->
                <div style="text-align: center; margin-bottom: 30px;">
                    <div class="chat-character-avatar-preview" id="chatCharacterAvatarPreview">
                        <span id="chatCharacterAvatarPlaceholder">头像</span>
                        <img id="chatCharacterAvatarImage" style="display: none; width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                    </div>
                    <div style="margin-top: 15px; font-size: 12px; color: #999;">角色头像</div>
                </div>

                <!-- 头像上传方式 -->
                <div class="section-title" style="margin-bottom: 20px;">
                    <span class="section-title-text">上传头像</span>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 30px;">
                    <button class="btn-primary" onclick="document.getElementById('chatCharacterAvatarInput').click()">
                        本地上传
                    </button>
                    <button class="btn-primary" onclick="showChatCharacterUrlInput()">
                        URL 上传
                    </button>
                </div>

                <input type="file" id="chatCharacterAvatarInput" accept="image/*" style="display: none;" onchange="handleChatCharacterAvatarUpload(event)">

                <!-- URL输入框（默认隐藏） -->
                <div id="chatCharacterUrlInputSection" style="display: none; margin-bottom: 30px;">
                    <div class="form-group">
                        <label class="form-label">图片URL地址</label>
                        <input type="url" class="form-input" id="chatCharacterAvatarUrl" placeholder="https://example.com/avatar.jpg">
                    </div>
                    <button class="btn-primary" onclick="loadChatCharacterAvatarFromUrl()" style="background: #007bff; color: white; border: none;">
                        加载图片
                    </button>
                </div>

                <!-- 基本信息 -->
                <div class="section-title" style="margin-top: 30px; margin-bottom: 20px;">
                    <span class="section-title-text">基本信息</span>
                </div>

                <div class="form-group">
                    <label class="form-label">角色姓名（真名）</label>
                    <input type="text" class="form-input" id="chatCharacterNameInput" placeholder="请输入角色姓名" maxlength="20">
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        最多20个字符
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">给角色的备注</label>
                    <input type="text" class="form-input" id="chatCharacterRemarkInput" placeholder="请输入备注名称" maxlength="20">
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        显示在聊天列表中的名称
                    </div>
                </div>

                <!-- 角色描述 -->
                <div class="form-group">
                    <label class="form-label">角色人物描述</label>
                    <textarea class="form-input" id="chatCharacterDescInput" placeholder="请输入角色描述" rows="6" style="resize: vertical; min-height: 150px;"></textarea>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        详细描述角色的性格、特点、背景等信息
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button class="btn-primary" onclick="closeAddChatCharacter()" style="flex: 1; background: #dc3545; color: white; border: none;">
                        取消
                    </button>
                    <button class="btn-primary btn-save" onclick="saveChatCharacter()" style="flex: 1;">
                        保存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SillyTavern 导入界面 -->
    <div class="settings-page" id="sillyTavernImportPage" style="z-index: 2002;">
        <div class="settings-content">
            <div class="settings-header">
                <div class="back-btn" onclick="closeSillyTavernImport()">←</div>
                <div class="settings-title">SillyTavern 导入</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <div class="section-title">
                    <span class="section-title-text">上传文件</span>
                </div>
                
                <div class="form-group">
                    <label class="form-label">选择 personas JSON 文件</label>
                    <input type="file" id="sillyTavernFileInput" accept=".json" style="display: none;" onchange="handleSillyTavernFile(event)">
                    <button class="btn-primary" onclick="document.getElementById('sillyTavernFileInput').click()" style="width: 100%;">
                        选择文件
                    </button>
                    <div style="margin-top: 12px; font-size: 12px; color: #666;">
                        支持 SillyTavern 导出的 personas.json 文件
                    </div>
                </div>

                <!-- 文件信息显示 -->
                <div id="sillyTavernFileInfo" style="display: none; margin-top: 20px;">
                    <div style="padding: 15px; background-color: #f0f8ff; border-radius: 12px; border: 1px solid #d0e8ff;">
                        <div style="font-size: 14px; color: #333; margin-bottom: 8px;">
                            <strong>已选择文件：</strong><span id="sillyTavernFileName"></span>
                        </div>
                        <div style="font-size: 14px; color: #666;">
                            <strong>检测到人设数量：</strong><span id="sillyTavernPersonaCount"></span>
                        </div>
                    </div>
                    
                    <button class="btn-primary btn-save" onclick="showPersonaSelectionDialog()" style="width: 100%; margin-top: 20px;">
                        选择要导入的人设
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 人设选择对话框 -->
    <div class="settings-page" id="personaSelectionDialog" style="z-index: 2003; display: none;">
        <div class="settings-content">
            <div class="settings-header">
                <div class="back-btn" onclick="closePersonaSelection()">←</div>
                <div class="settings-title">选择人设</div>
                <div class="add-btn" onclick="selectAllImportPersonas()" style="font-size: 14px; width: auto; padding: 8px 16px; border-radius: 20px;">全选</div>
            </div>

            <div class="settings-card">
                <div class="section-title">
                    <span class="section-title-text">可导入的人设</span>
                </div>
                
                <!-- 人设列表 -->
                <div id="importPersonaList" class="import-persona-list"></div>

                <!-- 导入按钮 -->
                <div style="position: fixed; bottom: 20px; left: 20px; right: 20px; max-width: 360px; margin: 0 auto;">
                    <button class="btn-primary btn-save" onclick="importSelectedPersonas()" style="width: 100%;">
                        导入选中的人设 (<span id="selectedImportCount">0</span>)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑身份ID弹窗 -->
    <div class="settings-page" id="profileIdModal" style="z-index: 2002;">
        <div class="settings-content" style="max-width: 400px;">
            <div class="settings-header">
                <div class="back-btn" onclick="closeProfileIdModal()">←</div>
                <div class="settings-title">编辑ID</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <div class="section-title">
                    <span class="section-title-text">身份ID</span>
                </div>
                
                <!-- ID预览 -->
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="padding: 30px 20px; background-color: #f8f8f8; border-radius: 16px; border: 2px solid #e0e0e0;">
                        <div style="font-size: 24px; font-weight: 500; color: #333;" id="profileIdPreview">未设置</div>
                        <div style="font-size: 12px; color: #999; margin-top: 8px;">预览效果</div>
                    </div>
                </div>

                <!-- ID输入 -->
                <div class="form-group">
                    <label class="form-label">输入ID</label>
                    <input type="text" class="form-input" id="profileIdInput" placeholder="请输入ID" maxlength="50" oninput="updateProfileIdPreview()">
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        最多50个字符，ID将显示在身份卡中
                    </div>
                </div>

                <!-- 条形码预览 -->
                <div style="text-align: center; margin-top: 30px; padding: 20px; background-color: #ffffff; border-radius: 12px; border: 1px solid #e5e5e5;">
                    <div style="font-size: 12px; color: #999; margin-bottom: 10px;">条形码预览</div>
                    <canvas id="profileBarcodePreview" width="200" height="50"></canvas>
                </div>

                <!-- 操作按钮 -->
                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button class="btn-primary" onclick="resetProfileId()" style="flex: 1; background: #dc3545; color: white; border: none;">
                        清空ID
                    </button>
                    <button class="btn-primary btn-save" onclick="saveProfileId()" style="flex: 1;">
                        保存ID
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 创建群聊界面 -->
    <div class="settings-page" id="createGroupPage" style="z-index: 10001;">
        <div class="settings-content">
            <div class="settings-header">
                <div class="back-btn" onclick="closeCreateGroup()">←</div>
                <div class="settings-title">创建群聊</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <div class="section-title">
                    <span class="section-title-text">选择成员</span>
                </div>
                
                <!-- 成员选择列表 -->
                <div id="groupMemberSelectList" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;"></div>

                <!-- 下一步按钮 -->
                <button class="btn-primary btn-save" onclick="proceedToGroupSettings()" style="width: 100%;">
                    下一步
                </button>
            </div>
        </div>
    </div>

    <!-- 群聊设置界面（成员关系） -->
    <div class="settings-page" id="groupRelationPage" style="z-index: 10002;">
        <div class="settings-content">
            <div class="settings-header">
                <div class="back-btn" onclick="closeGroupRelation()">←</div>
                <div class="settings-title">成员关系设置</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <div class="section-title">
                    <span class="section-title-text">哪些成员认识你？</span>
                </div>
                
                <div style="padding: 12px; background: #f8f8f8; border-radius: 8px; margin-bottom: 20px; font-size: 13px; color: #666;">
                    认识你的成员可以访问与你的私聊记忆，不认识的成员只能看到群聊历史
                </div>

                <!-- 成员关系列表 -->
                <div id="groupRelationList" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;"></div>

                <!-- 群基本信息 -->
                <div class="section-title" style="margin-top: 30px;">
                    <span class="section-title-text">群基本信息</span>
                </div>

                <div class="form-group">
                    <label class="form-label">群名称</label>
                    <input type="text" class="form-input" id="groupNameInput" placeholder="请输入群名称" maxlength="30">
                </div>

                <div class="form-group">
                    <label class="form-label">群头像</label>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="width: 80px; height: 80px; border-radius: 12px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px solid #e0e0e0;">
                            <span id="groupAvatarPlaceholder" style="font-size: 12px; color: #999;">群头像</span>
                            <img id="groupAvatarImage" style="display: none; width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <div style="flex: 1;">
                            <input type="file" id="groupAvatarUpload" accept="image/*" style="display: none;" onchange="handleGroupAvatarUpload(event)">
                            <button class="btn-primary" onclick="document.getElementById('groupAvatarUpload').click()" style="width: 100%; margin-bottom: 8px;">
                                选择图片
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 群主设置 -->
                <div class="form-group">
                    <label class="form-label">群主</label>
                    <select class="form-input" id="groupOwnerSelect">
                        <option value="">请选择群主</option>
                    </select>
                </div>

                <!-- 完成按钮 -->
                <button class="btn-primary btn-save" onclick="finishCreateGroup()" style="width: 100%; margin-top: 20px;">
                    完成创建
                </button>
            </div>
        </div>
    </div>

    <!-- 数据管理界面 -->
    <div class="settings-page" id="dataManagementSettings">
        <div class="settings-content">
            <div class="settings-header">
                <div class="back-btn" onclick="closeDataManagement()">←</div>
                <div class="settings-title">数据管理</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <!-- 浏览器存储容量 -->
                <div class="section-title">
                    <span class="section-title-text">浏览器存储容量</span>
                </div>

                <div class="form-group">
                    <div style="background: #ffffff; border: 2px solid #e5e5ea; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px;">
                            <div>
                                <div style="font-size: 12px; color: #999; margin-bottom: 5px;">已使用空间</div>
                                <div id="storageUsage" style="font-size: 32px; font-weight: 600; color: #000;">0 MB</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 12px; color: #999; margin-bottom: 5px;">总分配空间</div>
                                <div id="storageQuota" style="font-size: 18px; font-weight: 500; color: #666;">0 MB</div>
                            </div>
                        </div>
                        <div style="width: 100%; height: 6px; background: #f0f0f0; border-radius: 3px; overflow: hidden; margin-bottom: 12px;">
                            <div id="storageBar" style="width: 0%; height: 100%; background: #007aff; transition: width 0.3s ease;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div id="storagePercentage" style="font-size: 13px; color: #666;">0% 已使用</div>
                            <button onclick="refreshStorageInfo()" style="padding: 6px 16px; background: #ffffff; color: #007aff; border: 1px solid #007aff; border-radius: 6px; cursor: pointer; font-size: 13px; transition: all 0.2s;">刷新</button>
                        </div>
                    </div>

                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 3px solid #007aff;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 8px; font-weight: 600;">存储说明</div>
                        <div style="font-size: 12px; color: #666; line-height: 1.8;">
                            显示的是浏览器为本站点分配的总存储空间（包括IndexedDB、localStorage等所有存储），并非仅图片大小。图片数据存储在IndexedDB中，自动压缩以节省空间。
                        </div>
                    </div>
                </div>

                <!-- 数据统计 -->
                <div class="section-title" style="margin-top: 30px;">
                    <span class="section-title-text">数据统计</span>
                </div>

                <div class="form-group">
                    <!-- 数据统计卡片 -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 15px;">
                        <div style="background: #ffffff; border: 2px solid #e5e5ea; padding: 18px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 28px; font-weight: 600; color: #000; margin-bottom: 8px;" id="imageCount">0</div>
                            <div style="font-size: 12px; color: #999; font-weight: 500;">图片数量</div>
                        </div>
                        <div style="background: #ffffff; border: 2px solid #e5e5ea; padding: 18px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 28px; font-weight: 600; color: #000; margin-bottom: 8px;" id="chatCount">0</div>
                            <div style="font-size: 12px; color: #999; font-weight: 500;">聊天记录</div>
                        </div>
                        <div style="background: #ffffff; border: 2px solid #e5e5ea; padding: 18px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 28px; font-weight: 600; color: #000; margin-bottom: 8px;" id="characterCount">0</div>
                            <div style="font-size: 12px; color: #999; font-weight: 500;">聊天角色</div>
                        </div>
                        <div style="background: #ffffff; border: 2px solid #e5e5ea; padding: 18px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 28px; font-weight: 600; color: #000; margin-bottom: 8px;" id="fileCount">0</div>
                            <div style="font-size: 12px; color: #999; font-weight: 500;">文件数量</div>
                        </div>
                    </div>

                    <!-- 饼状图 -->
                    <div style="background: #ffffff; border: 2px solid #e5e5ea; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="font-size: 14px; color: #333; font-weight: 500; margin-bottom: 15px; text-align: center;">数据分布</div>
                        <canvas id="dataChart" style="max-width: 300px; max-height: 300px; margin: 0 auto; display: block;"></canvas>
                        <div id="chartLegend" style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; font-size: 12px;"></div>
                    </div>

                    <button class="data-action-btn secondary-btn" onclick="showDataDetails()">
                        查看详细信息
                    </button>
                </div>

                <!-- 图片压缩功能 -->
                <div class="section-title" style="margin-top: 30px;">
                    <span class="section-title-text">图片压缩</span>
                </div>

                <div class="form-group">
                    <!-- 压缩说明 -->
                    <div style="padding: 12px; background: #f8f8f8; border: 1px solid #e5e5ea; border-radius: 6px; font-size: 12px; color: #666; line-height: 1.6; margin-bottom: 15px;">
                        压缩图片可减少内存占用，防止大图片导致的闪退和卡顿问题
                    </div>

                    <!-- 压缩质量设置 -->
                    <div style="background: #ffffff; border: 2px solid #e5e5ea; padding: 18px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <span style="font-size: 14px; color: #333; font-weight: 500;">压缩质量</span>
                            <span style="font-size: 16px; font-weight: 600; color: #007aff;" id="compressionQuality">80%</span>
                        </div>
                        
                        <!-- 滑动条 -->
                        <div style="position: relative; margin-bottom: 8px;">
                            <input type="range" 
                                   id="compressionSlider" 
                                   min="10" 
                                   max="100" 
                                   value="80" 
                                   step="5"
                                   oninput="updateCompressionQuality(this.value)"
                                   style="width: 100%; height: 6px; border-radius: 3px; background: #e5e5ea; outline: none; -webkit-appearance: none; appearance: none;">
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; font-size: 11px; color: #999;">
                            <span>低质量(小)</span>
                            <span>高质量(大)</span>
                        </div>
                    </div>

                    <!-- 压缩选项 -->
                    <div style="background: #ffffff; border: 2px solid #e5e5ea; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none;">
                            <span style="font-size: 14px; color: #333; font-weight: 500;">压缩小组件图片</span>
                            <div style="position: relative;">
                                <input type="checkbox" 
                                       id="compressWidgetImages" 
                                       checked
                                       onchange="toggleWidgetCompression(this.checked)"
                                       style="position: absolute; opacity: 0; width: 0; height: 0;">
                                <div class="custom-switch" id="widgetSwitch">
                                    <div class="custom-switch-slider"></div>
                                </div>
                            </div>
                        </label>
                        <div style="font-size: 11px; color: #999; margin-top: 8px; line-height: 1.4;">
                            包括头像、音乐封面、贴纸等小组件图片
                        </div>
                    </div>

                    <!-- 压缩按钮 -->
                    <button class="data-action-btn secondary-btn" 
                            onclick="compressAllImages()" 
                            id="compressBtn">
                        开始压缩图片
                    </button>

                    <!-- 压缩进度 -->
                    <div id="compressionProgress" style="display: none; margin-top: 12px;">
                        <div style="background: #f8f8f8; border: 1px solid #e5e5ea; padding: 12px; border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-size: 13px; color: #333;">压缩进度</span>
                                <span style="font-size: 13px; font-weight: 600; color: #007aff;" id="progressText">0%</span>
                            </div>
                            <div style="width: 100%; height: 6px; background: #e5e5ea; border-radius: 3px; overflow: hidden;">
                                <div id="progressBar" style="width: 0%; height: 100%; background: #007aff; transition: width 0.3s;"></div>
                            </div>
                            <div style="font-size: 11px; color: #999; margin-top: 8px;" id="progressDetail">准备压缩...</div>
                        </div>
                    </div>
                </div>

                <!-- 数据管理操作 -->
                <div class="section-title" style="margin-top: 30px;">
                    <span class="section-title-text">数据操作</span>
                </div>

                <div class="form-group">
                    <button class="data-action-btn export-btn" onclick="showExportOptions()">
                        导出数据
                    </button>
                    
                    <button class="data-action-btn" onclick="importBackupData()" style="background: #34c759; color: #fff; border: none;">
                        导入备份
                    </button>
                    
                    <button class="data-action-btn secondary-btn" onclick="cleanRedundantData()">
                        清除冗余数据
                    </button>
                    
                    <button class="data-action-btn secondary-btn" onclick="clearAllImages()">
                        清空所有图片
                    </button>
                    
                    <button class="data-action-btn clear-all-btn" onclick="clearAllData()">
                        清空所有数据
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 密码输入界面（在锁屏上方弹出） -->
    <div class="password-screen" id="passwordScreen">
        <div class="password-screen-content">
            <div class="password-header">请输入密码</div>
            
            <div class="password-dots">
                <div class="password-dot" id="dot1"></div>
                <div class="password-dot" id="dot2"></div>
                <div class="password-dot" id="dot3"></div>
                <div class="password-dot" id="dot4"></div>
            </div>

            <div class="password-error" id="passwordError">密码错误，请重试</div>

            <div class="password-keypad">
                <div class="keypad-row">
                    <div class="keypad-key" onclick="inputPassword('1')">1</div>
                    <div class="keypad-key" onclick="inputPassword('2')">2</div>
                    <div class="keypad-key" onclick="inputPassword('3')">3</div>
                </div>
                <div class="keypad-row">
                    <div class="keypad-key" onclick="inputPassword('4')">4</div>
                    <div class="keypad-key" onclick="inputPassword('5')">5</div>
                    <div class="keypad-key" onclick="inputPassword('6')">6</div>
                </div>
                <div class="keypad-row">
                    <div class="keypad-key" onclick="inputPassword('7')">7</div>
                    <div class="keypad-key" onclick="inputPassword('8')">8</div>
                    <div class="keypad-key" onclick="inputPassword('9')">9</div>
                </div>
                <div class="keypad-row">
                    <div class="keypad-key keypad-empty"></div>
                    <div class="keypad-key" onclick="inputPassword('0')">0</div>
                    <div class="keypad-key keypad-delete" onclick="deletePassword()">⌫</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 手势密码设置界面 -->
    <div class="gesture-setup-screen" id="gestureSetupScreen">
        <div class="gesture-setup-content">
            <div class="gesture-setup-header">
                <div class="back-btn" onclick="closeGestureSetup()">取消</div>
                <div class="gesture-setup-title" id="gestureSetupTitle">绘制解锁手势</div>
                <div style="width: 44px;"></div>
            </div>
            <div class="gesture-hint" id="gestureHint">至少连接4个点</div>
            <canvas id="gestureSetupCanvas" class="gesture-canvas"></canvas>
            <button class="btn-primary" id="gestureConfirmBtn" onclick="confirmGesture()" style="display: none; margin-top: 20px; width: 80%; max-width: 300px;">
                确认手势
            </button>
        </div>
    </div>

    <!-- APP图标编辑弹窗 -->
    <div class="settings-page" id="appIconModal" style="z-index: 2000;">
        <div class="settings-content" style="max-width: 400px;">
            <div class="settings-header">
                <div class="back-btn" onclick="closeAppIconModal()">←</div>
                <div class="settings-title">更换图标</div>
                <div style="width: 44px;"></div>
            </div>
            <div class="settings-card">
                <div class="section-title">
                    <span class="section-title-text" id="appIconModalLabel">编辑图标</span>
                </div>
                <!-- 图标预览 -->
                <div style="text-align: center; margin-bottom: 24px;">
                    <div id="appIconPreviewBox" style="width: 80px; height: 80px; margin: 0 auto; border-radius: 16px; overflow: hidden; background-color: #f5f5f5; display: flex; align-items: center; justify-content: center; border: 2px solid #e0e0e0; font-size: 28px; color: #333;">
                        <span id="appIconPreviewText"></span>
                        <img id="appIconPreviewImg" style="display: none; width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #999;">预览效果</div>
                </div>
                <!-- 本地上传 -->
                <div class="form-group">
                    <label class="form-label">本地上传</label>
                    <input type="file" id="appIconFileInput" accept="image/*" style="display: none;" onchange="handleAppIconFileUpload(event)">
                    <button class="btn-primary" onclick="document.getElementById('appIconFileInput').click()" style="width: 100%;">选择本地图片</button>
                </div>
                <!-- URL上传 -->
                <div class="form-group">
                    <label class="form-label">图片URL</label>
                    <input type="text" class="form-input" id="appIconUrlInput" placeholder="输入图片链接地址">
                    <button class="btn-primary" onclick="handleAppIconUrlUpload()" style="width: 100%; margin-top: 10px;">加载URL图片</button>
                </div>
                <!-- 操作按钮 -->
                <div style="display: flex; gap: 10px; margin-top: 24px;">
                    <button class="btn-primary" onclick="resetAppIcon()" style="flex: 1; background: #ff3b30; color: white; border: none;">重置图标</button>
                    <button class="btn-primary btn-save" onclick="saveAppIcon()" style="flex: 1;">保存图标</button>
                </div>
            </div>
        </div>
    </div>

    <!-- APP名称编辑弹窗 -->
    <div class="settings-page" id="appNameModal" style="z-index: 2000;">
        <div class="settings-content" style="max-width: 400px;">
            <div class="settings-header">
                <div class="back-btn" onclick="closeAppNameModal()">←</div>
                <div class="settings-title">修改名称</div>
                <div style="width: 44px;"></div>
            </div>
            <div class="settings-card">
                <div class="section-title">
                    <span class="section-title-text" id="appNameModalLabel">编辑名称</span>
                </div>
                <!-- 名称预览 -->
                <div style="text-align: center; margin-bottom: 24px;">
                    <div style="padding: 20px; background-color: #f8f8f8; border-radius: 16px; border: 2px solid #e0e0e0;">
                        <div style="font-size: 18px; font-weight: 500; color: #333;" id="appNamePreview"></div>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #999;">预览效果</div>
                </div>
                <!-- 名称输入 -->
                <div class="form-group">
                    <label class="form-label">输入新名称</label>
                    <input type="text" class="form-input" id="appNameInput" placeholder="请输入名称" maxlength="10" oninput="document.getElementById('appNamePreview').textContent = this.value || ''">
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">最多10个字符</div>
                </div>
                <!-- 操作按钮 -->
                <div style="display: flex; gap: 10px; margin-top: 24px;">
                    <button class="btn-primary" onclick="resetSingleAppName()" style="flex: 1; background: #ff3b30; color: white; border: none;">重置名称</button>
                    <button class="btn-primary btn-save" onclick="saveAppName()" style="flex: 1;">保存名称</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 手势密码输入界面（在锁屏上方弹出） -->
    <div class="password-screen" id="gestureScreen">
        <div class="password-screen-content" style="padding: 30px;">
            <div class="password-header">绘制手势解锁</div>
            <div class="password-error" id="gestureError" style="margin-bottom: 15px;">手势错误，请重试</div>
            <canvas id="gestureCanvas" class="gesture-canvas"></canvas>
        </div>
    </div>

    <div class="phone-container">
        <!-- 状态栏 -->
        <div class="status-bar">
            <div class="time" id="time">9:41</div>
            <div class="status-icons">
                <div class="battery-container">
                    <div class="battery-body">
                        <span class="battery-percentage" id="batteryPercentage">100</span>
                    </div>
                    <div class="battery-head"></div>
                </div>
            </div>
        </div>

        <!-- 主屏幕（滑动翻页容器） -->
        <div class="main-screen" id="mainScreen">
            <div class="home-pages-wrapper" id="homePagesWrapper">
                <!-- 第一页：主屏幕（受方案切换影响） -->
                <div class="home-page" id="homePage1">
            <!-- 小组件区域（可切换方案） -->
            <div id="widgetArea">
            <!-- 小组件 -->
            <div class="widget">
                <div class="widget-header">
                    <div class="widget-avatar" id="widgetAvatar" onclick="openAvatarModal()">
                        <span id="avatarPlaceholder">头像</span>
                        <img id="avatarImage" style="display: none; width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                    </div>
                    <div class="widget-info">
                        <div class="widget-name" id="widgetName" onclick="openNameModal()">习惯</div>
                        <div class="widget-id" id="widgetId" onclick="openIdModal()">@1234</div>
                    </div>
                    <div class="widget-date">
                        <span id="widgetDateText">10月18日</span>
                        <span id="widgetDayText">星期六</span>
                    </div>
                </div>
                <div class="widget-content" id="widgetContent" onclick="openContentModal()">
                    被你牽著的手是不可能的畫面
                </div>
            </div>

            <!-- 本子小组件 -->
            <div class="notebook-widget">
                <div class="notebook-left">
                    <div class="notebook-inner-left">
                        <div class="notebook-weather" id="notebookLoveDate" onclick="openLoveDateModal()">相恋日期：520</div>
                        <div class="notebook-datetime" id="notebookDateTime">11月23日 14:50</div>
                        <div class="notebook-text" id="notebookText" onclick="openNotebookTextModal()">跨越时空的思念</div>
                    </div>
                </div>
                <div class="notebook-holes">
                    <div class="hole"></div>
                    <div class="hole"></div>
                    <div class="hole"></div>
                    <div class="hole"></div>
                    <div class="hole"></div>
                </div>
                <div class="notebook-right">
                    <div class="notebook-inner-right">
                        <div class="notebook-sticker" id="notebookSticker" onclick="openNotebookImageModal()">
                            <div class="notebook-image-placeholder" id="notebookImagePlaceholder">图片</div>
                            <img id="notebookImage" style="display: none; width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 音乐播放器小组件 -->
            <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                <div class="music-widget" style="flex: 1; margin-bottom: 0;">
                    <div class="music-header">
                        <div style="position: relative; display: inline-block;">
                            <div class="music-avatar" id="musicAvatar" onclick="openMusicAvatarModal()">
                                <span id="musicAvatarPlaceholder">头像</span>
                                <img id="musicAvatarImage" style="display: none; width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                            </div>
                            <div class="music-avatar-add">+</div>
                        </div>
                        <div class="music-user-info">
                            <div class="music-username" id="musicUsername" onclick="openMusicUsernameModal()" style="cursor: pointer;">@{{user}}</div>
                            <div class="music-date" id="musicDate">2025-010-18 周六</div>
                        </div>
                    </div>
                    <div class="music-player">
                        <div class="music-top">
                            <div class="music-cover" id="musicCover" onclick="openMusicCoverModal()" style="cursor: pointer; position: relative; overflow: hidden;">
                                <span id="musicCoverPlaceholder">封面</span>
                                <img id="musicCoverImage" style="display: none; width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0;">
                            </div>
                            <div class="music-info">
                                <div class="music-title" id="currentMusicTitle">网易云Music</div>
                                <div class="music-song" id="currentMusicSong">▷ ||||||||||||| ♥ 请你听首歌♥...</div>
                                <div class="music-progress-bar" id="musicProgressBar" onclick="seekMusic(event)">
                                    <div class="music-progress-fill" id="musicProgressFill"></div>
                                </div>
                                <!-- 歌词显示区域 -->
                                <div class="music-lyric" id="musicLyric" style="margin-top: 6px; font-size: 10px; color: #999; text-align: center; min-height: 14px; line-height: 14px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 100%;"></div>
                            </div>
                        </div>
                        <div class="music-controls">
                            <div class="music-birthday">
                                <span id="musicBirthday" onclick="openMusicBirthdayModal()" style="cursor: pointer;">birthday 2000/08/01</span>
                            </div>
                            <div class="music-buttons">
                                <div class="music-btn" onclick="playPreviousSong()">⏮</div>
                                <div class="music-btn" id="playPauseBtn" onclick="togglePlayPause()">▶</div>
                                <div class="music-btn" onclick="playNextSong()">⏭</div>
                                <div class="music-btn" id="playModeBtn" onclick="togglePlayMode()" title="连续播放">列</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- APP网格区域 -->
                <div class="app-grid">
                    <div class="app-item" onclick="openChatPage()">
                        <div class="app-icon" id="appIcon-chat" data-default-text="聊">聊</div>
                        <div class="app-name" id="appName-chat" data-default-name="聊天">聊天</div>
                    </div>
                    <div class="app-item" onclick="openWorldBook()">
                        <div class="app-icon" id="appIcon-worldbook" data-default-text="书">书</div>
                        <div class="app-name" id="appName-worldbook" data-default-name="世界书">世界书</div>
                    </div>
                    <div class="app-item" onclick="openWalletPage()">
                        <div class="app-icon" id="appIcon-wallet" data-default-text="钱">钱</div>
                        <div class="app-name" id="appName-wallet" data-default-name="钱包">钱包</div>
                    </div>
                    <div class="app-item">
                        <div class="app-icon" id="appIcon-couple" data-default-text="情">情</div>
                        <div class="app-name" id="appName-couple" data-default-name="情侣空间">情侣空间</div>
                    </div>
                </div>
            </div>
            </div><!-- /widgetArea -->
                </div><!-- /homePage1 -->

                <!-- 第二页：应用页面（固定，不受方案影响） -->
                <div class="home-page" id="homePage2">
                    <div class="home-page2-content">
                        <!-- 照片展示区域 -->
                        <div class="photo-showcase" id="photoShowcase" onclick="openShowcasePhotoMenu()">
                            <img class="photo-showcase-img" id="photoShowcaseImg" style="display:none;" alt="展示照片">
                        </div>

                        <!-- 双组件行 -->
                        <div class="page2-widget-row">
                            <!-- 左：情侣红线组件 -->
                            <div class="p2-couple-widget">
                                <div class="couple-avatar couple-av-left" onclick="event.stopPropagation();openCoupleAvatarMenu('left')">
                                    <img class="couple-avatar-img" id="coupleAvatarLeft" style="display:none;" alt="">
                                </div>
                                <svg class="couple-red-thread" viewBox="0 0 120 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path class="heartbeat-line" d="M0,20 L20,20 L28,20 L34,8 L40,32 L46,4 L52,28 L58,14 L62,20 L80,20 L120,20" stroke="#e25c5c" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <div class="couple-avatar couple-av-right" onclick="event.stopPropagation();openCoupleAvatarMenu('right')">
                                    <img class="couple-avatar-img" id="coupleAvatarRight" style="display:none;" alt="">
                                </div>
                            </div>
                            <!-- 右：胶片机组件 -->
                            <div class="p2-film-widget" onclick="openTicketPhotoMenu()">
                                <!-- 出片口 -->
                                <div class="film-bar">
                                    <div class="film-slot"></div>
                                </div>
                                <!-- 票券整体 -->
                                <div class="film-body">
                                    <!-- 上半：图片+文字 -->
                                    <div class="film-upper">
                                        <div class="film-photo-box">
                                            <img class="film-photo" id="ticketPhotoImg" style="display:none;" alt="">
                                        </div>
                                        <div class="film-caption" id="ticketText">♪ 愿い叶うなら ♪</div>
                                    </div>
                                    <!-- 分割区：左右大缺口+虚线 -->
                                    <div class="film-tear">
                                        <div class="film-tear-notch film-tear-l"></div>
                                        <div class="film-tear-line"></div>
                                        <div class="film-tear-notch film-tear-r"></div>
                                    </div>
                                    <!-- 下半：星星+文字 -->
                                    <div class="film-lower">
                                        <div class="film-sparkles">✦ ✦ ✦</div>
                                        <div class="film-footer-text" id="ticketFooter">☆ 願いは叶うなら。✿</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="page2-app-grid">
                            <div class="app-item" onclick="openSmsApp()">
                                <div class="app-icon"><img src="https://i.postimg.cc/L5V56m5Y/png-(31).png" style="width:100%;height:100%;object-fit:cover;border-radius:12px;" alt="短信"></div>
                                <div class="app-name">短信</div>
                            </div>
                            <div class="app-item" onclick="openLinkApp()">
                                <div class="app-icon"><img src="https://i.postimg.cc/4y1yNXyh/png-(32).png" style="width:100%;height:100%;object-fit:cover;border-radius:12px;" alt="联机"></div>
                                <div class="app-name">联机</div>
                            </div>
                            <div class="app-item" onclick="openGameHall()">
                                <div class="app-icon"><img src="https://i.postimg.cc/nr1rcnr9/png-(57).png" style="width:100%;height:100%;object-fit:cover;border-radius:12px;" alt="游戏大厅"></div>
                                <div class="app-name">游戏大厅</div>
                            </div>
                            <div class="app-item" onclick="openForum()">
                                <div class="app-icon"><img src="https://i.postimg.cc/D0c0y70X/png-(69).png" style="width:100%;height:100%;object-fit:cover;border-radius:12px;" alt="论坛"></div>
                                <div class="app-name">论坛</div>
                            </div>
                            <!-- 新增第二行：为了与第一页底部对齐，这里添加了4个占位APP -->
                            <div class="app-item" onclick="showToast('功能开发中')">
                                <div class="app-icon" id="appIcon-calendar"><img src="https://i.postimg.cc/Px6myX5Z/png-(12).png" style="width:100%;height:100%;object-fit:cover;border-radius:12px;" alt="汽水音乐"></div>
                                <div class="app-name" id="appName-calendar" data-default-name="汽水音乐">汽水音乐</div>
                            </div>
                            <div class="app-item" onclick="showToast('功能开发中')">
                                <div class="app-icon" id="appIcon-album"><img src="https://i.postimg.cc/63HdcWpv/png-(15).png" style="width:100%;height:100%;object-fit:cover;border-radius:12px;" alt="家园"></div>
                                <div class="app-name" id="appName-album" data-default-name="家园">家园</div>
                            </div>
                            <div class="app-item" onclick="showToast('功能开发中')">
                                <div class="app-icon" id="appIcon-memo"><img src="https://i.postimg.cc/LXyzD98J/png-(18).png" style="width:100%;height:100%;object-fit:cover;border-radius:12px;" alt="月经"></div>
                                <div class="app-name" id="appName-memo" data-default-name="月经">月经</div>
                            </div>
                            <div class="app-item" onclick="showToast('功能开发中')">
                                <div class="app-icon" id="appIcon-settings"><img src="https://i.postimg.cc/1tWpBm3N/png-(26).png" style="width:100%;height:100%;object-fit:cover;border-radius:12px;" alt="宠物"></div>
                                <div class="app-name" id="appName-settings" data-default-name="宠物">宠物</div>
                            </div>
                        </div>
                    </div>
                </div><!-- /homePage2 -->
            </div><!-- /homePagesWrapper -->

            <!-- 页面指示器 -->
            <div class="home-page-dots" id="homePageDots">
                <div class="home-dot active" data-page="0"></div>
                <div class="home-dot" data-page="1"></div>
            </div>
        </div>

        <!-- 底部导航栏 -->
        <div class="bottom-dock">
            <div class="dock-container">
                <div class="dock-app" onclick="openApiSettings()">
                    <div class="dock-icon" id="appIcon-api" data-default-text="A">A</div>
                    <div class="dock-name" id="appName-api" data-default-name="API设置">API设置</div>
                </div>
                <div class="dock-app" onclick="openAppearanceSettings()">
                    <div class="dock-icon" id="appIcon-appearance" data-default-text="S">S</div>
                    <div class="dock-name" id="appName-appearance" data-default-name="外观设置">外观设置</div>
                </div>
                <div class="dock-app" onclick="openDataManagement()">
                    <div class="dock-icon" id="appIcon-data" data-default-text="D">D</div>
                    <div class="dock-name" id="appName-data" data-default-name="数据管理">数据管理</div>
                </div>
                <div class="dock-app" onclick="openFontSettings()">
                    <div class="dock-icon" id="appIcon-font" data-default-text="F">F</div>
                    <div class="dock-name" id="appName-font" data-default-name="字体设置">字体设置</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== 短信列表页 ========== -->
    <div class="settings-page" id="smsListPage" style="display: none;">
        <div class="sms-list-container">
            <!-- iOS 风格顶部栏 -->
            <div class="sms-list-header">
                <div class="sms-header-left" onclick="closeSmsApp()">
                    <svg width="10" height="18" viewBox="0 0 10 18" fill="none"><path d="M9 1L1 9L9 17" stroke="#007AFF" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </div>
                <div class="sms-header-right">
                    <div class="sms-header-compose" onclick="openContactsManager()" style="margin-right: 16px;">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" fill="#007AFF"/>
                        </svg>
                    </div>
                    <div class="sms-header-compose" onclick="openSmsCompose()">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z" fill="#007AFF"/><path d="M20.71 5.63l-2.34-2.34a1 1 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83a1 1 0 000-1.41z" fill="#007AFF"/></svg>
                    </div>
                </div>
            </div>
            <!-- iOS 大标题 -->
            <div class="sms-big-title">信息</div>
            <!-- 搜索栏 -->
            <div class="sms-search-bar">
                <div class="sms-search-inner">
                    <svg width="15" height="15" viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="#8E8E93" stroke-width="2.2"/><path d="M20 20L16.65 16.65" stroke="#8E8E93" stroke-width="2.2" stroke-linecap="round"/></svg>
                    <input type="text" class="sms-search-input" placeholder="搜索" id="smsSearchInput" oninput="filterSmsList()">
                </div>
            </div>
            <!-- 短信列表 -->
            <div class="sms-list" id="smsList">
                <div class="sms-empty">
                    <div class="sms-empty-text">暂无信息</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== 短信对话详情页 ========== -->
    <div class="settings-page" id="smsDetailPage" style="display: none; z-index: 2003;">
        <div class="sms-detail-container">
            <!-- 顶部栏 -->
            <div class="sms-detail-header">
                <div class="sms-detail-back" onclick="closeSmsDetail()">
                    <svg width="10" height="18" viewBox="0 0 10 18" fill="none"><path d="M9 1L1 9L9 17" stroke="#007AFF" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </div>
                <div class="sms-detail-contact">
                    <div class="sms-detail-avatar" id="smsDetailAvatar">
                        <img src="https://i.postimg.cc/Nf6f1665/CFEEC469058BDB0EAD269FB4D4FE5F6C.jpg" style="width:100%;height:100%;object-fit:cover;border-radius:50%;" alt="avatar">
                    </div>
                    <div class="sms-detail-name-row">
                        <div class="sms-detail-name" id="smsDetailName">号码</div>
                        <div class="sms-detail-chevron">
                            <svg width="5" height="8" viewBox="0 0 8 12" fill="none"><path d="M1 1l5 5-5 5" stroke="#C7C7CC" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </div>
                    </div>
                </div>
                <div style="width:40px;"></div>
            </div>
            <!-- 消息区域 -->
            <div class="sms-messages" id="smsMessages">
                <div class="sms-imessage-hint">信息 · 短信</div>
            </div>
            <!-- 底部输入栏 -->
            <div class="sms-input-bar">
                <div class="sms-input-plus" onclick="showToast('功能开发中')">
                    <svg width="28" height="28" viewBox="0 0 28 28" fill="none"><circle cx="14" cy="14" r="14" fill="#E5E5EA"/><path d="M14 9v10M9 14h10" stroke="#8E8E93" stroke-width="2" stroke-linecap="round"/></svg>
                </div>
                <div class="sms-input-wrapper">
                    <input type="text" class="sms-input-field" id="smsInputField" placeholder="信息 · 短信" oninput="toggleSmsSendBtn()">
                    <div class="sms-input-mic" id="smsInputMic">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z" fill="#8E8E93"/><path d="M19 11c0 3.87-3.13 7-7 7m0 0c-3.87 0-7-3.13-7-7m7 7v3m-4 0h8" stroke="#8E8E93" stroke-width="2" stroke-linecap="round"/></svg>
                    </div>
                </div>
                <div class="sms-send-btn" id="smsSendBtn" onclick="sendSmsMessage()" style="display:none;">
                    <svg width="30" height="30" viewBox="0 0 30 30" fill="none"><circle cx="15" cy="15" r="15" fill="#34C759"/><path d="M10 15.5l4 4L20 12" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== 联系人管理页面 ========== -->
    <div class="settings-page" id="contactsManagerPage" style="display: none; z-index: 2004;">
        <div class="sms-list-container">
            <!-- 顶部栏 -->
            <div class="sms-list-header">
                <div class="sms-header-left" onclick="closeContactsManager()">
                    <svg width="10" height="18" viewBox="0 0 10 18" fill="none"><path d="M9 1L1 9L9 17" stroke="#007AFF" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </div>
                <div class="sms-header-right">
                    <button id="contactsSelectAllBtn" onclick="toggleSelectAllContacts()" style="display:none;margin-right:12px;padding:6px 12px;background:transparent;border:none;color:#007AFF;font-size:15px;cursor:pointer;">全选</button>
                    <button id="contactsDeleteBtn" onclick="deleteSelectedContacts()" style="display:none;margin-right:12px;padding:6px 12px;background:transparent;border:none;color:#FF3B30;font-size:15px;cursor:pointer;">删除</button>
                    <button id="contactsCancelBtn" onclick="exitContactsEditMode()" style="display:none;margin-right:12px;padding:6px 12px;background:transparent;border:none;color:#007AFF;font-size:15px;cursor:pointer;">完成</button>
                    <button id="contactsEditBtn" onclick="enterContactsEditMode()" style="margin-right:12px;padding:6px 12px;background:transparent;border:none;color:#007AFF;font-size:15px;cursor:pointer;">编辑</button>
                    <div class="sms-header-compose" onclick="openNewContact()">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" fill="#007AFF"/>
                        </svg>
                    </div>
                </div>
            </div>
            <!-- 大标题 -->
            <div class="sms-big-title">联系人</div>
            <!-- 联系人列表 -->
            <div class="sms-list" id="contactsList" style="padding-top: 10px;">
                <div class="contacts-empty">
                    <div class="contacts-empty-text">暂无联系人</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== 联系人编辑器页面 ========== -->
    <div class="settings-page" id="contactEditorPage" style="display: none; z-index: 2005;">
        <div class="settings-content" style="max-width: 500px;">
            <div class="settings-header">
                <div class="back-btn" onclick="closeContactEditor()">←</div>
                <div class="settings-title" id="contactEditorTitle">新建联系人</div>
                <div style="width: 44px;"></div>
            </div>

            <div class="settings-card">
                <input type="hidden" id="contactEditorId">
                
                <!-- 头像 -->
                <div style="text-align: center; margin-bottom: 30px;">
                    <div id="contactAvatarPreview" style="width: 100px; height: 100px; margin: 0 auto; border-radius: 50%; overflow: hidden; background: #f0f0f0; display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="selectContactAvatar()">
                        <div class="contact-avatar-placeholder-large">+</div>
                    </div>
                    <div style="margin-top: 12px; display: flex; gap: 10px; justify-content: center;">
                        <button class="btn-primary" onclick="selectContactAvatar()" style="padding: 8px 16px; font-size: 13px;">本地上传</button>
                        <button class="btn-primary" onclick="inputContactAvatarUrl()" style="padding: 8px 16px; font-size: 13px; background: #6c757d;">URL</button>
                    </div>
                </div>
                <input type="hidden" id="contactAvatarData">

                <!-- 姓名 -->
                <div class="form-group">
                    <label class="form-label">姓名</label>
                    <input type="text" class="form-input" id="contactNameInput" placeholder="输入姓名（可选）" maxlength="30">
                </div>

                <!-- 电话 -->
                <div class="form-group">
                    <label class="form-label">电话号码 <span style="color: #ff3b30;">*</span></label>
                    <input type="tel" class="form-input" id="contactPhoneInput" placeholder="输入电话号码" maxlength="20">
                </div>

                <!-- 备注 -->
                <div class="form-group">
                    <label class="form-label">备注</label>
                    <textarea class="form-input" id="contactNoteInput" placeholder="输入备注（可选）" rows="3" maxlength="100" style="resize: vertical;"></textarea>
                </div>

                <!-- 保存按钮 -->
                <div style="margin-top: 30px;">
                    <button class="btn-primary btn-save" onclick="saveContactFromEditor()" style="width: 100%;">
                        保存联系人
                    </button>
                </div>

                <!-- 保存并发送消息按钮 -->
                <div style="margin-top: 12px;">
                    <button class="btn-primary" onclick="saveAndMessageContact()" style="width: 100%; background: #34c759;">
                        保存并发送消息
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 音频播放器（隐藏） -->
    <audio id="audioPlayer" style="display: none;"></audio>

    <script src="prompts.js"></script>
    <script src="script3.js"></script>
    <script src="video-call.js"></script>
    <script src="script.js"></script>
    <script src="data-management.js"></script>
    <script src="appearance.js"></script>
    <script src="music-search.js"></script>
    <script src="persona.js"></script>
    <script src="worldbook.js"></script>
    <script src="showcase.js"></script>
    <script src="script2.js"></script>
    <script src="couple-avatar.js"></script>
    
    <!-- PWA Service Worker 注册和安装提示 -->
    <script>
        // 注册 Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('Service Worker 注册成功:', registration);
                        
                        // 检查更新
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // 有新版本可用
                                    console.log('新版本可用');
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('Service Worker 注册失败:', error);
                    });
            });
        }

        // PWA 安装提示 - iOS风格弹窗
        let deferredPrompt;
        let hasShownInstallPrompt = localStorage.getItem('pwa-install-prompt-shown');

        window.addEventListener('beforeinstallprompt', (e) => {
            // 阻止默认的安装提示
            e.preventDefault();
            deferredPrompt = e;
            
            // 如果之前没有显示过提示，则显示
            if (!hasShownInstallPrompt) {
                showIOSInstallPrompt();
            }
        });

        // 显示iOS风格的安装提示弹窗
        function showIOSInstallPrompt() {
            // 检查是否已经是PWA模式
            if (window.matchMedia('(display-mode: standalone)').matches || 
                window.navigator.standalone === true) {
                return;
            }

            // 延迟3秒显示，让用户先看到界面
            setTimeout(() => {
                const overlay = document.createElement('div');
                overlay.className = 'ios-dialog-overlay';
                
                const dialog = document.createElement('div');
                dialog.className = 'ios-dialog';
                
                const titleEl = document.createElement('div');
                titleEl.className = 'ios-dialog-title';
                titleEl.textContent = '安装应用';
                
                const messageEl = document.createElement('div');
                messageEl.className = 'ios-dialog-message';
                messageEl.textContent = '为了获得最佳体验，建议您将此应用添加到主屏幕。\n\n安装后可以像原生应用一样使用，并支持离线访问。';
                
                const buttonsEl = document.createElement('div');
                buttonsEl.className = 'ios-dialog-buttons';
                
                const laterBtn = document.createElement('button');
                laterBtn.className = 'ios-dialog-button';
                laterBtn.textContent = '稍后再说';
                laterBtn.onclick = () => {
                    closeDialog();
                    localStorage.setItem('pwa-install-prompt-shown', 'true');
                };
                
                const installBtn = document.createElement('button');
                installBtn.className = 'ios-dialog-button primary';
                installBtn.textContent = '立即安装';
                installBtn.onclick = () => {
                    closeDialog();
                    localStorage.setItem('pwa-install-prompt-shown', 'true');
                    
                    if (deferredPrompt) {
                        // Chrome/Edge 等浏览器
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then((choiceResult) => {
                            if (choiceResult.outcome === 'accepted') {
                                console.log('用户接受了安装提示');
                            }
                            deferredPrompt = null;
                        });
                    } else {
                        // iOS Safari 需要手动添加
                        showIOSInstallInstructions();
                    }
                };
                
                buttonsEl.appendChild(laterBtn);
                buttonsEl.appendChild(installBtn);
                dialog.appendChild(titleEl);
                dialog.appendChild(messageEl);
                dialog.appendChild(buttonsEl);
                overlay.appendChild(dialog);
                document.body.appendChild(overlay);
                
                // 显示动画
                setTimeout(() => {
                    overlay.classList.add('show');
                }, 10);
                
                function closeDialog() {
                    overlay.classList.remove('show');
                    setTimeout(() => {
                        document.body.removeChild(overlay);
                    }, 300);
                }
            }, 3000);
        }

        // iOS Safari 安装说明
        function showIOSInstallInstructions() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            
            if (isIOS && isSafari) {
                const overlay = document.createElement('div');
                overlay.className = 'ios-dialog-overlay';
                
                const dialog = document.createElement('div');
                dialog.className = 'ios-dialog';
                
                const titleEl = document.createElement('div');
                titleEl.className = 'ios-dialog-title';
                titleEl.textContent = '如何安装';
                
                const messageEl = document.createElement('div');
                messageEl.className = 'ios-dialog-message';
                messageEl.textContent = '请点击底部的分享按钮 ⬆️\n然后选择"添加到主屏幕"';
                
                const buttonsEl = document.createElement('div');
                buttonsEl.className = 'ios-dialog-buttons';
                
                const okBtn = document.createElement('button');
                okBtn.className = 'ios-dialog-button primary';
                okBtn.textContent = '我知道了';
                okBtn.onclick = () => {
                    overlay.classList.remove('show');
                    setTimeout(() => {
                        document.body.removeChild(overlay);
                    }, 300);
                };
                
                buttonsEl.appendChild(okBtn);
                dialog.appendChild(titleEl);
                dialog.appendChild(messageEl);
                dialog.appendChild(buttonsEl);
                overlay.appendChild(dialog);
                document.body.appendChild(overlay);
                
                // 显示动画
                setTimeout(() => {
                    overlay.classList.add('show');
                }, 10);
            }
        }

        // 页面加载时检查是否应该显示安装提示
        window.addEventListener('load', () => {
            // 如果没有beforeinstallprompt事件（如iOS），也显示安装提示
            setTimeout(() => {
                if (!deferredPrompt && !hasShownInstallPrompt) {
                    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                                       window.navigator.standalone === true;
                    if (!isStandalone) {
                        showIOSInstallPrompt();
                    }
                }
            }, 3000);
            
            // 定期检查 Service Worker 更新（每10分钟）
            setInterval(() => {
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        type: 'CHECK_UPDATE'
                    });
                }
            }, 10 * 60 * 1000); // 10分钟
            
            // 页面可见时立即检查更新
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.getRegistration().then(registration => {
                        if (registration) {
                            registration.update();
                        }
                    });
                }
            });
        });

        // 监听安装成功事件
        window.addEventListener('appinstalled', () => {
            console.log('PWA 安装成功');
            deferredPrompt = null;
        });
    </script>

    <!-- 主动消息开发者调试面板 -->
    <div id="proactiveDebugOverlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:99999; justify-content:center; align-items:center;">
        <div id="proactiveDebugPanel" style="background:#fff; border-radius:16px; width:92%; max-width:420px; max-height:80vh; overflow-y:auto; padding:20px; position:relative;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <div style="font-size:17px; font-weight:600; color:#333;">🛠 主动消息调试</div>
                <button onclick="closeProactiveDebugPanel()" style="background:none; border:none; font-size:22px; color:#999; cursor:pointer; padding:4px;">✕</button>
            </div>
            <div id="proactiveDebugContent" style="font-size:13px; color:#333; line-height:1.8;"></div>
            <div style="margin-top:16px;">
                <button onclick="refreshProactiveDebug()" style="width:100%; background:#007bff; color:#fff; border:none; border-radius:10px; padding:10px 0; font-size:14px; cursor:pointer;">刷新数据</button>
            </div>
        </div>
    </div>
</body>
</html>
